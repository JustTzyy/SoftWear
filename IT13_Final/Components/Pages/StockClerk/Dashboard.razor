@page "/stockclerk/dashboard"
@layout IT13_Final.Components.Layout.StockClerk.StockClerk
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Data.IUserService UserService
@inject IT13_Final.Services.Data.IProductService ProductService
@inject IT13_Final.Services.Data.IVariantService VariantService
@inject IT13_Final.Services.Data.ICategoryService CategoryService
@inject IT13_Final.Services.Data.ISupplierService SupplierService
@inject NavigationManager Nav
@using Microsoft.Data.SqlClient

<h1 class="page-title">Dashboard Reports</h1>

@if (showSecurityAlert)
{
    <div class="security-alert-overlay" @onclick="HandleLater">
        <div class="security-alert-modal" @onclick:stopPropagation>
            <div class="security-alert-header">
                <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="M9 12l2 2 4-4"></path>
                </svg>
                <span>Security Alert</span>
                <button class="alert-close" @onclick="HandleLater">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="security-alert-body">
                <svg class="warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <p class="alert-message">You are currently using a default password. For security reasons, please change your password immediately.</p>
            </div>

            <div class="security-alert-footer">
                <button class="alert-btn later-btn" @onclick="HandleLater">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <span>Later</span>
                </button>
                <button class="alert-btn change-password-btn" @onclick="HandleChangePassword">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>  
                    </svg>
                    <span>Change Password</span>
                </button>
            </div>
        </div>
    </div>
}

<div class="search-row">
    <input class="search" placeholder="Search dashboard data" />
    <button class="print">Print Report</button>
    <div class="fill"></div>
</div>

<section class="card">
    <h2 class="card-title">Inventory Management KPIs</h2>
    <div class="subtext">Overview of inventory and stock management metrics</div>

    <div class="grid-4">
        <div class="metric">
            <div class="label">TOTAL PRODUCTS</div>
            <div class="value">@totalProducts</div>
        </div>
        <div class="metric">
            <div class="label">TOTAL VARIANTS</div>
            <div class="value">@totalVariants</div>
        </div>
        <div class="metric">
            <div class="label">CATEGORIES</div>
            <div class="value">@totalCategories</div>
        </div>
        <div class="metric">
            <div class="label">SUPPLIERS</div>
            <div class="value">@totalSuppliers</div>
        </div>
    </div>
</section>

<section class="card">
    <h2 class="card-title">Inventory Overview</h2>
    <div class="subtext">Summary of inventory and stock management</div>
    <div class="grid-4">
        <div class="metric sm">
            <div class="label">ACTIVE PRODUCTS</div>
            <div class="value">@activeProducts</div>
        </div>
        <div class="metric sm">
            <div class="label">ACTIVE VARIANTS</div>
            <div class="value">@activeVariants</div>
        </div>
        <div class="metric sm">
            <div class="label">ARCHIVED PRODUCTS</div>
            <div class="value">@archivedProducts</div>
        </div>
        <div class="metric sm">
            <div class="label">ARCHIVED VARIANTS</div>
            <div class="value">@archivedVariants</div>
        </div>
    </div>
</section>

<section class="card">
    <h2 class="card-title">Products by Category</h2>
    <div class="subtext">Distribution of products across different categories</div>
    <div class="chart-container">
        <svg class="bar-chart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
            @if (categoryData != null && categoryData.Any())
            {
                var maxValue = categoryData.Max(c => c.Count);
                var barWidth = 700.0 / categoryData.Count;
                var chartHeight = 250.0;
                var spacing = 10.0;
                var xPos = 50.0;
                
                @foreach (var item in categoryData)
                {
                    var barHeight = maxValue > 0 ? (item.Count / (double)maxValue) * chartHeight : 0;
                    var yPos = chartHeight - barHeight + 25;
                    
                    <g>
                        <rect x="@xPos" y="@yPos" width="@(barWidth - spacing)" height="@barHeight" 
                              fill="#A2B9CD" rx="4" class="chart-bar"/>
                        @{
                            var textX1 = xPos + (barWidth - spacing) / 2;
                            var textY1 = yPos - 5;
                            var textX2 = xPos + (barWidth - spacing) / 2;
                            var textY2 = chartHeight + 45;
                        }
                        @CreateSvgText(textX1.ToString("F1"), textY1.ToString("F1"), "middle", "12", "600", "#304D6D", item.Count.ToString())
                        @CreateSvgTextWithTransform(textX2.ToString("F1"), textY2.ToString("F1"), "middle", "11", "#6b6b6b", $"rotate(-45 {textX2:F1} {textY2:F1})", item.Name)
                    </g>
                    xPos += barWidth;
                }
                
                <!-- Y-axis labels -->
                @for (int i = 0; i <= 5; i++)
                {
                    var value = (int)(maxValue * i / 5.0);
                    var y = chartHeight - (chartHeight * i / 5.0) + 25;
                    var textY = y + 4;
                    <line x1="45" y1="@y" x2="50" y2="@y" stroke="#E0E0E0" stroke-width="1"/>
                    @CreateSvgText("40", textY.ToString("F1"), "end", "10", "", "#6b6b6b", value.ToString())
                }
                
                <!-- Axes -->
                <line x1="50" y1="25" x2="50" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
                <line x1="50" y1="@(chartHeight + 25)" x2="750" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
            }
            else
            {
                var noDataMsg = "No category data available";
                @CreateSvgText("400", "150", "middle", "14", "", "#6b6b6b", noDataMsg)
            }
        </svg>
    </div>
</section>

<section class="card">
    <h2 class="card-title">Recent Product Activity</h2>
    <div class="subtext">Products created over the last 30 days</div>
    <div class="chart-container">
        <svg class="line-chart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
            @if (recentProductsData != null && recentProductsData.Any())
            {
                var maxValue = recentProductsData.Max(p => p.Count);
                var chartWidth = 700.0;
                var chartHeight = 250.0;
                var pointCount = recentProductsData.Count;
                var xStep = chartWidth / (pointCount > 1 ? pointCount - 1 : 1);
                var points = new List<string>();
                
                @for (int i = 0; i < recentProductsData.Count; i++)
                {
                    var x = 50 + (i * xStep);
                    var y = chartHeight + 25 - (maxValue > 0 ? (recentProductsData[i].Count / (double)maxValue) * chartHeight : 0);
                    points.Add($"{x},{y}");
                }
                
                @if (points.Count > 1)
                {
                    <polyline points="@string.Join(" ", points)" fill="none" stroke="#A2B9CD" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                }
                
                @for (int i = 0; i < recentProductsData.Count; i++)
                {
                    var x = 50 + (i * xStep);
                    var y = chartHeight + 25 - (maxValue > 0 ? (recentProductsData[i].Count / (double)maxValue) * chartHeight : 0);
                    var textY1 = y - 10;
                    var textY2 = chartHeight + 45;
                    var count = recentProductsData[i].Count;
                    var date = recentProductsData[i].Date;
                    <circle cx="@x" cy="@y" r="5" fill="#304D6D"/>
                    @CreateSvgText(x.ToString("F1"), textY1.ToString("F1"), "middle", "11", "600", "#304D6D", count.ToString())
                    @CreateSvgText(x.ToString("F1"), textY2.ToString("F1"), "middle", "10", "", "#6b6b6b", date)
                }
                
                <!-- Y-axis labels -->
                @for (int i = 0; i <= 5; i++)
                {
                    var value = (int)(maxValue * i / 5.0);
                    var y = chartHeight - (chartHeight * i / 5.0) + 25;
                    var textY = y + 4;
                    <line x1="45" y1="@y" x2="50" y2="@y" stroke="#E0E0E0" stroke-width="1"/>
                    @CreateSvgText("40", textY.ToString("F1"), "end", "10", "", "#6b6b6b", value.ToString())
                }
                
                <!-- Axes -->
                <line x1="50" y1="25" x2="50" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
                <line x1="50" y1="@(chartHeight + 25)" x2="750" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
            }
            else
            {
                var noActivityMsg = "No recent product activity";
                @CreateSvgText("400",    "150", "middle", "14", "", "#6b6b6b", noActivityMsg)
            }
        </svg>
    </div>
</section>

@code {
    private bool showSecurityAlert = false;
    private int sellerUserId = 0;
    private int totalProducts = 0;
    private int totalVariants = 0;
    private int totalCategories = 0;
    private int totalSuppliers = 0;
    private int activeProducts = 0;
    private int activeVariants = 0;
    private int archivedProducts = 0;
    private int archivedVariants = 0;
    private List<CategoryChartData> categoryData = new();
    private List<RecentProductData> recentProductsData = new();

    private class CategoryChartData
    {
        public string Name { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    private class RecentProductData
    {
        public string Date { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckPasswordChangeRequired();
        await LoadSellerUserId();
        if (sellerUserId > 0)
        {
            await LoadDashboardData();
        }
    }

    private async Task LoadSellerUserId()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
                using var conn = new SqlConnection(connectionString);
                await conn.OpenAsync();

                var sql = "SELECT user_id FROM dbo.tbl_users WHERE id = @UserId AND archived_at IS NULL";
                using var cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@UserId", AuthState.CurrentUser.Id);

                var result = await cmd.ExecuteScalarAsync();
                if (result != null && result != DBNull.Value)
                {
                    sellerUserId = Convert.ToInt32(result);
                }
            }
            catch
            {
                sellerUserId = 0;
            }
        }
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Load counts
            totalProducts = await ProductService.GetProductsCountAsync(sellerUserId);
            totalVariants = await VariantService.GetVariantsCountAsync(sellerUserId);
            totalCategories = await CategoryService.GetCategoriesCountAsync(sellerUserId);
            totalSuppliers = await SupplierService.GetSuppliersCountAsync(sellerUserId);
            activeProducts = totalProducts;
            activeVariants = totalVariants;
            archivedProducts = await ProductService.GetArchivedProductsCountAsync(sellerUserId);
            archivedVariants = await VariantService.GetArchivedVariantsCountAsync(sellerUserId);

            // Load category distribution
            await LoadCategoryData();

            // Load recent products
            await LoadRecentProductsData();

            StateHasChanged();
        }
        catch
        {
            // Handle errors silently
        }
    }

    private async Task LoadCategoryData()
    {
        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new SqlConnection(connectionString);
            await conn.OpenAsync();

            var sql = @"
                SELECT c.name, COUNT(p.id) as product_count
                FROM dbo.tbl_categories c
                LEFT JOIN dbo.tbl_products p ON p.category_id = c.id AND p.archived_at IS NULL AND p.user_id = @UserId
                WHERE c.archived_at IS NULL AND c.user_id = @UserId
                GROUP BY c.id, c.name
                ORDER BY product_count DESC, c.name";

            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@UserId", sellerUserId);

            using var reader = await cmd.ExecuteReaderAsync();
            categoryData.Clear();
            while (await reader.ReadAsync())
            {
                categoryData.Add(new CategoryChartData
                {
                    Name = reader.GetString(0),
                    Count = reader.GetInt32(1)
                });
            }
        }
        catch
        {
            categoryData.Clear();
        }
    }

    private async Task LoadRecentProductsData()
    {
        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new SqlConnection(connectionString);
            await conn.OpenAsync();

            var sql = @"
                SELECT CAST(created_at AS DATE) as date, COUNT(*) as count
                FROM dbo.tbl_products
                WHERE user_id = @UserId 
                  AND archived_at IS NULL 
                  AND created_at >= DATEADD(DAY, -30, GETDATE())
                GROUP BY CAST(created_at AS DATE)
                ORDER BY date";

            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@UserId", sellerUserId);

            using var reader = await cmd.ExecuteReaderAsync();
            recentProductsData.Clear();
            while (await reader.ReadAsync())
            {
                var date = reader.GetDateTime(0);
                recentProductsData.Add(new RecentProductData
                {
                    Date = date.ToString("MM/dd"),
                    Count = reader.GetInt32(1)
                });
            }
        }
        catch
        {
            recentProductsData.Clear();
        }
    }

    private async Task CheckPasswordChangeRequired()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                showSecurityAlert = await UserService.MustChangePasswordAsync(AuthState.CurrentUser.Id);
                StateHasChanged();
            }
            catch
            {
                showSecurityAlert = false;
            }
        }
    }

    private void HandleLater()
    {
        showSecurityAlert = false;
        StateHasChanged();
    }

    private void HandleChangePassword()
    {
        showSecurityAlert = false;
        Nav.NavigateTo("/stockclerk/settings?tab=password");
        StateHasChanged();
    }

    private MarkupString CreateSvgText(string x, string y, string anchor, string fontSize, string fontWeight, string fill, string content)
    {
        var fontWeightAttr = string.IsNullOrEmpty(fontWeight) ? "" : $" font-weight=\"{fontWeight}\"";
        return new MarkupString($"<text x=\"{x}\" y=\"{y}\" text-anchor=\"{anchor}\" font-size=\"{fontSize}\"{fontWeightAttr} fill=\"{fill}\">{content}</text>");
    }

    private MarkupString CreateSvgTextWithTransform(string x, string y, string anchor, string fontSize, string fill, string transform, string content)
    {
        return new MarkupString($"<text x=\"{x}\" y=\"{y}\" text-anchor=\"{anchor}\" font-size=\"{fontSize}\" fill=\"{fill}\" transform=\"{transform}\">{content}</text>");
    }
}









