@page "/stockclerk/Purchase_Orders"
@layout IT13_Final.Components.Layout.StockClerk.StockClerk
@inject IT13_Final.Services.Data.IPurchaseOrderService PurchaseOrderService
@inject IT13_Final.Services.Data.ISupplierService SupplierService
@inject IT13_Final.Services.Data.IVariantService VariantService
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@using Microsoft.Data.SqlClient
@using System.ComponentModel.DataAnnotations
@implements IDisposable

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">Purchase Orders</h1>
        <p class="welcome-date">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>
    <div class="header-actions">
        <button class="action-btn print-btn" @onclick="PrintReport" disabled="@isGeneratingPDF" title="Print records">
            @if (isGeneratingPDF)
            {
                <span>Generating...</span>
            }
            else
            {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9V2h12v7"></path>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
            }
        </button>
    </div>
</div>

@* Search and Filters *@
<div class="dashboard-filters">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
        </svg>
        <input type="text" 
               id="po-inventory-search-input"
               class="search-input" 
               placeholder="Search by PO number or supplier..." 
               value="@searchTerm" 
               @oninput="HandleSearchInput" 
               @onkeypress="HandleSearchKeyPress" />
        @if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            <button class="clear-search-btn" @onclick="HandleClearSearch" title="Clear search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        }
    </div>
    <div class="date-filters">
        <select class="date-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
            <option value="thisyear">This Year</option>
        </select>
        <input type="date"
               class="date-input"
               value="@(startDate?.ToString("yyyy-MM-dd"))"
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleStartDateChange" />
        <span class="date-separator">to</span>
        <input type="date"
               class="date-input"
               value="@(endDate?.ToString("yyyy-MM-dd"))"
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleEndDateChange" />
        <select class="date-select" @bind="selectedStatus" @bind:after="HandleStatusChange">
            <option value="">All Status</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
        </select>
        <button class="filter-btn" @onclick="ApplyFilters">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Apply
        </button>
        @if (HasActiveDateFilters)
        {
            <button class="clear-btn" @onclick="ClearDateFilter" title="Clear filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        }
    </div>
</div>

@* Purchase Order List Card *@
<div class="content-card">
    <div class="card-header">
        <div class="card-title-section">
            <h3 class="card-title">Purchase Order List</h3>
            <span class="card-subtitle">@totalCount total orders</span>
        </div>
        <div class="card-actions">
            <button class="card-action-btn primary" @onclick="HandleCreatePO" title="Create Purchase Order">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                <span>Create PO</span>
            </button>
        </div>
    </div>
    
    <div class="card-body">
        <table class="admin-table">
            <thead>
                <tr>
                    <th style="text-align: left;">PO Number</th>
                    <th style="text-align: left;">Supplier</th>
                    <th style="text-align: left;">Status</th>
                    <th style="text-align: right;">Total Amount</th>
                    <th style="text-align: left;">Expected Delivery</th>
                    <th style="text-align: left;">Created At</th>
                    <th style="text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="7" class="loading-cell">Loading purchase orders...</td>
                    </tr>
                }
                else if (purchaseOrders.Count == 0)
                {
                    <tr>
                        <td colspan="7" class="empty-cell">No purchase orders found for this filter.</td>
                    </tr>
                }
                else
                {
                    @foreach (var po in purchaseOrders)
                    {
                        <tr class="clickable-row" @onclick="() => HandleRowClick(po.Id)">
                            <td class="sale-number" style="text-align: left;">@po.PONumber</td>
                            <td style="text-align: left;">@po.SupplierName</td>
                            <td style="text-align: left;">
                                <span class="status-text @(po.Status == "Completed" ? "status-text-approved" : po.Status == "Cancelled" ? "status-text-cancelled" : po.Status == "Approved" ? "status-text-approved" : "status-text-pending")">@po.Status</span>
                            </td>
                            <td style="text-align: right;">₱@po.TotalAmount.ToString("N2")</td>
                            <td>
                                @if (po.ExpectedDeliveryDate.HasValue)
                                {
                                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                        <span>@po.ExpectedDeliveryDate.Value.ToString("MMM dd, yyyy")</span>
                                        @if (IsOverdue(po.ExpectedDeliveryDate.Value, po.Status))
                                        {
                                            <span class="overdue-badge" title="Overdue - Expected delivery date has passed">⚠️ Overdue</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span>N/A</span>
                                }
                            </td>
                            <td>
                                <div class="timestamp-info">
                                    <div class="timestamp-date">@po.CreatedAt.ToString("MMM dd, yyyy")</div>
                                    <div class="timestamp-time">@po.CreatedAt.ToString("HH:mm:ss")</div>
                                </div>
                            </td>
                            <td class="actions-cell" @onclick:stopPropagation="true">
                                @if (po.Status == "Pending")
                                {
                                    @* Only Seller can approve *@
                                    @if (IsSeller())
                                    {
                                        <button class="action-btn approve-btn" @onclick='() => HandleStatusChange(po.Id, "Approved")' title="Approve">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </button>
                                    }
                                    @* Only Stock Clerk can cancel *@
                                    @if (IsStockClerk())
                                    {
                                        <button class="action-btn cancel-btn" @onclick='() => HandleStatusChange(po.Id, "Cancelled")' title="Cancel">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M18 6 6 18"></path>
                                                <path d="m6 6 12 12"></path>
                                            </svg>
                                        </button>
                                    }
                                }
                                @if (po.Status == "Approved")
                                {
                                    <button class="action-btn complete-btn" @onclick='() => HandleStatusChange(po.Id, "Completed")' title="Mark as Completed">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (totalPages > 1)
    {
        <div class="pagination">
            <button class="page-btn" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)" title="Previous page">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6"></path>
                </svg>
            </button>

            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNum = i;
                @if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                {
                    <button class="page-btn @(i == currentPage ? "active" : "")" @onclick="() => GoToPage(pageNum)">
                        @i
                    </button>
                }
                else if (i == currentPage - 2 || i == currentPage + 2)
                {
                    <span class="page-ellipsis">...</span>
                }
            }

            <button class="page-btn" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)" title="Next page">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m9 18 6-6-6-6"></path>
                </svg>
            </button>
        </div>
    }
</div>

@* Purchase Order Details Modal *@
@if (showPODetails && poDetails != null)
{
    <div class="modal-overlay" @onclick="ClosePODetails">
        <div class="add-admin-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h2 class="modal-title-text">Purchase Order Details - @poDetails.PONumber</h2>
                <button class="modal-close-btn" @onclick="ClosePODetails" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="po-info">
                    <div class="info-row">
                        <span class="info-label">PO Number:</span>
                        <span class="info-value">@poDetails.PONumber</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Supplier:</span>
                        <span class="info-value">@poDetails.SupplierName</span>
                    </div>
                    @if (!string.IsNullOrEmpty(poDetails.SupplierEmail))
                    {
                        <div class="info-row">
                            <span class="info-label">Supplier Email:</span>
                            <span class="info-value">@poDetails.SupplierEmail</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(poDetails.SupplierContactNumber))
                    {
                        <div class="info-row">
                            <span class="info-label">Supplier Contact:</span>
                            <span class="info-value">@poDetails.SupplierContactNumber</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-text @(poDetails.Status == "Completed" ? "status-text-approved" : poDetails.Status == "Cancelled" ? "status-text-cancelled" : poDetails.Status == "Approved" ? "status-text-approved" : "status-text-pending")">@poDetails.Status</span>
                        </span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Amount:</span>
                        <span class="info-value">₱@poDetails.TotalAmount.ToString("N2")</span>
                    </div>
                    @if (poDetails.ExpectedDeliveryDate.HasValue)
                    {
                        <div class="info-row">
                            <span class="info-label">Expected Delivery:</span>
                            <span class="info-value">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    <span>@poDetails.ExpectedDeliveryDate.Value.ToString("MMM dd, yyyy")</span>
                                    @if (IsOverdue(poDetails.ExpectedDeliveryDate.Value, poDetails.Status))
                                    {
                                        <span class="overdue-badge" title="Overdue - Expected delivery date has passed">⚠️ Overdue</span>
                                    }
                                    @if (poDetails.Status != "Completed" && poDetails.Status != "Cancelled")
                                    {
                                        <button class="update-date-btn" @onclick="() => ShowUpdateDateModal(poDetails.Id)" title="Update Expected Delivery Date">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                    }
                                </div>
                            </span>
                        </div>
                    }
                    else if (poDetails.Status != "Completed" && poDetails.Status != "Cancelled")
                    {
                        <div class="info-row">
                            <span class="info-label">Expected Delivery:</span>
                            <span class="info-value">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>N/A</span>
                                    <button class="update-date-btn" @onclick="() => ShowUpdateDateModal(poDetails.Id)" title="Set Expected Delivery Date">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(poDetails.Notes))
                    {
                        <div class="info-row">
                            <span class="info-label">Notes:</span>
                            <span class="info-value">@poDetails.Notes</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label">Created At:</span>
                        <span class="info-value">@poDetails.CreatedAt.ToString("MMM dd, yyyy HH:mm:ss")</span>
                    </div>
                    @if (poDetails.UpdatedAt.HasValue)
                    {
                        <div class="info-row">
                            <span class="info-label">Updated At:</span>
                            <span class="info-value">@poDetails.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm:ss")</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label">Created By:</span>
                        <span class="info-value">@poDetails.CreatedByName</span>
                    </div>
                    @if (!string.IsNullOrEmpty(poDetails.UpdatedByName))
                    {
                        <div class="info-row">
                            <span class="info-label">Updated By:</span>
                            <span class="info-value">@poDetails.UpdatedByName</span>
                        </div>
                    }
                    @if (poDetails.Items != null && poDetails.Items.Count > 0)
                    {
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                            <h4 style="margin-bottom: 16px; font-size: 16px; font-weight: 700; color: #1f2937;">Items</h4>
                            <table class="po-items-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Product</th>
                                        <th style="text-align: left;">Variant</th>
                                        <th style="text-align: left;">Size</th>
                                        <th style="text-align: left;">Color</th>
                                        <th style="text-align: right;">Quantity</th>
                                        <th style="text-align: right;">Unit Price</th>
                                        <th style="text-align: right;">Total</th>
                                        <th style="text-align: right;">Received</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in poDetails.Items)
                                    {
                                        <tr>
                                            <td style="text-align: left;">@item.ProductName</td>
                                            <td style="text-align: left;">@item.VariantName</td>
                                            <td style="text-align: left;">@(string.IsNullOrEmpty(item.SizeName) ? "N/A" : item.SizeName)</td>
                                            <td style="text-align: left;">
                                                @if (!string.IsNullOrEmpty(item.ColorName))
                                                {
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        @if (!string.IsNullOrEmpty(item.ColorHexValue))
                                                        {
                                                            <span style="display: inline-block; width: 16px; height: 16px; border-radius: 3px; border: 1px solid #ddd; background-color: @item.ColorHexValue;"></span>
                                                        }
                                                        <span>@item.ColorName</span>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span>N/A</span>
                                                }
                                            </td>
                                            <td style="text-align: right;">@item.Quantity</td>
                                            <td style="text-align: right;">₱@item.UnitPrice.ToString("N2")</td>
                                            <td style="text-align: right;">₱@item.TotalPrice.ToString("N2")</td>
                                            <td style="text-align: right;">@item.ReceivedQuantity</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" @onclick="ClosePODetails">Close</button>
            </div>
        </div>
    </div>
}

@* Update Expected Delivery Date Modal *@
@if (showUpdateDateModal && poDetails != null)
{
    <div class="modal-overlay" @onclick="CloseUpdateDateModal">
        <div class="add-admin-modal" @onclick:stopPropagation style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title-text">Update Expected Delivery Date</h2>
                <button class="modal-close-btn" @onclick="CloseUpdateDateModal" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <EditForm Model="@_updateDateModel" OnValidSubmit="UpdateExpectedDateAsync">
                    <DataAnnotationsValidator />
                    <div class="form-field">
                        <label class="field-label">New Expected Delivery Date <span class="required-asterisk">*</span></label>
                        <InputDate class="form-input" @bind-Value="_updateDateModel.ExpectedDeliveryDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        <ValidationMessage For="@(() => _updateDateModel.ExpectedDeliveryDate)" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-btn" @onclick="CloseUpdateDateModal">Cancel</button>
                        <button type="submit" class="save-admin-btn">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            <span>Update Date</span>
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Create Purchase Order Modal *@
@if (showCreatePOModal)
{
    <div class="modal-overlay" @onclick="CloseCreatePOModal">
        <div class="add-admin-modal" @onclick:stopPropagation style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title-text">Create Purchase Order</h2>
                <button class="modal-close-btn" @onclick="CloseCreatePOModal" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <EditForm EditContext="@_createPOEditContext" OnValidSubmit="SavePurchaseOrderAsync">
                    <DataAnnotationsValidator />
                    
                    <div class="form-grid">
                        <div class="form-field full-width">
                            <label class="field-label">Supplier <span class="required-asterisk">*</span></label>
                            <InputSelect class="form-input" @bind-Value="_createPOModel.SupplierId">
                                <option value="0">Select Supplier</option>
                                @foreach (var supplier in availableSuppliers)
                                {
                                    <option value="@supplier.Id">@supplier.CompanyName</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => _createPOModel.SupplierId)" />
                        </div>
                        <div class="form-field">
                            <label class="field-label">Expected Delivery Date</label>
                            <InputDate class="form-input" @bind-Value="_createPOModel.ExpectedDeliveryDate" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            <ValidationMessage For="@(() => _createPOModel.ExpectedDeliveryDate)" />
                        </div>
                        <div class="form-field full-width">
                            <label class="field-label">Notes</label>
                            <InputTextArea class="form-textarea" @bind-Value="_createPOModel.Notes" placeholder="Optional notes for this purchase order" rows="3" />
                        </div>
                    </div>

                    <div class="po-items-section" style="margin-top: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 class="po-items-title" style="margin: 0;">Items</h3>
                            <button type="button" class="add-item-btn" @onclick="AddPOItem">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="16"></line>
                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                </svg>
                                <span>Add Item</span>
                            </button>
                        </div>

                        @if (_createPOModel.Items.Count == 0)
                        {
                            <p style="text-align: center; color: #6B7280; padding: 20px;">No items added. Click "Add Item" to add items to this purchase order.</p>
                        }
                        else
                        {
                            <div class="po-items-list">
                                @for (int i = 0; i < _createPOModel.Items.Count; i++)
                                {
                                    var item = _createPOModel.Items[i];
                                    var itemIndex = i;
                                    <div class="po-item-card">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #1a1a1a;">Item @(itemIndex + 1)</h4>
                                            @if (_createPOModel.Items.Count > 1)
                                            {
                                                <button type="button" class="remove-item-btn" @onclick="() => RemovePOItem(itemIndex)">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="15" y1="9" x2="9" y2="15"></line>
                                                        <line x1="9" y1="9" x2="15" y2="15"></line>
                                                    </svg>
                                                </button>
                                            }
                                        </div>
                                        <div class="form-grid">
                                            <div class="form-field full-width">
                                                <label class="field-label">Variant <span class="required-asterisk">*</span></label>
                                                <InputSelect class="form-input" @bind-Value="item.VariantId" @bind-Value:after="() => OnItemVariantSelected(itemIndex)">
                                                    <option value="0">Select Variant</option>
                                                    @foreach (var variant in availableVariants)
                                                    {
                                                        <option value="@variant.Id">@GetVariantDisplayName(variant)</option>
                                                    }
                                                </InputSelect>
                                            </div>
                                            <div class="form-field">
                                                <label class="field-label">Size <span class="required-asterisk">*</span></label>
                                                <InputSelect class="form-input" @bind-Value="item.SizeId" disabled="@(itemVariantDetails.ContainsKey(itemIndex) == false || itemVariantDetails[itemIndex] == null || itemVariantDetails[itemIndex]?.SizeIds.Count == 0)">
                                                    <option value="0">Select Size</option>
                                                    @if (itemVariantDetails.ContainsKey(itemIndex) && itemVariantDetails[itemIndex] != null && itemVariantDetails[itemIndex]?.SizeIds.Count > 0)
                                                    {
                                                        @for (int j = 0; j < itemVariantDetails[itemIndex].SizeIds.Count; j++)
                                                        {
                                                            <option value="@itemVariantDetails[itemIndex].SizeIds[j]">@itemVariantDetails[itemIndex].SizeNames[j]</option>
                                                        }
                                                    }
                                                </InputSelect>
                                            </div>
                                            <div class="form-field">
                                                <label class="field-label">Color <span class="required-asterisk">*</span></label>
                                                <InputSelect class="form-input" @bind-Value="item.ColorId" disabled="@(itemVariantDetails.ContainsKey(itemIndex) == false || itemVariantDetails[itemIndex] == null || itemVariantDetails[itemIndex]?.ColorIds.Count == 0)">
                                                    <option value="0">Select Color</option>
                                                    @if (itemVariantDetails.ContainsKey(itemIndex) && itemVariantDetails[itemIndex] != null && itemVariantDetails[itemIndex]?.ColorIds.Count > 0)
                                                    {
                                                        @for (int j = 0; j < itemVariantDetails[itemIndex].ColorIds.Count; j++)
                                                        {
                                                            <option value="@itemVariantDetails[itemIndex].ColorIds[j]">@itemVariantDetails[itemIndex].ColorNames[j]</option>
                                                        }
                                                    }
                                                </InputSelect>
                                            </div>
                                            <div class="form-field">
                                                <label class="field-label">Quantity <span class="required-asterisk">*</span></label>
                                                <InputNumber class="form-input" @bind-Value="item.Quantity" @bind-Value:after="() => CalculateTotalAmount()" />
                                            </div>
                                            <div class="form-field">
                                                <label class="field-label">Unit Price <span class="required-asterisk">*</span></label>
                                                <InputNumber class="form-input" @bind-Value="item.UnitPrice" @bind-Value:after="() => CalculateTotalAmount()" step="0.01" />
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 12px; text-align: right;">
                                <strong style="font-size: 18px; color: #1a1a1a; font-weight: 700;">Total Amount: ₱@CalculateTotalAmount().ToString("N2")</strong>
                            </div>
                        }
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="cancel-btn" @onclick="CloseCreatePOModal">Cancel</button>
                        <button type="submit" class="save-admin-btn" disabled="@(_createPOModel.Items.Count == 0 || _createPOModel.SupplierId == 0)">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            <span>Create Purchase Order</span>
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = false;
    private bool isGeneratingPDF = false;
    private string searchTerm = string.Empty;
    private DateTime? startDate;
    private DateTime? endDate;
    private string selectedDateRange = string.Empty;
    private string selectedStatus = string.Empty;
    
    private bool HasActiveDateFilters => !string.IsNullOrEmpty(selectedDateRange) || startDate.HasValue || endDate.HasValue || !string.IsNullOrEmpty(selectedStatus);

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);
    private List<IT13_Final.Services.Data.PurchaseOrderModel> purchaseOrders = new();
    private List<IT13_Final.Services.Data.PurchaseOrderModel> allPurchaseOrdersForPrint = new();
    private int sellerUserId = 0;

    private decimal totalAmount = 0m;
    private int pendingCount = 0;
    private int approvedCount = 0;
    private int completedCount = 0;
    private int cancelledCount = 0;

    private bool showPODetails = false;
    private IT13_Final.Services.Data.PurchaseOrderDetailsModel? poDetails = null;

    private bool showCreatePOModal = false;
    private CreatePOModel _createPOModel = new();
    private EditContext? _createPOEditContext;
    private List<IT13_Final.Services.Data.SupplierModel> availableSuppliers = new();
    private List<IT13_Final.Services.Data.VariantModel> availableVariants = new();
    private Dictionary<int, IT13_Final.Services.Data.VariantDetailsModel?> itemVariantDetails = new();

    private bool showUpdateDateModal = false;
    private UpdateDateModel _updateDateModel = new();
    private int? _updatingPOId = null;

    public class CreatePOModel
    {
        [Required(ErrorMessage = "Supplier is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a supplier")]
        public int SupplierId { get; set; }

        public string? Notes { get; set; }
        
        [CustomValidation(typeof(CreatePOModel), nameof(ValidateExpectedDeliveryDate))]
        public DateTime? ExpectedDeliveryDate { get; set; }
        
        public List<CreatePOItemModel> Items { get; set; } = new();
        
        public static ValidationResult? ValidateExpectedDeliveryDate(DateTime? expectedDeliveryDate, ValidationContext context)
        {
            if (expectedDeliveryDate.HasValue && expectedDeliveryDate.Value.Date < DateTime.Today)
            {
                return new ValidationResult("Expected delivery date cannot be in the past.");
            }
            return ValidationResult.Success;
        }
    }

    public class UpdateDateModel
    {
        [Required(ErrorMessage = "Expected delivery date is required")]
        [CustomValidation(typeof(UpdateDateModel), nameof(ValidateExpectedDeliveryDate))]
        public DateTime? ExpectedDeliveryDate { get; set; }

        public static ValidationResult? ValidateExpectedDeliveryDate(DateTime? expectedDeliveryDate, ValidationContext context)
        {
            if (!expectedDeliveryDate.HasValue)
            {
                return new ValidationResult("Expected delivery date is required.");
            }
            if (expectedDeliveryDate.Value.Date < DateTime.Today)
            {
                return new ValidationResult("Expected delivery date cannot be in the past.");
            }
            return ValidationResult.Success;
        }
    }

    public class CreatePOItemModel
    {
        public int VariantId { get; set; }
        public int? SizeId { get; set; }
        public int? ColorId { get; set; }
        public int Quantity { get; set; } = 1;
        public decimal UnitPrice { get; set; } = 0;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadSellerUserId();
        if (sellerUserId > 0)
        {
            await LoadPurchaseOrdersAsync();
            await LoadSuppliersAsync();
            await LoadVariantsAsync();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("setupSearchInputFilter", "po-inventory-search-input");
            }
            catch (Exception)
            {
                // JavaScript function might not be available yet, ignore
            }
        }
    }

    private async Task LoadSuppliersAsync()
    {
        try
        {
            if (sellerUserId > 0)
            {
                availableSuppliers = await SupplierService.GetSuppliersAsync(sellerUserId, null, null, null, 1, 1000);
            }
        }
        catch (Exception)
        {
            availableSuppliers = new List<IT13_Final.Services.Data.SupplierModel>();
        }
    }

    private async Task LoadVariantsAsync()
    {
        try
        {
            if (sellerUserId > 0)
            {
                availableVariants = await VariantService.GetVariantsAsync(sellerUserId, null, 1, 1000);
            }
        }
        catch (Exception)
        {
            availableVariants = new List<IT13_Final.Services.Data.VariantModel>();
        }
    }

    private async Task LoadSellerUserId()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
                using var conn = new SqlConnection(connectionString);
                await conn.OpenAsync();

                var sql = "SELECT user_id FROM dbo.tbl_users WHERE id = @UserId AND archived_at IS NULL";
                using var cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@UserId", AuthState.CurrentUser.Id);

                var result = await cmd.ExecuteScalarAsync();
                if (result != null && result != DBNull.Value)
                {
                    sellerUserId = Convert.ToInt32(result);
                }
            }
            catch
            {
                sellerUserId = 0;
            }
        }
    }

    private async Task LoadPurchaseOrdersAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            if (sellerUserId > 0)
            {
                // Use selectedStatus if provided, otherwise show all (excluding Completed and Cancelled by default in GetPurchaseOrdersAsync)
                string? statusFilter = string.IsNullOrWhiteSpace(selectedStatus) ? null : selectedStatus;
                
                await JSRuntime.InvokeVoidAsync("console.log", $"Loading POs with sellerUserId: {sellerUserId}, searchTerm: '{searchTerm}', status: '{statusFilter}', startDate: {startDate}, endDate: {endDate}");
                
                // Note: GetPurchaseOrdersAsync doesn't support date filtering, so we'll filter client-side for now
                // Or we could use GetCompletedPurchaseOrdersAsync/GetCancelledPurchaseOrdersAsync for those statuses
                totalCount = await PurchaseOrderService.GetPurchaseOrdersCountAsync(sellerUserId, searchTerm, statusFilter);
                purchaseOrders = await PurchaseOrderService.GetPurchaseOrdersAsync(sellerUserId, searchTerm, statusFilter, currentPage, pageSize);
                
                // Apply date filtering client-side if dates are provided
                if (startDate.HasValue || endDate.HasValue)
                {
                    purchaseOrders = purchaseOrders.Where(po => 
                        (!startDate.HasValue || po.CreatedAt.Date >= startDate.Value.Date) &&
                        (!endDate.HasValue || po.CreatedAt.Date <= endDate.Value.Date)
                    ).ToList();
                    totalCount = purchaseOrders.Count; // Update count after filtering
                }
                
                await JSRuntime.InvokeVoidAsync("console.log", $"Loaded {purchaseOrders.Count} POs out of {totalCount} total");

                // Calculate summary statistics
                totalAmount = purchaseOrders.Sum(po => po.TotalAmount);
                pendingCount = purchaseOrders.Count(po => po.Status == "Pending");
                approvedCount = purchaseOrders.Count(po => po.Status == "Approved");
                completedCount = purchaseOrders.Count(po => po.Status == "Completed");
                cancelledCount = purchaseOrders.Count(po => po.Status == "Cancelled");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.warn", "sellerUserId is 0, cannot load purchase orders");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading purchase orders: {ex.Message}");
            purchaseOrders = new List<IT13_Final.Services.Data.PurchaseOrderModel>();
            totalCount = 0;
            totalAmount = 0;
            pendingCount = 0;
            approvedCount = 0;
            completedCount = 0;
            cancelledCount = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private System.Threading.Timer? _searchTimer;
    private void HandleSearchInput(ChangeEventArgs e)
    {
        var filtered = System.Text.RegularExpressions.Regex.Replace(e.Value?.ToString() ?? "", @"[^a-zA-Z0-9\s\-_]", "");
        searchTerm = filtered;
        _searchTimer?.Dispose();
        _searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () => await LoadPurchaseOrdersAsync());
        }, null, 500, Timeout.Infinite);
    }

    private async Task HandleClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        await LoadPurchaseOrdersAsync();
        StateHasChanged();
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            _searchTimer?.Dispose();
            currentPage = 1;
            await LoadPurchaseOrdersAsync();
        }
    }

    private async void HandleStartDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            startDate = date;
            selectedDateRange = "";
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            startDate = null;
            selectedDateRange = "";
        }
        await ApplyFilters();
    }

    private async void HandleEndDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            endDate = date;
            selectedDateRange = "";
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            endDate = null;
            selectedDateRange = "";
        }
        await ApplyFilters();
    }

    private async Task HandleDateRangeChange()
    {
        var now = DateTime.Now;
        switch (selectedDateRange)
        {
            case "":
                startDate = null;
                endDate = null;
                break;
            case "today":
                startDate = now.Date;
                endDate = now.Date;
                break;
            case "yesterday":
                startDate = now.Date.AddDays(-1);
                endDate = now.Date.AddDays(-1);
                break;
            case "last7days":
                startDate = now.Date.AddDays(-6);
                endDate = now.Date;
                break;
            case "last30days":
                startDate = now.Date.AddDays(-29);
                endDate = now.Date;
                break;
            case "thismonth":
                startDate = new DateTime(now.Year, now.Month, 1);
                endDate = now.Date;
                break;
            case "thisyear":
                startDate = new DateTime(now.Year, 1, 1);
                endDate = now.Date;
                break;
        }
        await ApplyFilters();
    }

    private async Task HandleStatusChange()
    {
        await ApplyFilters();
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadPurchaseOrdersAsync();
    }

    private async Task ClearDateFilter()
    {
        selectedDateRange = "";
        startDate = null;
        endDate = null;
        selectedStatus = "";
        currentPage = 1;
        await LoadPurchaseOrdersAsync();
    }

    private async Task PrintReport()
    {
        try
        {
            isGeneratingPDF = true;
            StateHasChanged();

            if (sellerUserId > 0)
            {
                // Get all purchase orders for print (no pagination)
                string? statusFilter = string.IsNullOrWhiteSpace(selectedStatus) ? null : selectedStatus;
                allPurchaseOrdersForPrint = await PurchaseOrderService.GetPurchaseOrdersAsync(sellerUserId, searchTerm, statusFilter, 1, 10000);
                
                // Apply date filtering if dates are provided
                if (startDate.HasValue || endDate.HasValue)
                {
                    allPurchaseOrdersForPrint = allPurchaseOrdersForPrint.Where(po => 
                        (!startDate.HasValue || po.CreatedAt.Date >= startDate.Value.Date) &&
                        (!endDate.HasValue || po.CreatedAt.Date <= endDate.Value.Date)
                    ).ToList();
                }

                // Determine which PDF function to use based on status filter
                string pdfFunction = "generateAndPrintPOCompletedReport";
                if (statusFilter == "Cancelled")
                {
                    pdfFunction = "generateAndPrintPOCancelledReport";
                }
                else if (statusFilter == null || statusFilter == "")
                {
                    // For all statuses, use the completed report function (it handles all statuses)
                    pdfFunction = "generateAndPrintPOCompletedReport";
                }

                await JSRuntime.InvokeVoidAsync(pdfFunction,
                    allPurchaseOrdersForPrint.Select(po => new {
                        poNumber = po.PONumber,
                        supplierName = po.SupplierName,
                        status = po.Status,
                        totalAmount = po.TotalAmount,
                        expectedDeliveryDate = po.ExpectedDeliveryDate?.ToString("MMM dd, yyyy") ?? "N/A",
                        createdByName = po.CreatedByName,
                        createdAt = po.CreatedAt.ToString("MMM dd, yyyy"),
                        timeCreated = po.CreatedAt.ToString("HH:mm:ss")
                    }).ToArray(),
                    AuthState.CurrentUser?.FullName ?? "Stock Clerk",
                    startDate?.ToString("MMM dd, yyyy") ?? "All Time",
                    endDate?.ToString("MMM dd, yyyy") ?? "Today"
                );
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error generating report: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to generate PDF. Please try again.");
        }
        finally
        {
            isGeneratingPDF = false;
            StateHasChanged();
        }
    }


    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages && page != currentPage)
        {
            currentPage = page;
            await LoadPurchaseOrdersAsync();
        }
    }

    private async Task HandleRowClick(int poId)
    {
        try
        {
            if (sellerUserId > 0)
            {
                poDetails = await PurchaseOrderService.GetPurchaseOrderDetailsAsync(poId, sellerUserId);
                if (poDetails != null)
                {
                    showPODetails = true;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading PO details: {ex.Message}");
        }
    }

    private void ClosePODetails()
    {
        showPODetails = false;
        poDetails = null;
    }

    private async Task HandleCreatePO()
    {
        _createPOModel = new CreatePOModel();
        _createPOModel.Items.Add(new CreatePOItemModel());
        _createPOEditContext = new EditContext(_createPOModel);
        
        // Ensure suppliers and variants are loaded
        if (availableSuppliers.Count == 0)
        {
            await LoadSuppliersAsync();
        }
        if (availableVariants.Count == 0)
        {
            await LoadVariantsAsync();
        }
        
        showCreatePOModal = true;
        StateHasChanged();
    }

    private async Task HandleStatusChange(int poId, string newStatus)
    {
        if (sellerUserId > 0)
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to change the status to {newStatus}?");
            if (confirmed)
            {
                try
                {
                    await JSRuntime.InvokeVoidAsync("console.log", $"Attempting to update PO {poId} to status '{newStatus}' with sellerUserId: {sellerUserId}");
                    var result = await PurchaseOrderService.UpdatePurchaseOrderStatusAsync(poId, newStatus, sellerUserId);
                    if (result)
                    {
                        await JSRuntime.InvokeVoidAsync("console.log", $"Successfully updated PO {poId} to status '{newStatus}'");
                        await JSRuntime.InvokeVoidAsync("alert", $"Purchase order status updated to {newStatus}!");
                        await LoadPurchaseOrdersAsync();
                    }
                    else
                    {
                        await JSRuntime.InvokeVoidAsync("console.error", $"UpdatePurchaseOrderStatusAsync returned false for PO {poId}, status '{newStatus}', sellerUserId: {sellerUserId}");
                        await JSRuntime.InvokeVoidAsync("alert", "Failed to update purchase order status. Please check the browser console and Visual Studio Debug output for details.");
                    }
                }
                catch (Exception ex)
                {
                    await JSRuntime.InvokeVoidAsync("console.error", $"Exception in HandleStatusChange: {ex.Message}");
                    await JSRuntime.InvokeVoidAsync("console.error", $"Stack trace: {ex.StackTrace}");
                    if (ex.InnerException != null)
                    {
                        await JSRuntime.InvokeVoidAsync("console.error", $"Inner exception: {ex.InnerException.Message}");
                    }
                    await JSRuntime.InvokeVoidAsync("alert", $"Error updating purchase order status: {ex.Message}");
                }
            }
        }
    }


    private bool IsOverdue(DateTime expectedDate, string status)
    {
        // Only show overdue if status is not Completed or Cancelled
        if (status == "Completed" || status == "Cancelled")
            return false;
        
        return expectedDate.Date < DateTime.Today;
    }

    private void ShowUpdateDateModal(int poId)
    {
        _updatingPOId = poId;
        _updateDateModel = new UpdateDateModel
        {
            ExpectedDeliveryDate = poDetails?.ExpectedDeliveryDate
        };
        showUpdateDateModal = true;
    }

    private void CloseUpdateDateModal()
    {
        showUpdateDateModal = false;
        _updatingPOId = null;
        _updateDateModel = new UpdateDateModel();
    }

    private async Task UpdateExpectedDateAsync()
    {
        if (_updatingPOId.HasValue && sellerUserId > 0)
        {
            var result = await PurchaseOrderService.UpdatePurchaseOrderExpectedDateAsync(_updatingPOId.Value, _updateDateModel.ExpectedDeliveryDate, sellerUserId);
            if (result)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Expected delivery date updated successfully!");
                CloseUpdateDateModal();
                // Reload PO details if modal is open
                if (showPODetails && poDetails != null)
                {
                    poDetails = await PurchaseOrderService.GetPurchaseOrderDetailsAsync(_updatingPOId.Value, sellerUserId);
                }
                await LoadPurchaseOrdersAsync();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to update expected delivery date.");
            }
        }
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Pending" => "pending",
            "Approved" => "approved",
            "Cancelled" => "cancelled",
            "Completed" => "completed",
            _ => "inactive"
        };
    }

    private bool IsSeller()
    {
        return AuthState.CurrentUser?.Role?.ToLowerInvariant() == "seller";
    }

    private bool IsStockClerk()
    {
        return AuthState.CurrentUser?.Role?.ToLowerInvariant() == "stockclerk";
    }

    private void CloseCreatePOModal()
    {
        showCreatePOModal = false;
        _createPOModel = new CreatePOModel();
        _createPOEditContext = new EditContext(_createPOModel);
        itemVariantDetails.Clear();
    }

    private void AddPOItem()
    {
        _createPOModel.Items.Add(new CreatePOItemModel());
        StateHasChanged();
    }

    private void RemovePOItem(int index)
    {
        if (_createPOModel.Items.Count > 1)
        {
            _createPOModel.Items.RemoveAt(index);
            itemVariantDetails.Remove(index);
            // Reindex remaining items
            var keys = itemVariantDetails.Keys.Where(k => k > index).OrderBy(k => k).ToList();
            var newDict = new Dictionary<int, IT13_Final.Services.Data.VariantDetailsModel?>();
            foreach (var kvp in itemVariantDetails.Where(kvp => kvp.Key < index))
            {
                newDict[kvp.Key] = kvp.Value;
            }
            foreach (var key in keys)
            {
                newDict[key - 1] = itemVariantDetails[key];
            }
            itemVariantDetails = newDict;
            CalculateTotalAmount();
            StateHasChanged();
        }
    }

    private async Task OnItemVariantSelected(int itemIndex)
    {
        var item = _createPOModel.Items[itemIndex];
        if (item.VariantId > 0 && sellerUserId > 0)
        {
            try
            {
                itemVariantDetails[itemIndex] = await VariantService.GetVariantDetailsAsync(item.VariantId, sellerUserId);
                // Reset size and color when variant changes
                item.SizeId = null;
                item.ColorId = null;
                // Set default unit price to variant price
                if (itemVariantDetails[itemIndex] != null)
                {
                    item.UnitPrice = itemVariantDetails[itemIndex].Price;
                }
                CalculateTotalAmount();
            }
            catch (Exception ex)
            {
                itemVariantDetails[itemIndex] = null;
                await JSRuntime.InvokeVoidAsync("console.error", $"Error loading variant details: {ex.Message}");
            }
        }
        else
        {
            itemVariantDetails[itemIndex] = null;
            item.SizeId = null;
            item.ColorId = null;
        }
        await InvokeAsync(StateHasChanged);
    }

    private decimal CalculateTotalAmount()
    {
        return _createPOModel.Items.Sum(item => item.Quantity * item.UnitPrice);
    }

    private async Task SavePurchaseOrderAsync()
    {
        try
        {
            // Validate supplier is selected
            if (_createPOModel.SupplierId == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please select a supplier.");
                return;
            }

            if (sellerUserId <= 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Seller user ID not loaded. Please refresh the page.");
                return;
            }

            if (_createPOModel.Items.Count == 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please add at least one item to the purchase order.");
                return;
            }

            // Validate items
            var invalidItems = _createPOModel.Items.Where(item => 
                item.VariantId == 0 || 
                item.Quantity <= 0 || 
                item.UnitPrice <= 0 ||
                item.SizeId == null || item.SizeId == 0 ||
                item.ColorId == null || item.ColorId == 0).ToList();
            if (invalidItems.Count > 0)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please ensure all items have a variant, size, color, quantity > 0, and unit price > 0.");
                return;
            }

            if (AuthState.CurrentUser == null)
            {
                await JSRuntime.InvokeVoidAsync("alert", "User not authenticated.");
                return;
            }

            var createModel = new IT13_Final.Services.Data.CreatePOModel
            {
                SupplierId = _createPOModel.SupplierId,
                Notes = _createPOModel.Notes,
                ExpectedDeliveryDate = _createPOModel.ExpectedDeliveryDate,
                Items = _createPOModel.Items.Select(item => new IT13_Final.Services.Data.CreatePOItemModel
                {
                    VariantId = item.VariantId,
                    SizeId = item.SizeId == 0 || item.SizeId == null ? null : item.SizeId,
                    ColorId = item.ColorId == 0 || item.ColorId == null ? null : item.ColorId,
                    Quantity = item.Quantity,
                    UnitPrice = item.UnitPrice
                }).ToList()
            };

            await JSRuntime.InvokeVoidAsync("console.log", $"Creating PO with sellerUserId: {sellerUserId}, createdByUserId: {AuthState.CurrentUser.Id}, supplierId: {createModel.SupplierId}, items: {createModel.Items.Count}");

            var poId = await PurchaseOrderService.CreatePurchaseOrderAsync(sellerUserId, AuthState.CurrentUser.Id, createModel);
            if (poId.HasValue)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Purchase order created successfully!");
                CloseCreatePOModal();
                await LoadPurchaseOrdersAsync();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to create purchase order. The supplier may not belong to your account, or there was a database error. Please check the console for details.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error creating purchase order: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("console.error", $"Stack trace: {ex.StackTrace}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating purchase order: {ex.Message}\n\nCheck the browser console for more details.");
        }
    }

    private string GetVariantDisplayName(IT13_Final.Services.Data.VariantModel variant)
    {
        // Extract just the base variant name, removing size and color if they're appended
        // Pattern: "VariantName - Size - Color" -> "VariantName"
        // Also handles: "ProductName - VariantName - Size - Color" -> "VariantName"
        var name = variant.Name;
        
        if (string.IsNullOrWhiteSpace(name))
        {
            return name;
        }
        
        // Check if the name contains " - " which might indicate size/color are appended
        if (name.Contains(" - "))
        {
            // Split by " - " 
            var parts = name.Split(new[] { " - " }, StringSplitOptions.RemoveEmptyEntries);
            
            if (parts.Length > 0)
            {
                // If we have multiple parts, the first part(s) might be ProductName - VariantName
                // or just VariantName. We want to return just the variant name part.
                // Typically: "ProductName - VariantName - Size - Color"
                // Or: "VariantName - Size - Color"
                
                // If parts length is 2 or more, likely format is "VariantName - Size" or "VariantName - Size - Color"
                // If parts length is 3 or more, might be "ProductName - VariantName - Size" or "VariantName - Size - Color"
                // We'll take the first part that doesn't match common size/color patterns
                
                // For now, let's take the first part as the base variant name
                // This handles: "Classic Cotton T-Shirt - XXXL - Burgundy" -> "Classic Cotton T-Shirt"
                return parts[0].Trim();
            }
        }
        
        return name;
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}

