@page "/accounting/dashboard"
@layout IT13_Final.Components.Layout.Accounting.Accounting
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Data.IUserService UserService
@inject IT13_Final.Services.Data.IIncomeBreakdownService IncomeBreakdownService
@inject IT13_Final.Services.Data.IExpenseService ExpenseService
@inject IT13_Final.Services.Data.IDailySalesVerificationService DailySalesVerificationService
@inject IT13_Final.Services.Data.ISalesService SalesService
@inject IT13_Final.Services.Data.ICashflowAuditService CashflowAuditService
@inject IT13_Final.Services.Data.ISupplierInvoiceService SupplierInvoiceService
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@using System.Linq
@using Microsoft.Data.SqlClient
@implements IDisposable

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">@GetGreeting(), @(AuthState.CurrentUser?.FullName ?? "Accountant")!</h1>
        <p class="welcome-date">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>
    <div class="header-actions">
        <button class="action-btn visibility-btn @(hideConfidential ? "hidden-mode" : "")" @onclick="ToggleConfidentialVisibility" title="@(hideConfidential ? "Show Confidential Info" : "Hide Confidential Info")">
            @if (hideConfidential)
            {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            }
            else
            {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            }
        </button>
        <button class="action-btn print-btn" @onclick="PrintDashboard" title="Print Dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>
    </div>
</div>

@* Search and Date Filters *@
<div class="dashboard-filters">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="dashboard-search-input" class="search-input" placeholder="Search sellers, metrics..." @bind="searchTerm" @bind:event="oninput" @bind:after="HandleSearchInput" @onkeypress="HandleSearchKeyPress" />
        @if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            <button class="clear-search-btn" @onclick="HandleClearSearch" title="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
    <div class="date-filters">
        <select class="date-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange" @bind:event="onchange">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
            <option value="thisyear">This Year</option>
        </select>
        <input type="date" 
               class="date-input" 
               value="@(startDate?.ToString("yyyy-MM-dd"))" 
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleFromDateChange" />
        <span class="date-separator">to</span>
        <input type="date" 
               class="date-input" 
               value="@(endDate?.ToString("yyyy-MM-dd"))" 
               min="@(startDate?.ToString("yyyy-MM-dd") ?? DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd"))"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleToDateChange" />
        @if (HasActiveDateFilters)
        {
            <button class="clear-btn" @onclick="ClearAllFilters" title="Clear Filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
</div>

@if (showSecurityAlert)
{
    <div class="security-alert-overlay" @onclick="HandleLater">
        <div class="security-alert-modal" @onclick:stopPropagation>
            <div class="security-alert-header">
                <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="M9 12l2 2 4-4"></path>
                </svg>
                <span>Security Alert</span>
                <button class="alert-close" @onclick="HandleLater">Ã—</button>
            </div>
            <div class="security-alert-body">
                <p>You are currently using a default password. For security reasons, please change your password immediately.</p>
            </div>
            <div class="security-alert-footer">
                <button class="btn-secondary" @onclick="HandleLater">Later</button>
                <button class="btn-primary" @onclick="HandleChangePassword">Change Password</button>
            </div>
        </div>
    </div>
}

@if (isLoading)
{
    <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading dashboard...</p>
    </div>
}
else
{
    @* Key Financial KPIs *@
    @if (showKpiSection)
    {
    <div class="kpi-row">
        <div class="kpi-card kpi-revenue" @onclick='() => Nav.NavigateTo("/accounting/financial/income")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Gross Sales</span>
                <span class="kpi-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.GrossSales)</span>
                <span class="kpi-trend trend-up">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    <span>Total revenue</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-profit" @onclick='() => Nav.NavigateTo("/accounting/reports/profit-loss")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Net Profit</span>
                <span class="kpi-value @(stats.NetProfit >= 0 ? "positive" : "negative") @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.NetProfit)</span>
                <span class="kpi-trend @(stats.NetProfit >= 0 ? "trend-up" : "trend-down")">
                    @if (stats.NetProfit >= 0)
                    {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    }
                    else
                    {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    }
                    <span>After all expenses</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-expenses" @onclick='() => Nav.NavigateTo("/accounting/reports/expenses")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Expenses</span>
                <span class="kpi-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.TotalExpenses)</span>
                <span class="kpi-trend trend-down">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    <span>Operating costs</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-pending" @onclick='() => Nav.NavigateTo("/accounting/financial/daily-sales")'>
            <div class="kpi-icon @(stats.PendingApprovals > 0 ? "pulse" : "")">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Pending Approvals</span>
                <span class="kpi-value @(stats.PendingApprovals > 0 ? "warning" : "") @(hideConfidential ? "masked" : "")">@MaskValue(stats.PendingApprovals)</span>
                <span class="kpi-trend">
                    <span>Awaiting review</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-cashflow" @onclick='() => Nav.NavigateTo("/accounting/cashflow/audit")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Cash Flow</span>
                <span class="kpi-value @(stats.NetCashMovement >= 0 ? "positive" : "negative") @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.NetCashMovement)</span>
                <span class="kpi-trend @(stats.NetCashMovement >= 0 ? "trend-up" : "trend-down")">
                    @if (stats.NetCashMovement >= 0)
                    {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    }
                    else
                    {
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    }
                    <span>Net movement</span>
                </span>
            </div>
        </div>
    </div>
    }

    @* Main Charts Row *@
    @if (showSalesChart)
    {
    <div class="charts-grid">
        @* Sales Trend Chart *@
        <div class="chart-card chart-wide" @onclick='() => Nav.NavigateTo("/accounting/financial/income")'>
            <div class="chart-header">
                <h3>Daily Sales Trend</h3>
                <span class="chart-subtitle">Revenue over selected period</span>
            </div>
            <div class="chart-body">
                <svg class="line-chart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                    @if (salesData.Any() && salesData.Any(d => d.Amount > 0))
                    {
                        var maxAmount = salesData.Max(d => d.Amount);
                        var chartHeight = 220.0;
                        var chartWidth = 700.0;
                        var dataCount = salesData.Count;
                        var pointSpacing = chartWidth / Math.Max(dataCount - 1, 1);

                        @* Draw gradient fill under line *@
                        var fillPath = "M 60,240 ";
                        var linePath = "M ";
                        for (int i = 0; i < salesData.Count; i++)
                        {
                            var item = salesData[i];
                            var x = 60 + (i * pointSpacing);
                            var y = maxAmount > 0 ? 240 - ((double)item.Amount / (double)maxAmount) * chartHeight : 240;
                            
                            if (i == 0)
                            {
                                linePath += $"{x},{y} ";
                                fillPath += $"L {x},{y} ";
                            }
                            else
                            {
                                linePath += $"L {x},{y} ";
                                fillPath += $"L {x},{y} ";
                            }
                        }
                        fillPath += $"L {60 + (salesData.Count - 1) * pointSpacing},240 Z";

                        <defs>
                            <linearGradient id="salesGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#059669;stop-opacity:0.3" />
                                <stop offset="100%" style="stop-color:#059669;stop-opacity:0" />
                            </linearGradient>
                        </defs>

                        <path d="@fillPath" fill="url(#salesGradient)" />
                        <path d="@linePath" fill="none" stroke="#059669" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />

                        @* Data points with tooltips *@
                        @for (int i = 0; i < salesData.Count; i++)
                        {
                            var item = salesData[i];
                            var x = 60 + (i * pointSpacing);
                            var y = maxAmount > 0 ? 240 - ((double)item.Amount / (double)maxAmount) * chartHeight : 240;
                            var tooltipY = y - 45;
                            if (tooltipY < 10) tooltipY = y + 15;
                            
                            <g class="chart-point-group">
                                @* Invisible larger hit area for easier hover *@
                                <circle cx="@x" cy="@y" r="15" fill="transparent" class="chart-hit-area" />
                                @* Visible data point *@
                                <circle cx="@x" cy="@y" r="5" fill="#059669" stroke="#fff" stroke-width="2" class="data-point" />
                                @* Tooltip *@
                                <g class="chart-tooltip" transform="translate(@x, @tooltipY)">
                                    <rect x="-55" y="-20" width="110" height="40" rx="6" fill="#1f2937" opacity="0.95" />
                                    <text x="0" y="-2" font-size="11" fill="#9ca3af" text-anchor="middle">@item.Date.ToString("MMM dd, yyyy")</text>
                                    <text x="0" y="14" font-size="13" fill="#10b981" text-anchor="middle" font-weight="600">â‚±@item.Amount.ToString("N2")</text>
                                    <polygon points="0,22 -6,28 6,28" fill="#1f2937" transform="translate(0, -2)" />
                                </g>
                            </g>
                        }

                        @* X-axis labels *@
                        @for (int i = 0; i < salesData.Count; i += Math.Max(1, salesData.Count / 6))
                        {
                            var item = salesData[i];
                            var x = 60 + (i * pointSpacing);
                            @((MarkupString)$"<text x=\"{x}\" y=\"265\" font-size=\"10\" fill=\"#6b7280\" text-anchor=\"middle\">{item.Date.ToString("MMM d")}</text>")
                        }

                        @* Y-axis labels *@
                        @for (int j = 0; j <= 4; j++)
                        {
                            var value = maxAmount * (4 - j) / 4.0m;
                            var y = 20 + (j * chartHeight / 4);
                            @((MarkupString)$"<text x=\"55\" y=\"{y + 4}\" font-size=\"10\" fill=\"#6b7280\" text-anchor=\"end\">â‚±{value:N0}</text>")
                            <line x1="60" y1="@y" x2="760" y2="@y" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4"/>
                        }
                    }
                    else
                    {
                        @: <text x="400" y="150" font-size="14" fill="#9ca3af" text-anchor="middle">No sales data available for this period</text>
                    }
                </svg>
            </div>
        </div>

        @* Income vs Expenses Chart *@
        <div class="chart-card" @onclick='() => Nav.NavigateTo("/accounting/reports/profit-loss")'>
            <div class="chart-header">
                <h3>Income vs Expenses</h3>
                <span class="chart-subtitle">Financial overview</span>
            </div>
            <div class="chart-body">
                @{
                    var finMax = Math.Max((double)stats.GrossSales, Math.Max((double)stats.TotalExpenses, Math.Max((double)stats.NetIncome, Math.Abs((double)stats.NetProfit))));
                    if (finMax <= 0) finMax = 1;
                }
                <div class="horizontal-bars">
                    <div class="bar-row">
                        <span class="bar-label">Gross Sales</span>
                        <div class="bar-track">
                            <div class="bar-fill bar-income" style="width: @(hideConfidential ? "0" : (stats.GrossSales > 0 ? (double)stats.GrossSales / finMax * 100 : 0).ToString("F1"))%"></div>
                        </div>
                        <span class="bar-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.GrossSales)</span>
                    </div>
                    <div class="bar-row">
                        <span class="bar-label">Returns</span>
                        <div class="bar-track">
                            <div class="bar-fill bar-returns" style="width: @(hideConfidential ? "0" : (stats.Returns > 0 ? (double)stats.Returns / finMax * 100 : 0).ToString("F1"))%"></div>
                        </div>
                        <span class="bar-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.Returns)</span>
                    </div>
                    <div class="bar-row">
                        <span class="bar-label">Expenses</span>
                        <div class="bar-track">
                            <div class="bar-fill bar-expense" style="width: @(hideConfidential ? "0" : (stats.TotalExpenses > 0 ? (double)stats.TotalExpenses / finMax * 100 : 0).ToString("F1"))%"></div>
                        </div>
                        <span class="bar-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.TotalExpenses)</span>
                    </div>
                    <div class="bar-row">
                        <span class="bar-label">Net Profit</span>
                        <div class="bar-track">
                            <div class="bar-fill @(stats.NetProfit >= 0 ? "bar-profit" : "bar-loss")" style="width: @(hideConfidential ? "0" : (stats.NetProfit != 0 ? Math.Abs((double)stats.NetProfit) / finMax * 100 : 0).ToString("F1"))%"></div>
                        </div>
                        <span class="bar-value @(stats.NetProfit >= 0 ? "positive" : "negative") @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.NetProfit)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    @* Tax & Fees Summary *@
    @if (showTaxSection)
    {
    <div class="tax-summary-row" @onclick='() => Nav.NavigateTo("/accounting/reports/tax")'>
        <div class="tax-card">
            <div class="tax-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                    <path d="M9 9h6v6H9z"></path>
                </svg>
                <h3>Tax & Fees Summary</h3>
                <span class="tax-badge">Click for full report</span>
            </div>
            <div class="tax-items">
                <div class="tax-item">
                    <div class="tax-icon vat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <div class="tax-info">
                        <span class="tax-label">VAT (12%)</span>
                        <span class="tax-desc">Value Added Tax on sales</span>
                    </div>
                    <span class="tax-amount @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.VAT)</span>
                </div>
                <div class="tax-divider"></div>
                <div class="tax-item">
                    <div class="tax-icon admin">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                    </div>
                    <div class="tax-info">
                        <span class="tax-label">Admin Fee (2%)</span>
                        <span class="tax-desc">Platform fee per product</span>
                    </div>
                    <span class="tax-amount @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.AdminFee)</span>
                </div>
                <div class="tax-divider"></div>
                <div class="tax-item tax-total">
                    <div class="tax-icon total">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <div class="tax-info">
                        <span class="tax-label">Total Tax & Fees</span>
                        <span class="tax-desc">Combined obligations</span>
                    </div>
                    <span class="tax-amount total @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.VAT + stats.AdminFee)</span>
                </div>
            </div>
        </div>
    </div>
    }

    @* Stats Grid *@
    @if (showStatsGrid)
    {
    <div class="stats-grid">
        <div class="stat-card stat-net-income" @onclick='() => Nav.NavigateTo("/accounting/financial/income")'>
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.NetIncome)</span>
                <span class="stat-label">Net Income</span>
            </div>
            <span class="stat-badge">After returns</span>
        </div>

        <div class="stat-card stat-transactions" @onclick='() => Nav.NavigateTo("/accounting/reports/sales")'>
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                    <rect x="7" y="7" width="10" height="10" rx="1"></rect>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-value @(hideConfidential ? "masked" : "")">@MaskValue(stats.TotalTransactions)</span>
                <span class="stat-label">Transactions</span>
            </div>
            <span class="stat-badge">All completed</span>
        </div>

        <div class="stat-card stat-returns" @onclick='() => Nav.NavigateTo("/accounting/financial/income")'>
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.Returns)</span>
                <span class="stat-label">Returns</span>
            </div>
            <span class="stat-badge">Refunded</span>
        </div>

        <div class="stat-card stat-accounts-payable" @onclick='() => Nav.NavigateTo("/accounting/financial/supplier-payments")'>
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                    <path d="M7 14l5-5 5 5"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.AccountsPayable)</span>
                <span class="stat-label">Accounts Payable</span>
            </div>
            <span class="stat-badge badge-warning">To suppliers</span>
        </div>

        <div class="stat-card stat-accounts-receivable" @onclick='() => Nav.NavigateTo("/accounting/reports/sales")'>
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                    <path d="M7 10l5 5 5-5"></path>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.AccountsReceivable)</span>
                <span class="stat-label">Accounts Receivable</span>
            </div>
            <span class="stat-badge badge-success">From customers</span>
        </div>

        <div class="stat-card stat-profit-margin" @onclick='() => Nav.NavigateTo("/accounting/reports/profit-loss")'>
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"></line>
                    <line x1="18" y1="20" x2="18" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="16"></line>
                </svg>
            </div>
            <div class="stat-info">
                <span class="stat-value @(stats.NetIncome > 0 && (stats.NetProfit / stats.NetIncome * 100) >= 10 ? "positive" : "warning") @(hideConfidential ? "masked" : "")">
                    @(hideConfidential ? "â€¢â€¢â€¢%" : (stats.NetIncome > 0 ? $"{((stats.NetProfit / stats.NetIncome) * 100):F1}%" : "N/A"))
                </span>
                <span class="stat-label">Profit Margin</span>
            </div>
            <span class="stat-badge">Net margin</span>
        </div>
    </div>
    }

    @* Bottom Section: Lists *@
    @if (showPendingApprovals || showExpenseCategories)
    {
    <div class="bottom-grid">
        @* Pending Approvals *@
        @if (showPendingApprovals)
        {
        <div class="list-card @(pendingApprovals.Any() ? "alert-card" : "")">
            <div class="list-header">
                <h3>Pending Approvals</h3>
                <button class="view-all-btn" @onclick='() => Nav.NavigateTo("/accounting/financial/daily-sales")'>View All</button>
            </div>
            <div class="list-body">
                @if (pendingApprovals.Any())
                {
                    @foreach (var (item, index) in pendingApprovals.Take(5).Select((p, i) => (p, i)))
                    {
                        <div class="list-item alert-item">
                            <div class="alert-indicator"></div>
                            <div class="item-info">
                                <span class="item-name">@item.CashierName</span>
                                <span class="item-detail">@item.SaleDate.ToString("MMM dd, yyyy") â€¢ @item.TotalTransactions transactions</span>
                            </div>
                            <span class="item-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(item.TotalSales)</span>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state success">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <p>All verifications are up to date!</p>
                    </div>
                }
            </div>
        </div>
        }

        @* Top Expense Categories *@
        @if (showExpenseCategories)
        {
        <div class="list-card">
            <div class="list-header">
                <h3>Top Expense Categories</h3>
                <button class="view-all-btn" @onclick='() => Nav.NavigateTo("/accounting/reports/expenses")'>View All</button>
            </div>
            <div class="list-body">
                @if (topExpenseCategories.Any())
                {
                    @foreach (var (item, index) in topExpenseCategories.Take(5).Select((c, i) => (c, i)))
                    {
                        <div class="list-item">
                            <span class="rank-badge rank-@(index + 1)">@(index + 1)</span>
                            <div class="item-info">
                                <span class="item-name">@item.Type</span>
                                <span class="item-detail">@item.Count transactions</span>
                            </div>
                            <span class="item-value @(hideConfidential ? "masked" : "")">â‚±@MaskValue(item.Total)</span>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <p>No expense data available</p>
                    </div>
                }
            </div>
        </div>
        }

        @* Expenses Trend Chart *@
        @if (showExpensesChart)
        {
        <div class="chart-card chart-list" @onclick='() => Nav.NavigateTo("/accounting/reports/expenses")'>
            <div class="chart-header">
                <h3>Expenses Trend</h3>
                <span class="chart-subtitle">Daily expenses over period</span>
            </div>
            <div class="chart-body chart-body-small">
                <svg class="bar-chart-mini" viewBox="0 0 400 200" preserveAspectRatio="xMidYMid meet">
                    @if (expensesData.Any() && expensesData.Any(d => d.Amount > 0))
                    {
                        var maxAmount = expensesData.Max(d => d.Amount);
                        var chartHeight = 150.0;
                        var chartWidth = 340.0;
                        var dataCount = expensesData.Count;
                        var barSpacing = chartWidth / Math.Max(dataCount, 1);
                        var barWidth = Math.Max(2.0, barSpacing * 0.7);

                        @for (int i = 0; i < expensesData.Count; i++)
                        {
                            var item = expensesData[i];
                            var barHeight = maxAmount > 0 ? (item.Amount / maxAmount) * (decimal)chartHeight : 0;
                            var yPos = chartHeight - (double)barHeight + 20;
                            var xPos = 30 + (i * barSpacing) + (barSpacing / 2) - (barWidth / 2);

                            <rect x="@xPos" y="@yPos" width="@barWidth" height="@((double)barHeight)"
                                  fill="#ef4444" rx="2" class="chart-bar"/>
                        }
                    }
                    else
                    {
                        @: <text x="200" y="100" font-size="12" fill="#9ca3af" text-anchor="middle">No expenses data</text>
                    }
                </svg>
            </div>
        </div>
        }

        @* Performance Insights *@
        @if (showInsights)
        {
        <div class="list-card insights-card">
            <div class="list-header">
                <h3>Performance Insights</h3>
            </div>
            <div class="insights-content">
                <div class="insights-grid">
                    <div class="insight-item">
                        <span class="insight-label">Profit Margin</span>
                        <span class="insight-value @(stats.NetIncome > 0 && (stats.NetProfit / stats.NetIncome * 100) >= 10 ? "text-success" : "text-warning") @(hideConfidential ? "masked" : "")">
                            @(hideConfidential ? "â€¢â€¢â€¢%" : (stats.NetIncome > 0 ? $"{((stats.NetProfit / stats.NetIncome) * 100):F1}%" : "N/A"))
                        </span>
                    </div>
                    <div class="insight-item">
                        <span class="insight-label">Return Rate</span>
                        <span class="insight-value @(stats.GrossSales > 0 && (stats.Returns / stats.GrossSales * 100) < 5 ? "text-success" : "text-warning") @(hideConfidential ? "masked" : "")">
                            @(hideConfidential ? "â€¢â€¢â€¢%" : (stats.GrossSales > 0 ? $"{((stats.Returns / stats.GrossSales) * 100):F1}%" : "0%"))
                        </span>
                    </div>
                </div>
                @if (stats.PendingApprovals > 0 || stats.NetProfit < 0 || stats.Returns > stats.GrossSales * 0.1m)
                {
                    <div class="recommendations">
                        <h4>ðŸ’¡ Recommendations</h4>
                        <ul class="recommendations-list">
                            @if (stats.PendingApprovals > 0)
                            {
                                <li><strong>@stats.PendingApprovals</strong> pending daily sales verification(s) need review</li>
                            }
                            @if (stats.NetProfit < 0)
                            {
                                <li>Current period shows a <strong>loss</strong> - review expenses and sales</li>
                            }
                            @if (stats.Returns > stats.GrossSales * 0.1m)
                            {
                                <li>Return rate is above 10% - investigate product quality</li>
                            }
                        </ul>
                    </div>
                }
                else
                {
                    <div class="recommendations success">
                        <h4>âœ… Status</h4>
                        <ul class="recommendations-list">
                            <li>All daily sales verifications are up to date</li>
                            @if (stats.NetProfit > 0)
                            {
                                <li>Business is profitable with <span class="@(hideConfidential ? "masked" : "")">â‚±@MaskValue(stats.NetProfit)</span> net profit</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
        }
    </div>
    }

    @* No Results Message *@
    @if (!string.IsNullOrWhiteSpace(searchTerm) && !showKpiSection && !showQuickActions && !showSalesChart && !showTaxSection && !showStatsGrid && !showPendingApprovals && !showExpenseCategories)
    {
        <div class="no-results-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5;">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <h3 style="margin: 0 0 8px; color: #374151;">No results found</h3>
            <p style="margin: 0; color: #6b7280;">No dashboard sections match "<strong>@searchTerm</strong>"</p>
            <button class="filter-btn" style="margin-top: 16px;" @onclick="HandleClearSearch">Clear Search</button>
        </div>
    }
}

@code {
    private class DashboardStats
    {
        public decimal GrossSales { get; set; }
        public decimal Returns { get; set; }
        public decimal NetIncome { get; set; }
        public decimal TotalExpenses { get; set; }
        public decimal NetProfit { get; set; }
        public int TotalTransactions { get; set; }
        public int PendingApprovals { get; set; }
        public decimal VAT { get; set; }
        public decimal AdminFee { get; set; }
        public decimal TodaySales { get; set; }
        public decimal TodayExpenses { get; set; }
        public decimal NetCashMovement { get; set; }
        public decimal AccountsPayable { get; set; }
        public decimal AccountsReceivable { get; set; }
    }

    private class DailySalesData
    {
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
        public int Count { get; set; }
    }

    private class DailyExpenseData
    {
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
    }

    private class ExpenseCategoryRow
    {
        public string Type { get; set; } = string.Empty;
        public decimal Total { get; set; }
        public int Count { get; set; }
    }

    private bool showSecurityAlert = false;
    private bool isLoading = true;
    private bool hideConfidential = false;
    private int sellerUserId = 0;
    private DashboardStats stats = new();
    private List<DailySalesData> salesData = new();
    private List<DailyExpenseData> expensesData = new();
    private List<IT13_Final.Services.Data.DailySalesVerificationModel> pendingApprovals = new();
    private List<ExpenseCategoryRow> topExpenseCategories = new();

    // Search and Filter variables
    private string searchTerm = string.Empty;
    private string selectedDateRange = ""; // Default to Custom
    private DateTime? startDate = null;
    private DateTime? endDate = null;

    private bool HasActiveDateFilters => !string.IsNullOrEmpty(selectedDateRange) || startDate.HasValue || endDate.HasValue;
    private System.Threading.Timer? _searchTimer;

    // Search visibility flags
    private bool showKpiSection => IsSearchMatch("sales", "profit", "expense", "pending", "approval", "cash", "flow", "revenue");
    private bool showQuickActions => IsSearchMatch("verify", "sales", "report", "expense", "profit", "loss", "tax", "cash", "audit");
    private bool showSalesChart => IsSearchMatch("daily", "sales", "trend", "chart", "revenue", "income", "expense");
    private bool showTaxSection => IsSearchMatch("tax", "vat", "admin", "fee", "obligation");
    private bool showStatsGrid => IsSearchMatch("net", "income", "transaction", "return", "margin", "profit", "accounts", "payable", "receivable");
    private bool showPendingApprovals => IsSearchMatch("pending", "approval", "verify", "cashier") || pendingApprovals.Any();
    private bool showExpenseCategories => IsSearchMatch("expense", "category", "cost") || topExpenseCategories.Any();
    private bool showExpensesChart => IsSearchMatch("expense", "trend", "chart", "daily");
    private bool showInsights => IsSearchMatch("insight", "performance", "margin", "rate", "recommendation");

    private bool IsSearchMatch(params string[] keywords)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return true;
        
        var searchLower = searchTerm.ToLowerInvariant();
        return keywords.Any(k => k.Contains(searchLower) || searchLower.Contains(k));
    }

    private void ToggleConfidentialVisibility()
    {
        hideConfidential = !hideConfidential;
        StateHasChanged();
    }

    private string MaskValue(decimal value, string format = "N0")
    {
        if (hideConfidential) return "â€¢â€¢â€¢â€¢â€¢";
        return FormatCompactNumber(value);
    }

    private string MaskValue(int value)
    {
        if (hideConfidential) return "â€¢â€¢â€¢";
        return FormatCompactNumber(value);
    }

    private string FormatCompactNumber(decimal value)
    {
        var absValue = Math.Abs(value);
        var isNegative = value < 0;
        string result;
        
        if (absValue >= 1_000_000_000_000m) // Trillion
        {
            result = FormatWithMaxDigits(absValue / 1_000_000_000_000m) + "T";
        }
        else if (absValue >= 1_000_000_000m) // Billion
        {
            result = FormatWithMaxDigits(absValue / 1_000_000_000m) + "B";
        }
        else if (absValue >= 1_000_000m) // Million
        {
            result = FormatWithMaxDigits(absValue / 1_000_000m) + "M";
        }
        else if (absValue >= 10_000m) // Thousand (10K+)
        {
            result = FormatWithMaxDigits(absValue / 1_000m) + "K";
        }
        else
        {
            result = absValue.ToString("N0");
        }
        
        return isNegative ? $"{result} (Debt)" : result;
    }

    private string FormatWithMaxDigits(decimal num)
    {
        // Format to max 4 significant digits
        if (num >= 1000) return num.ToString("N0");
        if (num >= 100) return num.ToString("F1");
        if (num >= 10) return num.ToString("F2");
        return num.ToString("F3");
    }

    private string MaskPercentage(decimal? value)
    {
        if (!value.HasValue) return hideConfidential ? "â€¢â€¢â€¢%" : "N/A";
        return hideConfidential ? "â€¢â€¢â€¢%" : $"{value:F1}%";
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12) return "Good Morning";
        if (hour < 17) return "Good Afternoon";
        return "Good Evening";
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckPasswordChangeRequired();
        await LoadSellerUserId();
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupSearchInputFilter", "dashboard-search-input");
        }
    }

    private async Task LoadSellerUserId()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
                using var conn = new SqlConnection(connectionString);
                await conn.OpenAsync();

                var sql = "SELECT user_id FROM dbo.tbl_users WHERE id = @UserId AND archived_at IS NULL";
                using var cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@UserId", AuthState.CurrentUser.Id);

                var result = await cmd.ExecuteScalarAsync();
                if (result != null && result != DBNull.Value)
                {
                    sellerUserId = Convert.ToInt32(result);
                }
            }
            catch
            {
                sellerUserId = 0;
            }
        }
    }

    private async Task LoadDashboardData()
    {
        if (sellerUserId <= 0)
        {
            await LoadSellerUserId();
            if (sellerUserId <= 0)
            {
                isLoading = false;
                StateHasChanged();
                return;
            }
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            // Load income data - only show approved daily sales verification
            var income = await IncomeBreakdownService.GetIncomeBreakdownAsync(
                sellerUserId,
                startDate,
                endDate,
                onlyApprovedDays: true
            );

            stats.GrossSales = income.TotalGrossSales;
            stats.Returns = income.TotalReturns;
            stats.NetIncome = income.NetIncome;
            stats.TotalTransactions = income.TotalTransactions;

            // Calculate VAT (12% on net income after returns)
            stats.VAT = stats.NetIncome * 0.12m;

            // Calculate Admin Fee (2% on net income after returns)
            stats.AdminFee = stats.NetIncome * 0.02m;

            // Load expenses
            var allExpenses = await ExpenseService.GetExpensesAsync(
                sellerUserId,
                searchTerm: null,
                expenseType: null,
                startDate,
                endDate,
                page: 1,
                pageSize: 10000
            );

            stats.TotalExpenses = allExpenses.Sum(e => e.Amount);
            // Net Profit = Gross Profit (Gross Sales - Returns) - Total Expenses
            var grossProfit = stats.GrossSales - stats.Returns;
            stats.NetProfit = grossProfit - stats.TotalExpenses;

            // Group expenses by category
            topExpenseCategories = allExpenses
                .GroupBy(e => e.ExpenseType)
                .Select(g => new ExpenseCategoryRow
                {
                    Type = g.Key,
                    Total = g.Sum(x => x.Amount),
                    Count = g.Count()
                })
                .ToList();

            // Load supplier payments and add to categories
            var supplierPaymentData = await LoadSupplierPayments();
            if (supplierPaymentData.Total > 0)
            {
                topExpenseCategories.Add(new ExpenseCategoryRow
                {
                    Type = "Supplier Payments",
                    Total = supplierPaymentData.Total,
                    Count = supplierPaymentData.Count
                });
            }

            // Sort by total descending
            topExpenseCategories = topExpenseCategories
                .OrderByDescending(r => r.Total)
                .ToList();

            // Load pending approvals
            pendingApprovals = await DailySalesVerificationService.GetPendingDailySalesForAccountingAsync(
                sellerUserId,
                searchTerm: null,
                startDate: null,
                endDate: null,
                page: 1,
                pageSize: 10
            );
            stats.PendingApprovals = pendingApprovals.Count;

            // Load today's data - only show approved daily sales verification
            var today = DateTime.Today;
            var todayIncome = await IncomeBreakdownService.GetIncomeBreakdownAsync(
                sellerUserId,
                today,
                today,
                onlyApprovedDays: true
            );
            stats.TodaySales = todayIncome.TotalGrossSales;

            var todayExpenses = await ExpenseService.GetExpensesAsync(
                sellerUserId,
                searchTerm: null,
                expenseType: null,
                today,
                today,
                page: 1,
                pageSize: 10000
            );
            stats.TodayExpenses = todayExpenses.Sum(e => e.Amount);

            // Load cashflow data
            await LoadCashflowData();

            // Load accounts payable and receivable
            await LoadAccountsPayable();
            await LoadAccountsReceivable();

            // Load daily sales data for chart
            await LoadDailySalesData();

            // Load daily expenses data for chart
            await LoadDailyExpensesData();

            // Filter data by date range
            FilterDataByDateRange();

            // Apply search filter if needed
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                ApplySearchFilter();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading dashboard data: {ex.Message}");
            stats = new DashboardStats();
            salesData = new List<DailySalesData>();
            expensesData = new List<DailyExpenseData>();
            pendingApprovals = new List<IT13_Final.Services.Data.DailySalesVerificationModel>();
            topExpenseCategories = new List<ExpenseCategoryRow>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }


    private async Task<(decimal Total, int Count)> LoadSupplierPayments()
    {
        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new SqlConnection(connectionString);
            await conn.OpenAsync();

            var sql = @"
                SELECT 
                    COALESCE(SUM(sp.amount_paid), 0) as total_amount,
                    COUNT(*) as payment_count
                FROM dbo.tbl_supplier_payments sp
                WHERE sp.archived_at IS NULL
                AND sp.seller_user_id = @SellerUserId";

            if (startDate.HasValue)
            {
                sql += " AND sp.payment_date >= @StartDate";
            }
            if (endDate.HasValue)
            {
                sql += " AND sp.payment_date <= @EndDate";
            }

            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@SellerUserId", sellerUserId);
            if (startDate.HasValue)
            {
                cmd.Parameters.AddWithValue("@StartDate", startDate.Value.Date);
            }
            if (endDate.HasValue)
            {
                cmd.Parameters.AddWithValue("@EndDate", endDate.Value.Date);
            }

            using var reader = await cmd.ExecuteReaderAsync();
            decimal total = 0m;
            int count = 0;
            
            if (await reader.ReadAsync())
            {
                total = reader.GetDecimal(0);
                count = reader.GetInt32(1);
            }

            stats.TotalExpenses += total;
            stats.NetProfit = stats.NetIncome - stats.TotalExpenses;
            
            return (total, count);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading supplier payments: {ex.Message}");
            return (0m, 0);
        }
    }

    private async Task LoadCashflowData()
    {
        try
        {
            var movements = await CashflowAuditService.GetMovementsAsync(
                sellerUserId,
                cashierUserId: null,
                startDate,
                endDate
            );

            var cashIn = movements.Where(m => m.IsCashIn).Sum(m => m.Amount);
            var cashOut = movements.Where(m => !m.IsCashIn).Sum(m => m.Amount);
            stats.NetCashMovement = cashIn - cashOut;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading cashflow data: {ex.Message}");
            stats.NetCashMovement = 0m;
        }
    }

    private async Task LoadAccountsPayable()
    {
        try
        {
            // Get all payable items (unpaid and partially paid)
            var payableItems = await SupplierInvoiceService.GetPayableItemsAsync(
                sellerUserId,
                searchTerm: null,
                supplierId: null,
                paymentStatus: null, // Get all statuses
                startDate: null,
                endDate: null,
                page: 1,
                pageSize: 10000
            );

            // Sum up all remaining balances
            stats.AccountsPayable = payableItems
                .Where(item => item.RemainingBalance > 0)
                .Sum(item => item.RemainingBalance);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading accounts payable: {ex.Message}");
            stats.AccountsPayable = 0m;
        }
    }

    private async Task LoadAccountsReceivable()
    {
        try
        {
            // Since all sales are paid immediately (cash or digital), Accounts Receivable is typically 0
            // This can be extended in the future if credit sales are implemented
            stats.AccountsReceivable = 0m;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading accounts receivable: {ex.Message}");
            stats.AccountsReceivable = 0m;
        }
    }

    private async Task LoadDailySalesData()
    {
        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new SqlConnection(connectionString);
            await conn.OpenAsync();

            var days = GetDaysFromDateRange();
            var endDateForQuery = endDate ?? DateTime.Today;
            var startDateForQuery = startDate ?? endDateForQuery.AddDays(-days);

            var sql = @"
                SELECT 
                    CAST(s.timestamps AS DATE) as sale_date,
                    COUNT(*) as transaction_count,
                    COALESCE(SUM(s.amount), 0) as total_amount
                FROM dbo.tbl_sales s
                INNER JOIN dbo.tbl_users u ON s.user_id = u.id
                WHERE s.archives IS NULL
                AND s.status = 'Completed'
                AND u.archived_at IS NULL";

            if (sellerUserId > 0)
            {
                sql += " AND u.user_id = @SellerUserId";
            }

            sql += @"
                AND CAST(s.timestamps AS DATE) >= @StartDate
                AND CAST(s.timestamps AS DATE) <= @EndDate
                AND EXISTS (
                    SELECT 1 FROM dbo.tbl_daily_sales_verifications dsv
                    WHERE dsv.cashier_user_id = s.user_id
                    AND CAST(dsv.sale_date AS DATE) = CAST(s.timestamps AS DATE)
                    AND dsv.status = 'Approved'
                    AND dsv.archived_at IS NULL";
            if (sellerUserId > 0)
            {
                sql += " AND dsv.seller_user_id = @SellerUserId";
            }
            sql += @")
                GROUP BY CAST(s.timestamps AS DATE)
                ORDER BY sale_date";

            using var cmd = new SqlCommand(sql, conn);
            if (sellerUserId > 0)
            {
                cmd.Parameters.AddWithValue("@SellerUserId", sellerUserId);
            }
            cmd.Parameters.AddWithValue("@StartDate", startDateForQuery.Date);
            cmd.Parameters.AddWithValue("@EndDate", endDateForQuery.Date);

            salesData.Clear();
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                salesData.Add(new DailySalesData
                {
                    Date = reader.GetDateTime(0),
                    Count = reader.GetInt32(1),
                    Amount = reader.GetDecimal(2)
                });
            }

            // Fill in missing dates with zero values
            FillMissingDates(salesData, startDateForQuery, endDateForQuery);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading daily sales data: {ex.Message}");
            salesData = new List<DailySalesData>();
        }
    }

    private async Task LoadDailyExpensesData()
    {
        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new SqlConnection(connectionString);
            await conn.OpenAsync();

            var endDateForQuery = endDate ?? DateTime.Today;
            var startDateForQuery = startDate ?? endDateForQuery.AddDays(-30);

            var sql = @"
                SELECT 
                    CAST(e.expense_date AS DATE) as expense_date,
                    COALESCE(SUM(e.amount), 0) as total_amount
                FROM dbo.tbl_expenses e
                WHERE e.archived_at IS NULL
                AND e.seller_user_id = @SellerUserId";

            sql += @"
                AND CAST(e.expense_date AS DATE) >= @StartDate
                AND CAST(e.expense_date AS DATE) <= @EndDate
                GROUP BY CAST(e.expense_date AS DATE)
                ORDER BY expense_date";

            using var cmd = new SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@SellerUserId", sellerUserId);
            cmd.Parameters.AddWithValue("@StartDate", startDateForQuery.Date);
            cmd.Parameters.AddWithValue("@EndDate", endDateForQuery.Date);

            expensesData.Clear();
            using var reader = await cmd.ExecuteReaderAsync();
            while (await reader.ReadAsync())
            {
                expensesData.Add(new DailyExpenseData
                {
                    Date = reader.GetDateTime(0),
                    Amount = reader.GetDecimal(1)
                });
            }

            // Fill in missing dates with zero values
            FillMissingDatesForExpenses(expensesData, startDateForQuery, endDateForQuery);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error loading daily expenses data: {ex.Message}");
            expensesData = new List<DailyExpenseData>();
        }
    }

    private void FillMissingDates(List<DailySalesData> data, DateTime start, DateTime end)
    {
        var existingDates = new HashSet<DateTime>(data.Select(d => d.Date.Date));
        for (var date = start.Date; date <= end.Date; date = date.AddDays(1))
        {
            if (!existingDates.Contains(date))
            {
                data.Add(new DailySalesData { Date = date, Amount = 0, Count = 0 });
            }
        }
        data.Sort((a, b) => a.Date.CompareTo(b.Date));
    }

    private void FillMissingDatesForExpenses(List<DailyExpenseData> data, DateTime start, DateTime end)
    {
        var existingDates = new HashSet<DateTime>(data.Select(d => d.Date.Date));
        for (var date = start.Date; date <= end.Date; date = date.AddDays(1))
        {
            if (!existingDates.Contains(date))
            {
                data.Add(new DailyExpenseData { Date = date, Amount = 0 });
            }
        }
        data.Sort((a, b) => a.Date.CompareTo(b.Date));
    }

    private int GetDaysFromDateRange()
    {
        if (startDate.HasValue && endDate.HasValue)
        {
            return Math.Max(1, (endDate.Value - startDate.Value).Days + 1);
        }
        return 30;
    }

    private void FilterDataByDateRange()
    {
        if (!startDate.HasValue || !endDate.HasValue)
            return;

        var start = startDate.Value.Date;
        var end = endDate.Value.Date;

        salesData = salesData
            .Where(d => d.Date.Date >= start && d.Date.Date <= end)
            .ToList();

        expensesData = expensesData
            .Where(d => d.Date.Date >= start && d.Date.Date <= end)
            .ToList();
    }

    private void ApplySearchFilter()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return;

        var searchLower = searchTerm.ToLowerInvariant();

        // Filter pending approvals
        if (pendingApprovals.Any())
        {
            pendingApprovals = pendingApprovals
                .Where(p => p.CashierName.ToLowerInvariant().Contains(searchLower))
                .ToList();
        }

        // Filter expense categories
        if (topExpenseCategories.Any())
        {
            topExpenseCategories = topExpenseCategories
                .Where(e => e.Type.ToLowerInvariant().Contains(searchLower))
                .ToList();
        }
    }

    private async Task CheckPasswordChangeRequired()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                showSecurityAlert = await UserService.MustChangePasswordAsync(AuthState.CurrentUser.Id);
                StateHasChanged();
            }
            catch
            {
                showSecurityAlert = false;
            }
        }
    }

    private void HandleLater()
    {
        showSecurityAlert = false;
        StateHasChanged();
    }

    private void HandleChangePassword()
    {
        showSecurityAlert = false;
        Nav.NavigateTo("/accounting/settings?tab=password");
        StateHasChanged();
    }

    private void HandleSearchInput()
    {
        var filtered = System.Text.RegularExpressions.Regex.Replace(searchTerm, @"[^a-zA-Z0-9\s\-_]", "");
        if (filtered != searchTerm)
        {
            searchTerm = filtered;
        }

        _searchTimer?.Dispose();
        _searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    if (AuthState.CurrentUser != null && !string.IsNullOrWhiteSpace(searchTerm))
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "search",
                            "Dashboard",
                            $"Searched dashboard: {searchTerm}"
                        );
                    }
                }
                catch { }
                await LoadDashboardData();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadDashboardData();
        }
    }

    private async Task HandleClearSearch()
    {
        searchTerm = string.Empty;
        await LoadDashboardData();
        StateHasChanged();
    }

    private async void HandleDateRangeChange()
    {
        var today = DateTime.Today;
        switch (selectedDateRange)
        {
            case "":
                startDate = null;
                endDate = null;
                break;
            case "today":
                startDate = today;
                endDate = today;
                break;
            case "yesterday":
                startDate = today.AddDays(-1);
                endDate = today.AddDays(-1);
                break;
            case "last7days":
                startDate = today.AddDays(-6);
                endDate = today;
                break;
            case "last30days":
                startDate = today.AddDays(-29);
                endDate = today;
                break;
            case "thismonth":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "thisyear":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
        }
        
        try
        {
            if (AuthState.CurrentUser != null && !string.IsNullOrEmpty(selectedDateRange))
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "filter",
                    "Dashboard",
                    $"Changed date range filter to: {selectedDateRange}"
                );
            }
        }
        catch { }
        
        await LoadDashboardData();
    }

    private async Task HandleFromDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            var today = DateTime.Today;
            // Prevent future dates - cap at today
            if (date.Date > today)
            {
                startDate = today;
            }
            else
            {
                startDate = date.Date;
            }
            selectedDateRange = "";
            
            // If end date is before start date, adjust it
            if (endDate.HasValue && endDate.Value < startDate.Value)
            {
                endDate = startDate.Value;
            }
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            startDate = null;
            selectedDateRange = "";
        }
        
        await LoadDashboardData();
        StateHasChanged();
    }

    private async Task HandleToDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            var today = DateTime.Today;
            var parsedDate = date.Date;
            
            // Prevent future dates - cap at today
            if (parsedDate > today)
            {
                parsedDate = today;
            }
            
            // Ensure end date is never before start date
            if (startDate.HasValue)
            {
                if (parsedDate < startDate.Value)
                {
                    endDate = startDate.Value;
                }
                else
                {
                    endDate = parsedDate;
                }
            }
            else
            {
                endDate = parsedDate;
            }
            
            selectedDateRange = "";
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            endDate = null;
            selectedDateRange = "";
        }
        
        await LoadDashboardData();
        StateHasChanged();
    }

    private async void ClearDateFilter()
    {
        selectedDateRange = "";
        startDate = null;
        endDate = null;
        await LoadDashboardData();
        StateHasChanged();
    }

    private async Task ClearAllFilters()
    {
        searchTerm = string.Empty;
        selectedDateRange = "";
        startDate = null;
        endDate = null;
        await LoadDashboardData();
        StateHasChanged();
    }

    private async Task PrintDashboard()
    {
        // Confirm before exporting PDF
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirmExportPDF");
        if (!confirmed) return;

        try
        {
            if (AuthState.CurrentUser != null)
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "print",
                    "Dashboard",
                    "Printed accounting dashboard report"
                );
            }

            var dashboardData = new
            {
                title = "Accounting Dashboard Report",
                printedBy = AuthState.CurrentUser?.FullName ?? "Accountant",
                printedAt = DateTime.Now.ToString("MMMM dd, yyyy hh:mm tt"),
                dateRange = startDate.HasValue && endDate.HasValue 
                    ? $"{startDate?.ToString("MM/dd/yyyy")} - {endDate?.ToString("MM/dd/yyyy")}" 
                    : "All Time",
                
                financials = new
                {
                    grossSales = stats.GrossSales.ToString("N2"),
                    returns = stats.Returns.ToString("N2"),
                    netIncome = stats.NetIncome.ToString("N2"),
                    totalExpenses = stats.TotalExpenses.ToString("N2"),
                    netProfit = stats.NetProfit.ToString("N2"),
                    vat = stats.VAT.ToString("N2"),
                    adminFee = stats.AdminFee.ToString("N2"),
                    cashFlow = stats.NetCashMovement.ToString("N2")
                },

                stats = new
                {
                    totalTransactions = stats.TotalTransactions,
                    pendingApprovals = stats.PendingApprovals,
                    todaySales = stats.TodaySales.ToString("N2"),
                    todayExpenses = stats.TodayExpenses.ToString("N2"),
                    accountsPayable = stats.AccountsPayable.ToString("N2"),
                    accountsReceivable = stats.AccountsReceivable.ToString("N2")
                },

                topExpenses = topExpenseCategories.Take(5).Select(e => new
                {
                    type = e.Type,
                    total = e.Total.ToString("N2"),
                    count = e.Count
                }).ToList()
            };

            await JSRuntime.InvokeVoidAsync("printAccountingDashboard", dashboardData);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error printing dashboard: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("window.print");
        }
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
