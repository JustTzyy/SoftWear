@page "/cashier/dashboard"
@layout IT13_Final.Components.Layout.Cashier.Cashier
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Data.IUserService UserService
@inject IT13_Final.Services.Data.ISalesService SalesService
@inject IT13_Final.Services.Data.IReturnsService ReturnsService
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@using System.Linq
@implements IDisposable

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">@GetGreeting(), @(AuthState.CurrentUser?.FullName ?? "Cashier")!</h1>
        <p class="welcome-date">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>
    <div class="header-actions">
        <button class="action-btn" @onclick="PrintDashboard" title="Print Dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>
    </div>
</div>

@* Search and Date Filters *@
<div class="dashboard-filters">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" id="dashboard-search-input" class="search-input" placeholder="Search transactions, products..." @bind="searchTerm" @bind:event="oninput" @bind:after="HandleSearchInput" @onkeypress="HandleSearchKeyPress" />
        @if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            <button class="clear-search-btn" @onclick="HandleClearSearch" title="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
    <div class="date-filters">
        <select class="date-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
            <option value="thisyear">This Year</option>
        </select>
        <input type="text" 
               class="date-input" 
               value="@(startDate?.ToString("MM/dd/yyyy"))" 
               placeholder="mm/dd/yyyy"
               @onchange="HandleFromDateChange" />
        <span class="date-separator">to</span>
        <input type="text" 
               class="date-input" 
               value="@(endDate?.ToString("MM/dd/yyyy"))" 
               placeholder="mm/dd/yyyy"
               @onchange="HandleToDateChange" />
        @if (HasActiveDateFilters)
        {
            <button class="clear-btn" @onclick="ClearDateFilter" title="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
</div>

@if (showSecurityAlert)
{
    <div class="security-alert-overlay" @onclick="HandleLater">
        <div class="security-alert-modal" @onclick:stopPropagation>
            <div class="security-alert-header">
                <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="M9 12l2 2 4-4"></path>
                </svg>
                <span>Security Alert</span>
                <button class="alert-close" @onclick="HandleLater">Ã—</button>
            </div>
            <div class="security-alert-body">
                <p>You are currently using a default password. For security reasons, please change your password immediately.</p>
            </div>
            <div class="security-alert-footer">
                <button class="btn-secondary" @onclick="HandleLater">Later</button>
                <button class="btn-primary" @onclick="HandleChangePassword">Change Password</button>
            </div>
        </div>
    </div>
}

@if (isLoading)
{
    <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading dashboard...</p>
    </div>
}
else
{
    @* Key Performance KPIs *@
    @if (showKpiSection)
    {
    <div class="kpi-row">
        <div class="kpi-card kpi-sales" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                    <rect x="7" y="7" width="10" height="10" rx="1"></rect>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Orders</span>
                <span class="kpi-value">@stats.TotalSales</span>
                <span class="kpi-trend trend-up">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    <span>All transactions</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-revenue" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Revenue</span>
                <span class="kpi-value">â‚±@stats.TotalRevenue.ToString("N0")</span>
                <span class="kpi-trend trend-up">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    <span>Gross sales</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-returns" @onclick='() => Nav.NavigateTo("/cashier/returns_report")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Returns</span>
                <span class="kpi-value">@stats.TotalReturns</span>
                <span class="kpi-trend">
                    <span>Processed returns</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-today" @onclick='() => Nav.NavigateTo("/cashier/Sales")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Today's Sales</span>
                <span class="kpi-value">@stats.TodaySales</span>
                <span class="kpi-trend trend-up">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    <span>â‚±@stats.TodayRevenue.ToString("N0") earned</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-avg" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="20" x2="12" y2="10"></line>
                    <line x1="18" y1="20" x2="18" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="16"></line>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Avg Transaction</span>
                <span class="kpi-value">â‚±@averageTransactionValue.ToString("N0")</span>
                <span class="kpi-trend">
                    <span>Per order value</span>
                </span>
            </div>
        </div>
    </div>
    }

    @* Main Charts Row *@
    @if (showSalesChart || showPaymentChart)
    {
    <div class="charts-grid">
        @* Sales Trend Chart *@
        @if (showSalesChart)
        {
        <div class="chart-card chart-wide" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>
            <div class="chart-header">
                <h3>Daily Sales Trend</h3>
                <span class="chart-subtitle">Revenue over selected period</span>
            </div>
            <div class="chart-body">
                <svg class="line-chart" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                    @if (salesData.Any() && salesData.Any(d => d.Amount > 0))
                    {
                        var maxAmount = salesData.Max(d => d.Amount);
                        var chartHeight = 220.0;
                        var chartWidth = 700.0;
                        var dataCount = salesData.Count;
                        var pointSpacing = chartWidth / Math.Max(dataCount - 1, 1);

                        @* Draw gradient fill under line *@
                        var fillPath = "M 60,240 ";
                        var linePath = "M ";
                        for (int i = 0; i < salesData.Count; i++)
                        {
                            var item = salesData[i];
                            var x = 60 + (i * pointSpacing);
                            var y = maxAmount > 0 ? 240 - ((double)item.Amount / (double)maxAmount) * chartHeight : 240;
                            
                            if (i == 0)
                            {
                                linePath += $"{x},{y} ";
                                fillPath += $"L {x},{y} ";
                            }
                            else
                            {
                                linePath += $"L {x},{y} ";
                                fillPath += $"L {x},{y} ";
                            }
                        }
                        fillPath += $"L {60 + (salesData.Count - 1) * pointSpacing},240 Z";

                        <defs>
                            <linearGradient id="salesGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#1e3a5f;stop-opacity:0.3" />
                                <stop offset="100%" style="stop-color:#1e3a5f;stop-opacity:0" />
                            </linearGradient>
                        </defs>

                        <path d="@fillPath" fill="url(#salesGradient)" />
                        <path d="@linePath" fill="none" stroke="#1e3a5f" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />

                        @* Data points *@
                        @for (int i = 0; i < salesData.Count; i++)
                        {
                            var item = salesData[i];
                            var x = 60 + (i * pointSpacing);
                            var y = maxAmount > 0 ? 240 - ((double)item.Amount / (double)maxAmount) * chartHeight : 240;
                            
                            if (item.Amount > 0 && (i == 0 || i == salesData.Count - 1 || i % 5 == 0))
                            {
                                <circle cx="@x" cy="@y" r="5" fill="#1e3a5f" stroke="#fff" stroke-width="2" class="data-point" />
                            }
                        }

                        @* X-axis labels *@
                        @for (int i = 0; i < salesData.Count; i += Math.Max(1, salesData.Count / 6))
                        {
                            var item = salesData[i];
                            var x = 60 + (i * pointSpacing);
                            @((MarkupString)$"<text x=\"{x}\" y=\"265\" font-size=\"10\" fill=\"#6b7280\" text-anchor=\"middle\">{item.Date.ToString("MMM d")}</text>")
                        }

                        @* Y-axis labels *@
                        @for (int i = 0; i <= 4; i++)
                        {
                            var value = maxAmount * (4 - i) / 4.0m;
                            var y = 20 + (i * chartHeight / 4);
                            @((MarkupString)$"<text x=\"55\" y=\"{y + 4}\" font-size=\"10\" fill=\"#6b7280\" text-anchor=\"end\">â‚±{value:N0}</text>")
                            <line x1="60" y1="@y" x2="760" y2="@y" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4"/>
                        }
                    }
                    else
                    {
                        @: <text x="400" y="150" font-size="14" fill="#9ca3af" text-anchor="middle">No sales data available for this period</text>
                    }
                </svg>
            </div>
        </div>
        }

        @* Payment Method Breakdown *@
        @if (showPaymentChart)
        {
        <div class="chart-card" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>
            <div class="chart-header">
                <h3>Payment Methods</h3>
                <span class="chart-subtitle">Distribution by type</span>
            </div>
            <div class="chart-body">
                @if (paymentMethodStats.Any())
                {
                    <div class="payment-breakdown">
                        @foreach (var method in paymentMethodStats)
                        {
                            <div class="payment-item">
                                <div class="payment-header">
                                    <span class="payment-name">@method.PaymentMethod</span>
                                    <span class="payment-percent">@method.Percentage.ToString("F0")%</span>
                                </div>
                                <div class="payment-bar">
                                    <div class="payment-fill @(method.PaymentMethod.ToLower() == "cash" ? "fill-cash" : "fill-digital")" 
                                         style="width: @method.Percentage%"></div>
                                </div>
                                <div class="payment-details">
                                    <span>@method.Count transactions</span>
                                    <span>â‚±@method.TotalAmount.ToString("N0")</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <p>No payment data available</p>
                    </div>
                }
            </div>
        </div>
        }
    </div>
    }

    @* Peak Hours Chart *@
    @if (showPeakHours)
    {
    <div class="peak-hours-section">
        <div class="chart-card full-width" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>
            <div class="chart-header">
                <h3>Peak Sales Hours</h3>
                <span class="chart-subtitle">Sales activity by hour of the day</span>
            </div>
            <div class="chart-body">
                <svg class="bar-chart" viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                    @if (hourlySalesData.Any() && hourlySalesData.Any(d => d.Count > 0))
                    {
                        var maxCount = hourlySalesData.Max(d => d.Count);
                        var chartHeight = 200.0;
                        var chartWidth = 700.0;
                        var barSpacing = chartWidth / 24.0;
                        var barWidth = Math.Max(4, barSpacing * 0.7);

                        @for (int i = 0; i < hourlySalesData.Count; i++)
                        {
                            var item = hourlySalesData[i];
                            var barHeight = maxCount > 0 ? (item.Count / (double)maxCount) * chartHeight : 0;
                            var xPos = 50 + (i * barSpacing) + (barSpacing / 2) - (barWidth / 2);
                            var yPos = chartHeight - barHeight + 30;
                            var intensity = item.Count > 0 ? Math.Min(1.0, (double)item.Count / maxCount + 0.3) : 0.15;

                            <rect x="@xPos" y="@yPos" width="@barWidth" height="@barHeight"
                                  fill="@(item.Count > 0 ? $"rgba(30, 58, 95, {intensity})" : "#e5e7eb")" rx="3" class="hour-bar" />

                            @if (i % 3 == 0 || item.Count == maxCount)
                            {
                                @((MarkupString)$"<text x=\"{xPos + barWidth / 2}\" y=\"{chartHeight + 50}\" font-size=\"10\" fill=\"#6b7280\" text-anchor=\"middle\">{item.Hour}:00</text>")
                            }

                            @if (item.Count > 0 && item.Count == maxCount)
                            {
                                @((MarkupString)$"<text x=\"{xPos + barWidth / 2}\" y=\"{yPos - 8}\" font-size=\"10\" fill=\"#1e3a5f\" text-anchor=\"middle\" font-weight=\"600\">{item.Count}</text>")
                            }
                        }

                        @* Legend *@
                        <rect x="650" y="10" width="12" height="12" fill="#1e3a5f" rx="2" />
                        @: <text x="667" y="20" font-size="10" fill="#6b7280">Sales Count</text>
                    }
                    else
                    {
                        @: <text x="400" y="140" font-size="14" fill="#9ca3af" text-anchor="middle">No hourly sales data available</text>
                    }
                </svg>
            </div>
        </div>
    </div>
    }

    @* Bottom Section: Lists *@
    @if (showTopProducts || showRecentTransactions || showInsights || showReturnsOverview)
    {
    <div class="bottom-grid">
        @* Top Selling Products *@
        @if (showTopProducts)
        {
        <div class="list-card">
            <div class="list-header">
                <h3>Top Selling Products</h3>
                <button class="view-all-btn" @onclick='() => Nav.NavigateTo("/cashier/Sales")'>Sell Now</button>
            </div>
            <div class="list-body">
                @if (topSellingProducts.Any())
                {
                    @foreach (var (product, index) in topSellingProducts.Take(5).Select((p, i) => (p, i)))
                    {
                        <div class="list-item">
                            <span class="rank-badge rank-@(index + 1)">@(index + 1)</span>
                            <div class="item-info">
                                <span class="item-name">@product.ProductName</span>
                                <span class="item-detail">@product.VariantName â€¢ @product.TotalQuantity units</span>
                            </div>
                            <span class="item-value">â‚±@product.TotalRevenue.ToString("N0")</span>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <p>No sales data available</p>
                    </div>
                }
            </div>
        </div>
        }

        @* Recent Transactions *@
        @if (showRecentTransactions)
        {
        <div class="list-card">
            <div class="list-header">
                <h3>Recent Transactions</h3>
                <button class="view-all-btn" @onclick='() => Nav.NavigateTo("/cashier/sales_report")'>View All</button>
            </div>
            <div class="list-body">
                @if (recentTransactions.Any())
                {
                    @foreach (var transaction in recentTransactions.Take(5))
                    {
                        <div class="list-item transaction-item">
                            <div class="transaction-avatar">@GetTransactionInitials(transaction.SaleNumber)</div>
                            <div class="item-info">
                                <span class="item-name">@transaction.SaleNumber</span>
                                <span class="item-detail">@transaction.Timestamps.ToString("MMM d, h:mm tt")</span>
                            </div>
                            <div class="transaction-right">
                                <span class="item-value">â‚±@transaction.Amount.ToString("N0")</span>
                                <span class="payment-tag @(transaction.PaymentMethod.ToLower() == "cash" ? "tag-cash" : "tag-digital")">@transaction.PaymentMethod</span>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <p>No recent transactions</p>
                    </div>
                }
            </div>
        </div>
        }

        @* Performance Insights *@
        @if (showInsights)
        {
        <div class="list-card insights-card">
            <div class="list-header">
                <h3>ðŸ’¡ Performance Insights</h3>
            </div>
            <div class="list-body">
                <div class="insights-grid">
                    <div class="insight-box">
                        <span class="insight-label">Avg Transaction</span>
                        <span class="insight-value">â‚±@averageTransactionValue.ToString("N2")</span>
                    </div>
                    <div class="insight-box">
                        <span class="insight-label">Best Hour</span>
                        <span class="insight-value">@bestHour</span>
                    </div>
                    <div class="insight-box">
                        <span class="insight-label">Top Product</span>
                        <span class="insight-value small">@(topSellingProducts.FirstOrDefault()?.ProductName ?? "N/A")</span>
                    </div>
                    <div class="insight-box">
                        <span class="insight-label">Preferred Payment</span>
                        <span class="insight-value">@preferredPayment</span>
                    </div>
                </div>
                
                @if (topSellingProducts.Any())
                {
                    <div class="recommendations">
                        <h4>Recommendations</h4>
                        <ul>
                            <li>Focus on <strong>@topSellingProducts.First().ProductName</strong> - top seller with @topSellingProducts.First().TotalQuantity units</li>
                            @if (!string.IsNullOrEmpty(bestHour) && bestHour != "N/A")
                            {
                                <li>Peak hour is <strong>@bestHour</strong> - prepare for rush!</li>
                            }
                            @{
                                var cashPct = paymentMethodStats.FirstOrDefault(p => p.PaymentMethod == "Cash")?.Percentage ?? 0;
                            }
                            @if (cashPct > 70)
                            {
                                <li>Most customers prefer <strong>Cash</strong> - keep change ready</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
        }

        @* Returns Trend *@
        @if (showReturnsOverview)
        {
        <div class="list-card">
            <div class="list-header">
                <h3>Returns Overview</h3>
                <button class="view-all-btn" @onclick='() => Nav.NavigateTo("/cashier/returns_report")'>View All</button>
            </div>
            <div class="list-body">
                <div class="returns-summary">
                    <div class="returns-stat">
                        <span class="returns-number">@stats.TotalReturns</span>
                        <span class="returns-label">Total Returns</span>
                    </div>
                    <div class="returns-stat">
                        <span class="returns-number">@stats.TodayReturns</span>
                        <span class="returns-label">Today</span>
                    </div>
                    <div class="returns-stat">
                        <span class="returns-number rate">@((stats.TotalSales > 0 ? ((decimal)stats.TotalReturns / stats.TotalSales * 100) : 0).ToString("F1"))%</span>
                        <span class="returns-label">Return Rate</span>
                    </div>
                </div>
                <div class="returns-chart">
                    <svg viewBox="0 0 300 100" preserveAspectRatio="xMidYMid meet">
                        @if (returnsData.Any() && returnsData.Any(d => d.Count > 0))
                        {
                            var maxRet = returnsData.Max(d => d.Count);
                            var dataCount = returnsData.Count;
                            var barW = 260.0 / Math.Max(dataCount, 1);

                            @for (int i = 0; i < returnsData.Count; i++)
                            {
                                var item = returnsData[i];
                                var barH = maxRet > 0 ? (item.Count / (double)maxRet) * 60 : 0;
                                var x = 20 + (i * barW);
                                var y = 80 - barH;

                                <rect x="@x" y="@y" width="@Math.Max(2, barW - 2)" height="@barH" fill="@(item.Count > 0 ? "#ef4444" : "#f3f4f6")" rx="2" />
                            }
                        }
                        else
                        {
                            @: <text x="150" y="50" font-size="11" fill="#9ca3af" text-anchor="middle">No returns in period</text>
                        }
                    </svg>
                </div>
            </div>
        </div>
        }
    </div>
    }

    @* No Results Message *@
    @if (!string.IsNullOrWhiteSpace(searchTerm) && !showKpiSection && !showSalesChart && !showPaymentChart && !showPeakHours && !showTopProducts && !showRecentTransactions && !showInsights && !showReturnsOverview)
    {
        <div class="no-results-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5;">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <h3 style="margin: 0 0 8px; color: #374151;">No results found</h3>
            <p style="margin: 0; color: #6b7280;">No dashboard sections match "<strong>@searchTerm</strong>"</p>
            <button class="filter-btn" style="margin-top: 16px;" @onclick="HandleClearSearch">Clear Search</button>
        </div>
    }
}

@code {
    private bool showSecurityAlert = false;
    private bool isLoading = true;
    private IT13_Final.Services.Data.DashboardStatsModel stats = new();
    private List<IT13_Final.Services.Data.DailySalesData> salesData = new();
    private List<IT13_Final.Services.Data.DailyReturnsData> returnsData = new();
    private List<IT13_Final.Services.Data.TopSellingProductModel> topSellingProducts = new();
    private List<IT13_Final.Services.Data.PaymentMethodStatsModel> paymentMethodStats = new();
    private List<IT13_Final.Services.Data.RecentTransactionModel> recentTransactions = new();
    private List<IT13_Final.Services.Data.HourlySalesData> hourlySalesData = new();
    private decimal averageTransactionValue = 0;
    private string bestHour = "N/A";
    private string preferredPayment = "N/A";

    // Search and Filter variables
    private string searchTerm = string.Empty;
    private string selectedDateRange = "";
    private DateTime? startDate = null;
    private DateTime? endDate = null;

    private bool HasActiveDateFilters => !string.IsNullOrEmpty(selectedDateRange) || startDate.HasValue || endDate.HasValue;
    private System.Threading.Timer? _searchTimer;

    // Search visibility flags
    private bool showKpiSection => IsSearchMatch("order", "revenue", "return", "today", "sales", "transaction", "average");
    private bool showSalesChart => IsSearchMatch("daily", "sales", "trend", "chart", "revenue");
    private bool showPaymentChart => IsSearchMatch("payment", "method", "cash", "credit", "card", "gcash");
    private bool showPeakHours => IsSearchMatch("peak", "hour", "time", "activity", "busy");
    private bool showTopProducts => IsSearchMatch("top", "selling", "product", "best") || topSellingProducts.Any();
    private bool showRecentTransactions => IsSearchMatch("recent", "transaction", "history") || recentTransactions.Any();
    private bool showInsights => IsSearchMatch("insight", "performance", "average", "best");
    private bool showReturnsOverview => IsSearchMatch("return", "refund", "overview", "rate");

    private bool IsSearchMatch(params string[] keywords)
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return true;
        
        var searchLower = searchTerm.ToLowerInvariant();
        return keywords.Any(k => k.Contains(searchLower) || searchLower.Contains(k));
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12) return "Good morning";
        if (hour < 17) return "Good afternoon";
        return "Good evening";
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckPasswordChangeRequired();
        await LoadDashboardData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupSearchInputFilter", "dashboard-search-input");
        }
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var cashierUserId = AuthState.CurrentUser?.Id ?? 0;
            if (cashierUserId > 0)
            {
                var days = GetDaysFromDateRange();
                
                stats = await SalesService.GetDashboardStatsAsync(cashierUserId);
                salesData = await SalesService.GetDailySalesDataAsync(cashierUserId, days);
                returnsData = await ReturnsService.GetDailyReturnsDataAsync(cashierUserId, days);
                topSellingProducts = await SalesService.GetTopSellingProductsAsync(cashierUserId, 10);
                paymentMethodStats = await SalesService.GetPaymentMethodStatsAsync(cashierUserId);
                recentTransactions = await SalesService.GetRecentTransactionsAsync(cashierUserId, 5);
                hourlySalesData = await SalesService.GetHourlySalesDataAsync(cashierUserId);
                averageTransactionValue = await SalesService.GetAverageTransactionValueAsync(cashierUserId);

                // Calculate best hour and preferred payment
                var bestHourData = hourlySalesData.OrderByDescending(h => h.Count).FirstOrDefault();
                bestHour = bestHourData != null && bestHourData.Count > 0 ? $"{bestHourData.Hour}:00" : "N/A";
                
                var preferredPaymentData = paymentMethodStats.OrderByDescending(p => p.Count).FirstOrDefault();
                preferredPayment = preferredPaymentData?.PaymentMethod ?? "N/A";

                FilterDataByDateRange();
                CalculateStatsFromFilteredData();

                if (!string.IsNullOrWhiteSpace(searchTerm))
                {
                    ApplySearchFilter();
                }
            }
        }
        catch (Exception ex)
        {
            stats = new IT13_Final.Services.Data.DashboardStatsModel();
            salesData = new List<IT13_Final.Services.Data.DailySalesData>();
            returnsData = new List<IT13_Final.Services.Data.DailyReturnsData>();
            topSellingProducts = new List<IT13_Final.Services.Data.TopSellingProductModel>();
            paymentMethodStats = new List<IT13_Final.Services.Data.PaymentMethodStatsModel>();
            recentTransactions = new List<IT13_Final.Services.Data.RecentTransactionModel>();
            hourlySalesData = new List<IT13_Final.Services.Data.HourlySalesData>();
            averageTransactionValue = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private int GetDaysFromDateRange()
    {
        if (startDate.HasValue && endDate.HasValue)
        {
            return Math.Max(1, (endDate.Value - startDate.Value).Days + 1);
        }
        return 30;
    }

    private void FilterDataByDateRange()
    {
        if (!startDate.HasValue || !endDate.HasValue)
            return;

        var start = startDate.Value.Date;
        var end = endDate.Value.Date;

        salesData = salesData.Where(d => d.Date.Date >= start && d.Date.Date <= end).ToList();
        returnsData = returnsData.Where(d => d.Date.Date >= start && d.Date.Date <= end).ToList();
        recentTransactions = recentTransactions.Where(t => t.Timestamps.Date >= start && t.Timestamps.Date <= end).ToList();
    }

    private void CalculateStatsFromFilteredData()
    {
        if (!startDate.HasValue || !endDate.HasValue)
            return;

        var start = startDate.Value.Date;
        var end = endDate.Value.Date;

        stats.TotalSales = salesData.Sum(d => d.Count);
        stats.TotalRevenue = salesData.Sum(d => d.Amount);
        stats.TotalReturns = returnsData.Sum(d => d.Count);

        var endDateSalesData = salesData.FirstOrDefault(d => d.Date.Date == end);
        stats.TodaySales = endDateSalesData?.Count ?? 0;
        stats.TodayRevenue = endDateSalesData?.Amount ?? 0;

        var endDateReturnsData = returnsData.FirstOrDefault(d => d.Date.Date == end);
        stats.TodayReturns = endDateReturnsData?.Count ?? 0;
    }

    private void ApplySearchFilter()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return;

        var searchLower = searchTerm.ToLowerInvariant();

        if (topSellingProducts.Any())
        {
            topSellingProducts = topSellingProducts
                .Where(p => p.ProductName.ToLowerInvariant().Contains(searchLower) ||
                           p.VariantName.ToLowerInvariant().Contains(searchLower))
                .ToList();
        }

        if (recentTransactions.Any())
        {
            recentTransactions = recentTransactions
                .Where(t => t.SaleNumber.ToLowerInvariant().Contains(searchLower) ||
                           t.PaymentMethod.ToLowerInvariant().Contains(searchLower))
                .ToList();
        }
    }

    private async Task CheckPasswordChangeRequired()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                showSecurityAlert = await UserService.MustChangePasswordAsync(AuthState.CurrentUser.Id);
                StateHasChanged();
            }
            catch
            {
                showSecurityAlert = false;
            }
        }
    }

    private void HandleLater()
    {
        showSecurityAlert = false;
        StateHasChanged();
    }

    private void HandleChangePassword()
    {
        showSecurityAlert = false;
        Nav.NavigateTo("/cashier/settings?tab=password");
        StateHasChanged();
    }

    private void HandleSearchInput()
    {
        var filtered = System.Text.RegularExpressions.Regex.Replace(searchTerm, @"[^a-zA-Z0-9\s\-_]", "");
        if (filtered != searchTerm)
        {
            searchTerm = filtered;
        }
        
        _searchTimer?.Dispose();
        _searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    if (AuthState.CurrentUser != null && !string.IsNullOrWhiteSpace(searchTerm))
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "search",
                            "Dashboard",
                            $"Searched dashboard: {searchTerm}"
                        );
                    }
                }
                catch { }
                await LoadDashboardData();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadDashboardData();
        }
    }

    private async Task HandleClearSearch()
    {
        searchTerm = string.Empty;
        await LoadDashboardData();
        StateHasChanged();
    }

    private async void HandleDateRangeChange()
    {
        var today = DateTime.Today;
        switch (selectedDateRange)
        {
            case "":
                startDate = null;
                endDate = null;
                break;
            case "today":
                startDate = today;
                endDate = today;
                break;
            case "yesterday":
                startDate = today.AddDays(-1);
                endDate = today.AddDays(-1);
                break;
            case "last7days":
                startDate = today.AddDays(-6);
                endDate = today;
                break;
            case "last30days":
                startDate = today.AddDays(-29);
                endDate = today;
                break;
            case "thismonth":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "thisyear":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
        }

        try
        {
            if (AuthState.CurrentUser != null)
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "filter",
                    "Dashboard",
                    $"Date filter: {selectedDateRange}"
                );
            }
        }
        catch { }

        await LoadDashboardData();
        StateHasChanged();
    }

    private async void HandleFromDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            startDate = null;
        }
        else if (DateTime.TryParseExact(value, "MM/dd/yyyy", null, System.Globalization.DateTimeStyles.None, out var exactDate))
        {
            startDate = exactDate;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            startDate = date;
        }
        selectedDateRange = "";
        await LoadDashboardData();
        StateHasChanged();
    }

    private async void HandleToDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(value))
        {
            endDate = null;
        }
        else if (DateTime.TryParseExact(value, "MM/dd/yyyy", null, System.Globalization.DateTimeStyles.None, out var exactDate))
        {
            endDate = exactDate;
        }
        else if (DateTime.TryParse(value, out var date))
        {
            endDate = date;
        }
        selectedDateRange = "";
        await LoadDashboardData();
        StateHasChanged();
    }

    private async void ClearDateFilter()
    {
        selectedDateRange = "";
        startDate = null;
        endDate = null;
        await LoadDashboardData();
        StateHasChanged();
    }

    private string GetTransactionInitials(string saleNumber)
    {
        if (string.IsNullOrEmpty(saleNumber)) return "TX";
        return saleNumber.Length >= 2 ? saleNumber.Substring(0, 2).ToUpperInvariant() : saleNumber[0].ToString().ToUpperInvariant();
    }

    private async Task PrintDashboard()
    {
        try
        {
            if (AuthState.CurrentUser != null)
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "print",
                    "Dashboard",
                    "Printed dashboard report"
                );
            }

            var topProduct = topSellingProducts.FirstOrDefault();
            
            var dashboardData = new
            {
                title = "Cashier Dashboard Report",
                printedBy = AuthState.CurrentUser?.FullName ?? "Cashier",
                printedAt = DateTime.Now.ToString("MMMM dd, yyyy hh:mm tt"),
                dateRange = startDate.HasValue && endDate.HasValue 
                    ? $"{startDate?.ToString("MM/dd/yyyy")} - {endDate?.ToString("MM/dd/yyyy")}" 
                    : "All Time",
                
                stats = new
                {
                    totalSales = stats.TotalSales,
                    totalRevenue = stats.TotalRevenue.ToString("N2"),
                    totalReturns = stats.TotalReturns,
                    todaySales = stats.TodaySales,
                    todayRevenue = stats.TodayRevenue.ToString("N2"),
                    todayReturns = stats.TodayReturns
                },
                
                avgTransaction = averageTransactionValue.ToString("N2"),
                peakHour = bestHour,
                preferredPayment = preferredPayment,
                topProduct = topProduct?.ProductName ?? "N/A",
                
                topProducts = topSellingProducts.Select(p => new
                {
                    productName = p.ProductName,
                    variantName = p.VariantName,
                    totalQuantity = p.TotalQuantity,
                    totalRevenue = p.TotalRevenue.ToString("N2")
                }).ToArray(),
                
                paymentMethods = paymentMethodStats.Select(p => new
                {
                    paymentMethod = p.PaymentMethod,
                    count = p.Count,
                    totalAmount = p.TotalAmount.ToString("N2"),
                    percentage = (double)p.Percentage
                }).ToArray(),
                
                recentTransactions = recentTransactions.Select(t => new
                {
                    saleNumber = t.SaleNumber,
                    amount = t.Amount.ToString("N2"),
                    paymentMethod = t.PaymentMethod,
                    timestamps = t.Timestamps.ToString("yyyy-MM-ddTHH:mm:ss")
                }).ToArray()
            };

            await JSRuntime.InvokeVoidAsync("printCashierDashboard", dashboardData);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error printing dashboard: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to generate dashboard PDF. Please try again.");
        }
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
