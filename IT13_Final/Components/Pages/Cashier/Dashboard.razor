@page "/cashier/dashboard"
@layout IT13_Final.Components.Layout.Cashier.Cashier
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Data.IUserService UserService
@inject IT13_Final.Services.Data.ISalesService SalesService
@inject IT13_Final.Services.Data.IReturnsService ReturnsService
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@using System.Linq
@implements IDisposable

<h1 class="page-title">Dashboard</h1>

<div class="dashboard-search-filters">
    <div class="search-filters-row">
        <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text" class="search-input" placeholder="Search metrics, products, transactions..." value="@searchTerm" @oninput="HandleSearchInput" @onkeypress="HandleSearchKeyPress" />
        </div>
        <button class="refresh-btn" @onclick="PrintDashboard" title="Print Dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
            <span>Print</span>
        </button>
    </div>

    <div class="filters-section">
        <div class="filter-content">
            <div class="date-filters">
                <div class="date-range-dropdown">
                    <label>Quick Range</label>
                    <select class="date-range-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange">
                        <option value="">Custom</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last7days">Last 7 Days</option>
                        <option value="last30days">Last 30 Days</option>
                        <option value="thismonth">This Month</option>
                        <option value="thisyear">This Year</option>
                    </select>
                </div>
                <div class="date-filter">
                    <label>From</label>
                    <input type="date" class="date-input" value="@(startDate?.ToString("yyyy-MM-dd"))" max="@(endDate?.ToString("yyyy-MM-dd") ?? DateTime.Today.ToString("yyyy-MM-dd"))" @onchange="HandleFromDateChange" />
                </div>
                <div class="date-filter">
                    <label>To</label>
                    <input type="date" class="date-input" value="@(endDate?.ToString("yyyy-MM-dd"))" min="@(startDate?.ToString("yyyy-MM-dd"))" max="@DateTime.Today.ToString("yyyy-MM-dd")" @onchange="HandleToDateChange" />
                </div>
                <button class="clear-filter-btn" @onclick="ClearDateFilter" title="Clear Date Filter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <span>Clear</span>
                </button>
            </div>
        </div>
    </div>
</div>

@if (showSecurityAlert)
{
    <div class="security-alert-overlay" @onclick="HandleLater">
        <div class="security-alert-modal" @onclick:stopPropagation>
            <div class="security-alert-header">
                <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    <path d="M9 12l2 2 4-4"></path>
                </svg>
                <span>Security Alert</span>
                <button class="alert-close" @onclick="HandleLater">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="security-alert-body">
                <svg class="warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <p class="alert-message">You are currently using a default password. For security reasons, please change your password immediately.</p>
            </div>

            <div class="security-alert-footer">
                <button class="alert-btn later-btn" @onclick="HandleLater">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <span>Later</span>
                </button>
                <button class="alert-btn change-password-btn" @onclick="HandleChangePassword">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>  
                    </svg>
                    <span>Change Password</span>
                </button>
            </div>
        </div>
    </div>
}

@if (isLoading)
{
    <section class="card">
        <div style="text-align: center; padding: 40px; color: #6b6b6b;">Loading statistics...</div>
    </section>
}
else
{
@* Summary Cards - Row 1 *@
<div class="summary-cards-row">
    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <div class="card-icon orders-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <rect x="7" y="7" width="10" height="10" rx="1"></rect>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Orders</div>
            <div class="card-value">@stats.TotalSales</div>
            <div class="card-trend trend-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>Total sales transactions</span>
            </div>
        </div>
    </div>

    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/returns_report")' title="View Returns Report">
        <div class="card-icon approved-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Returns</div>
            <div class="card-value">@stats.TotalReturns</div>
            <div class="card-trend trend-neutral">
                <span>Total return transactions</span>
            </div>
        </div>
    </div>

    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <div class="card-icon revenue-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Revenue</div>
            <div class="card-value">â‚±@stats.TotalRevenue.ToString("N0")</div>
            <div class="card-trend trend-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>Total revenue earned</span>
            </div>
        </div>
    </div>

    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <div class="card-icon today-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Today's Sales</div>
            <div class="card-value">@stats.TodaySales</div>
            <div class="card-trend trend-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>Sales today</span>
            </div>
        </div>
    </div>
</div>

@* Summary Cards - Row 2 *@
<div class="summary-cards-row">
    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <div class="card-icon month-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Today's Revenue</div>
            <div class="card-value">â‚±@stats.TodayRevenue.ToString("N0")</div>
            <div class="card-trend trend-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>Revenue today</span>
            </div>
        </div>
    </div>

    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/returns_report")' title="View Returns Report">
        <div class="card-icon returns-today-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                <path d="M21 3v5h-5"></path>
                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                <path d="M3 21v-5h5"></path>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Today's Returns</div>
            <div class="card-value">@stats.TodayReturns</div>
            <div class="card-trend trend-neutral">
                <span>Returns today</span>
            </div>
        </div>
    </div>

    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <div class="card-icon net-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="2" x2="12" y2="22"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Net Sales</div>
            <div class="card-value">@(stats.TotalSales - stats.TotalReturns)</div>
            <div class="card-trend trend-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>Sales minus returns</span>
            </div>
        </div>
    </div>

    <div class="summary-card clickable-metric" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <div class="card-icon avg-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="20" x2="12" y2="10"></line>
                <line x1="18" y1="20" x2="18" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="16"></line>
            </svg>
        </div>
        <div class="card-content">
            <div class="card-label">Avg Daily Revenue</div>
            <div class="card-value">â‚±@((stats.TotalRevenue / Math.Max(1, (DateTime.Today - DateTime.Today.AddDays(-30)).Days)).ToString("N0"))</div>
            <div class="card-trend trend-up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
                <span>Last 30 days average</span>
            </div>
        </div>
    </div>
</div>

    <div class="charts-row">
    <section class="card clickable-card" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <h2 class="card-title">Sales Trend</h2>
        <div class="subtext">Daily sales count and revenue</div>
        <div class="chart-container" @onclick:stopPropagation>
            <svg class="bar-chart" viewBox="0 0 800 380" preserveAspectRatio="xMidYMid meet">
                @if (salesData.Any() && salesData.Any(d => d.Count > 0 || d.Amount > 0))
                {
                    var maxCount = salesData.Max(d => d.Count);
                    var maxAmount = salesData.Max(d => d.Amount);
                    var chartHeight = 250.0;
                    var chartWidth = 700.0;
                    var dataCount = salesData.Count;
                    var barSpacing = chartWidth / Math.Max(dataCount, 1);
                    var barWidth = Math.Max(2.0, barSpacing * 0.6);
                    var maxValue = Math.Max(maxCount, (double)maxAmount / 1000); // Normalize for display

                    @for (int i = 0; i < salesData.Count; i++)
                    {
                        var item = salesData[i];
                        var barHeight = maxValue > 0 ? (item.Count / maxValue) * chartHeight : 0;
                        var yPos = chartHeight - barHeight + 25;
                        var xPos = 50 + (i * barSpacing) + (barSpacing / 2) - (barWidth / 2);
                        var revenueBarHeight = maxValue > 0 ? ((double)item.Amount / 1000 / maxValue) * chartHeight : 0;
                        var revenueYPos = chartHeight - revenueBarHeight + 25;

                        <g>
                            <rect x="@xPos" y="@yPos" width="@barWidth" height="@barHeight"
                                  fill="#A2B9CD" rx="2" class="chart-bar"/>
                            <rect x="@(xPos + barWidth + 1)" y="@revenueYPos" width="@barWidth" height="@revenueBarHeight"
                                  fill="#304D6D" rx="2" class="chart-bar"/>
                            @* Show value on top of bar if it has data *@
                            @if (item.Count > 0)
                            {
                                @: <text x="@(xPos + barWidth / 2)" y="@(yPos - 3)" font-size="9" fill="#304D6D" text-anchor="middle" font-weight="bold">@item.Count</text>
                            }
                            @* Show date label - only for bars with data or every 5 days to avoid crowding *@
                            @if (item.Count > 0 || item.Amount > 0 || i % 5 == 0 || i == salesData.Count - 1 || i == 0)
                            {
                                var dateLabelY = chartHeight + 55;
                                var dateText = item.Date.ToString("MMM dd");
                                var labelX = xPos + barWidth;
                                @((MarkupString)$"<text x=\"{labelX}\" y=\"{dateLabelY}\" font-size=\"9\" fill=\"#304D6D\" text-anchor=\"middle\" font-weight=\"500\">{dateText}</text>")
                            }
                        </g>
                    }

                    @* Y-axis labels *@
                    @for (int i = 0; i <= 5; i++)
                    {
                        var value = maxValue * (5 - i) / 5.0;
                        var y = chartHeight - (chartHeight * i / 5.0) + 25;
                        @: <text x="45" y="@(y + 4)" font-size="10" fill="#6b6b6b" text-anchor="end">@((int)value)</text>
                    }

                    @* Y-axis title *@
                    @: <text x="20" y="@(chartHeight / 2 + 25)" font-size="11" fill="#304D6D" text-anchor="middle" transform="rotate(-90 20 @(chartHeight / 2 + 25))">Count / Amount</text>

                    @* Axes *@
                    <line x1="50" y1="25" x2="50" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
                    <line x1="50" y1="@(chartHeight + 25)" x2="750" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>

                    @* X-axis title *@
                    @: <text x="400" y="@(chartHeight + 85)" font-size="12" fill="#304D6D" text-anchor="middle" font-weight="600">Date</text>
                }
                else
                {
                    @: <text x="400" y="150" font-size="14" fill="#6b6b6b" text-anchor="middle">No sales data available</text>
                }
            </svg>
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 12px; background: #A2B9CD; border-radius: 4px;"></div>
                    <span style="font-size: 12px; color: #6b6b6b;">Sales Count</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 12px; background: #304D6D; border-radius: 4px;"></div>
                    <span style="font-size: 12px; color: #6b6b6b;">Revenue (scaled)</span>
                </div>
            </div>
        </div>
    </section>

    <section class="card clickable-card" @onclick='() => Nav.NavigateTo("/cashier/returns_report")' title="View Returns Report">
        <h2 class="card-title">Returns Trend</h2>
        <div class="subtext">Daily returns count</div>
        <div class="chart-container" @onclick:stopPropagation>
            <svg class="bar-chart" viewBox="0 0 800 380" preserveAspectRatio="xMidYMid meet">
                @if (returnsData.Any() && returnsData.Any(d => d.Count > 0))
                {
                    var maxCount = returnsData.Max(d => d.Count);
                    var chartHeight = 250.0;
                    var chartWidth = 700.0;
                    var dataCount = returnsData.Count;
                    var barSpacing = chartWidth / Math.Max(dataCount, 1);
                    var barWidth = Math.Max(2.0, barSpacing * 0.8);

                    @for (int i = 0; i < returnsData.Count; i++)
                    {
                        var item = returnsData[i];
                        var barHeight = maxCount > 0 ? (item.Count / (double)maxCount) * chartHeight : 0;
                        var yPos = chartHeight - barHeight + 25;
                        var xPos = 50 + (i * barSpacing) + (barSpacing / 2) - (barWidth / 2);

                        <g>
                            <rect x="@xPos" y="@yPos" width="@barWidth" height="@barHeight"
                                  fill="#82A0BC" rx="2" class="chart-bar"/>
                            @* Show value on top of bar if it has data *@
                            @if (item.Count > 0)
                            {
                                @: <text x="@(xPos + barWidth / 2)" y="@(yPos - 3)" font-size="9" fill="#304D6D" text-anchor="middle" font-weight="bold">@item.Count</text>
                            }
                            @* Show date label - only for bars with data or every 5 days to avoid crowding *@
                            @if (item.Count > 0 || i % 5 == 0 || i == returnsData.Count - 1 || i == 0)
                            {
                                var dateLabelY = chartHeight + 55;
                                var dateText = item.Date.ToString("MMM dd");
                                var labelX = xPos + barWidth / 2;
                                @((MarkupString)$"<text x=\"{labelX}\" y=\"{dateLabelY}\" font-size=\"9\" fill=\"#304D6D\" text-anchor=\"middle\" font-weight=\"500\">{dateText}</text>")
                            }
                        </g>
                    }

                    @* Y-axis labels *@
                    @for (int i = 0; i <= 5; i++)
                    {
                        var value = maxCount * (5 - i) / 5.0;
                        var y = chartHeight - (chartHeight * i / 5.0) + 25;
                        @: <text x="45" y="@(y + 4)" font-size="10" fill="#6b6b6b" text-anchor="end">@((int)value)</text>
                    }

                    @* Y-axis title *@
                    @: <text x="20" y="@(chartHeight / 2 + 25)" font-size="11" fill="#304D6D" text-anchor="middle" transform="rotate(-90 20 @(chartHeight / 2 + 25))">Returns Count</text>

                    @* Axes *@
                    <line x1="50" y1="25" x2="50" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
                    <line x1="50" y1="@(chartHeight + 25)" x2="750" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>

                    @* X-axis title *@
                    @: <text x="400" y="@(chartHeight + 85)" font-size="12" fill="#304D6D" text-anchor="middle" font-weight="600">Date</text>
                }
                else
                {
                    @: <text x="400" y="150" font-size="14" fill="#6b6b6b" text-anchor="middle">No returns data available</text>
                }
            </svg>
        </div>
    </section>
    </div>

    <div class="charts-row">
    <section class="card clickable-card" @onclick='() => Nav.NavigateTo("/cashier/Sales")' title="Go to Sales (POS)">
        <h2 class="card-title">Top Selling Products</h2>
        <div class="subtext">Your best performing products</div>
        @if (topSellingProducts.Any())
        {
            <div class="top-products-list">
                    @for (int i = 0; i < topSellingProducts.Count; i++)
                    {
                        var product = topSellingProducts[i];
                        <div class="product-rank-item clickable-product" @onclick='() => Nav.NavigateTo("/cashier/Sales")' @onclick:stopPropagation title="Go to Sales (POS)">
                            <div class="rank-badge rank-@(i + 1)">@(i + 1)</div>
                            <div class="product-info">
                                <div class="product-name">@product.ProductName - @product.VariantName</div>
                                <div class="product-stats">
                                    <span>Qty: @product.TotalQuantity</span>
                                    <span>â€¢</span>
                                    <span>Revenue: â‚±@product.TotalRevenue.ToString("N2")</span>
                                    <span>â€¢</span>
                                    <span>Sales: @product.SaleCount</span>
                                </div>
                            </div>
                        </div>
                    }
            </div>
        }
        else
        {
            <div style="text-align: center; padding: 40px; color: #6b6b6b;">No sales data available</div>
        }
    </section>

    <section class="card clickable-card" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <h2 class="card-title">Payment Method Breakdown</h2>
        <div class="subtext">Distribution of payment methods</div>
        @if (paymentMethodStats.Any())
        {
            <div class="payment-methods">
                @foreach (var method in paymentMethodStats)
                {
                    <div class="payment-method-item">
                        <div class="payment-method-header">
                            <span class="payment-method-name">@method.PaymentMethod</span>
                            <span class="payment-method-percentage">@method.Percentage.ToString("F1")%</span>
                        </div>
                        <div class="payment-method-bar">
                            <div class="payment-method-fill" style="width: @method.Percentage%; background: @(method.PaymentMethod == "Cash" ? "#A2B9CD" : "#304D6D");"></div>
                        </div>
                        <div class="payment-method-details">
                            <span>@method.Count transactions</span>
                            <span>â‚±@method.TotalAmount.ToString("N2")</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div style="text-align: center; padding: 40px; color: #6b6b6b;">No payment data available</div>
        }
    </section>
    </div>

    <section class="card clickable-card" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
        <h2 class="card-title">Peak Sales Hours</h2>
        <div class="subtext">Sales activity by hour of the day</div>
        <div class="chart-container" @onclick:stopPropagation>
            <svg class="bar-chart" viewBox="0 0 800 380" preserveAspectRatio="xMidYMid meet">
                @if (hourlySalesData.Any() && hourlySalesData.Any(d => d.Count > 0))
                {
                    var maxCount = hourlySalesData.Max(d => d.Count);
                    var chartHeight = 250.0;
                    var chartWidth = 700.0;
                    var barSpacing = chartWidth / 24.0;
                    var barWidth = Math.Max(2.0, barSpacing * 0.7);

                    @for (int i = 0; i < hourlySalesData.Count; i++)
                    {
                        var item = hourlySalesData[i];
                        var barHeight = maxCount > 0 ? (item.Count / (double)maxCount) * chartHeight : 0;
                        var yPos = chartHeight - barHeight + 25;
                        var xPos = 50 + (i * barSpacing) + (barSpacing / 2) - (barWidth / 2);

                        <g>
                            <rect x="@xPos" y="@yPos" width="@barWidth" height="@barHeight"
                                  fill="@(item.Count > 0 ? "#82A0BC" : "#E0E0E0")" rx="2" class="chart-bar"/>
                            @* Show value on top of bar if it has data *@
                            @if (item.Count > 0)
                            {
                                @: <text x="@(xPos + barWidth / 2)" y="@(yPos - 3)" font-size="9" fill="#304D6D" text-anchor="middle" font-weight="bold">@item.Count</text>
                            }
                            @* Show hour label - every 3 hours or for bars with data to avoid crowding *@
                            @if (item.Count > 0 || i % 3 == 0 || i == 0 || i == hourlySalesData.Count - 1 || item.Hour == 6 || item.Hour == 12 || item.Hour == 18)
                            {
                                var hourLabelX = xPos + barWidth / 2;
                                var hourLabelY = chartHeight + 60;
                                var hourRotation = -45;
                                var hourText = $"{item.Hour}:00";
                                @((MarkupString)$"<text x=\"{hourLabelX}\" y=\"{hourLabelY}\" font-size=\"9\" fill=\"#304D6D\" text-anchor=\"middle\" transform=\"rotate({hourRotation} {hourLabelX} {hourLabelY})\" font-weight=\"500\">{hourText}</text>")
                            }
                        </g>
                    }

                    @* Y-axis labels *@
                    @for (int i = 0; i <= 5; i++)
                    {
                        var value = maxCount * (5 - i) / 5.0;
                        var y = chartHeight - (chartHeight * i / 5.0) + 25;
                        @: <text x="45" y="@(y + 4)" font-size="10" fill="#6b6b6b" text-anchor="end">@((int)value)</text>
                    }

                    @* Y-axis title *@
                    @: <text x="20" y="@(chartHeight / 2 + 25)" font-size="11" fill="#304D6D" text-anchor="middle" transform="rotate(-90 20 @(chartHeight / 2 + 25))">Sales Count</text>

                    @* Axes *@
                    <line x1="50" y1="25" x2="50" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>
                    <line x1="50" y1="@(chartHeight + 25)" x2="750" y2="@(chartHeight + 25)" stroke="#304D6D" stroke-width="2"/>

                    @* X-axis title *@
                    @: <text x="400" y="@(chartHeight + 90)" font-size="12" fill="#304D6D" text-anchor="middle" font-weight="600">Hour of Day (0-23)</text>
                }
                else
                {
                    @: <text x="400" y="150" font-size="14" fill="#6b6b6b" text-anchor="middle">No hourly sales data available</text>
                }
            </svg>
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 12px; background: #82A0BC; border-radius: 4px;"></div>
                    <span style="font-size: 12px; color: #6b6b6b;">Sales Count</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 20px; height: 12px; background: #E0E0E0; border-radius: 4px;"></div>
                    <span style="font-size: 12px; color: #6b6b6b;">No Sales</span>
                </div>
            </div>
        </div>
    </section>

@* Customer Order Table *@
<section class="card table-card">
    <div class="table-header">
        <h2 class="card-title">Customer Order</h2>
        <button class="refresh-btn" @onclick="LoadDashboardData" title="Refresh">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>
    </div>
    <div class="subtext">Recent sales transactions</div>
    @if (recentTransactions.Any())
    {
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Profile</th>
                        <th>Sale Number</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var transaction in recentTransactions)
                    {
                        <tr class="table-row clickable-transaction" @onclick='() => Nav.NavigateTo("/cashier/sales_report")' title="View Sales Report">
                            <td>
                                <div class="profile-avatar-small">@GetTransactionInitials(transaction.SaleNumber)</div>
                            </td>
                            <td class="transaction-number-cell">@transaction.SaleNumber</td>
                            <td>@transaction.Timestamps.ToString("MMM dd, yyyy")</td>
                            <td>
                                <span class="status-badge status-delivered">@transaction.PaymentMethod</span>
                            </td>
                            <td class="price-cell">â‚±@transaction.Amount.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div style="text-align: center; padding: 40px; color: #6b6b6b;">No recent transactions</div>
    }
</section>

        <section class="card">
            <h2 class="card-title">Performance Insights</h2>
            <div class="subtext">Key metrics and recommendations</div>
            <div class="insights-grid">
                <div class="insight-item">
                    <div class="insight-label">Average Transaction</div>
                    <div class="insight-value">â‚±@averageTransactionValue.ToString("N2")</div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Best Hour</div>
                    <div class="insight-value">
                        @{
                            var bestHourForInsight = hourlySalesData.OrderByDescending(h => h.Count).FirstOrDefault();
                            var bestHourText = bestHourForInsight != null && bestHourForInsight.Count > 0 ? $"{bestHourForInsight.Hour}:00" : "N/A";
                        }
                        @bestHourText
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Top Product</div>
                    <div class="insight-value" style="font-size: 12px;">
                        @{
                            var topProduct = topSellingProducts.FirstOrDefault();
                            var topProductText = topProduct != null ? $"{topProduct.ProductName}" : "N/A";
                        }
                        @topProductText
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-label">Preferred Payment</div>
                    <div class="insight-value">
                        @{
                            var preferredPayment = paymentMethodStats.OrderByDescending(p => p.Count).FirstOrDefault();
                            var preferredPaymentText = preferredPayment != null ? preferredPayment.PaymentMethod : "N/A";
                        }
                        @preferredPaymentText
                    </div>
                </div>
            </div>
            @if (topSellingProducts.Any())
            {
                <div class="recommendations">
                    <h4 style="margin: 16px 0 8px 0; color: #304D6D; font-size: 14px; font-weight: 600;">ðŸ’¡ Recommendations</h4>
                    <ul class="recommendations-list">
                        <li>Focus on promoting <strong>@topSellingProducts.First().ProductName</strong> - your top seller with @topSellingProducts.First().TotalQuantity units sold</li>
                        @if (topSellingProducts.Count >= 3)
                        {
                            <li>Consider bundling your top 3 products for increased sales</li>
                        }
                        @{
                            var bestHourForRecommendation = hourlySalesData.OrderByDescending(h => h.Count).FirstOrDefault();
                        }
                        @if (bestHourForRecommendation != null && bestHourForRecommendation.Count > 0)
                        {
                            <li>Peak sales hour is @bestHourForRecommendation.Hour:00 - ensure adequate stock during this time</li>
                        }
                        @{
                            var cashPercentage = paymentMethodStats.FirstOrDefault(p => p.PaymentMethod == "Cash")?.Percentage ?? 0;
                        }
                        @if (cashPercentage > 70)
                        {
                            <li>Most customers prefer Cash - keep sufficient change on hand</li>
                        }
                    </ul>
                </div>
            }
        </section>
}

@code {
    private bool showSecurityAlert = false;
    private bool isLoading = true;
    private IT13_Final.Services.Data.DashboardStatsModel stats = new();
    private List<IT13_Final.Services.Data.DailySalesData> salesData = new();
    private List<IT13_Final.Services.Data.DailyReturnsData> returnsData = new();
    private List<IT13_Final.Services.Data.TopSellingProductModel> topSellingProducts = new();
    private List<IT13_Final.Services.Data.PaymentMethodStatsModel> paymentMethodStats = new();
    private List<IT13_Final.Services.Data.RecentTransactionModel> recentTransactions = new();
    private List<IT13_Final.Services.Data.HourlySalesData> hourlySalesData = new();
    private decimal averageTransactionValue = 0;

    // Search and Filter variables
    private string searchTerm = string.Empty;
    private string selectedDateRange = "last30days";
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;
    private System.Threading.Timer? _searchTimer;

    protected override async Task OnInitializedAsync()
    {
        await CheckPasswordChangeRequired();
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var cashierUserId = AuthState.CurrentUser?.Id ?? 0;
            if (cashierUserId > 0)
            {
                // Calculate days based on date range
                var days = GetDaysFromDateRange();
                
                stats = await SalesService.GetDashboardStatsAsync(cashierUserId);
                salesData = await SalesService.GetDailySalesDataAsync(cashierUserId, days);
                returnsData = await ReturnsService.GetDailyReturnsDataAsync(cashierUserId, days);
                topSellingProducts = await SalesService.GetTopSellingProductsAsync(cashierUserId, 10);
                paymentMethodStats = await SalesService.GetPaymentMethodStatsAsync(cashierUserId);
                recentTransactions = await SalesService.GetRecentTransactionsAsync(cashierUserId, 5);
                hourlySalesData = await SalesService.GetHourlySalesDataAsync(cashierUserId);
                averageTransactionValue = await SalesService.GetAverageTransactionValueAsync(cashierUserId);

                // Filter data by date range
                FilterDataByDateRange();

                // Apply search filter if needed
                if (!string.IsNullOrWhiteSpace(searchTerm))
                {
                    ApplySearchFilter();
                }
            }
        }
        catch (Exception ex)
        {
            // Handle error silently or log it
            stats = new IT13_Final.Services.Data.DashboardStatsModel();
            salesData = new List<IT13_Final.Services.Data.DailySalesData>();
            returnsData = new List<IT13_Final.Services.Data.DailyReturnsData>();
            topSellingProducts = new List<IT13_Final.Services.Data.TopSellingProductModel>();
            paymentMethodStats = new List<IT13_Final.Services.Data.PaymentMethodStatsModel>();
            recentTransactions = new List<IT13_Final.Services.Data.RecentTransactionModel>();
            hourlySalesData = new List<IT13_Final.Services.Data.HourlySalesData>();
            averageTransactionValue = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private int GetDaysFromDateRange()
    {
        if (startDate.HasValue && endDate.HasValue)
        {
            return Math.Max(1, (endDate.Value - startDate.Value).Days + 1);
        }
        return 30; // Default to 30 days
    }

    private void FilterDataByDateRange()
    {
        if (!startDate.HasValue || !endDate.HasValue)
            return;

        var start = startDate.Value.Date;
        var end = endDate.Value.Date;

        // Filter sales data
        salesData = salesData
            .Where(d => d.Date.Date >= start && d.Date.Date <= end)
            .ToList();

        // Filter returns data
        returnsData = returnsData
            .Where(d => d.Date.Date >= start && d.Date.Date <= end)
            .ToList();

        // Filter recent transactions
        recentTransactions = recentTransactions
            .Where(t => t.Timestamps.Date >= start && t.Timestamps.Date <= end)
            .ToList();
    }

    private void ApplySearchFilter()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return;

        var searchLower = searchTerm.ToLowerInvariant();

        // Filter top selling products
        if (topSellingProducts.Any())
        {
            topSellingProducts = topSellingProducts
                .Where(p => p.ProductName.ToLowerInvariant().Contains(searchLower) ||
                           p.VariantName.ToLowerInvariant().Contains(searchLower))
                .ToList();
        }

        // Filter recent transactions
        if (recentTransactions.Any())
        {
            recentTransactions = recentTransactions
                .Where(t => t.SaleNumber.ToLowerInvariant().Contains(searchLower) ||
                           t.PaymentMethod.ToLowerInvariant().Contains(searchLower))
                .ToList();
        }
    }

    private async Task CheckPasswordChangeRequired()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                showSecurityAlert = await UserService.MustChangePasswordAsync(AuthState.CurrentUser.Id);
                StateHasChanged();
            }
            catch
            {
                showSecurityAlert = false;
            }
        }
    }

    private void HandleLater()
    {
        showSecurityAlert = false;
        StateHasChanged();
    }

    private void HandleChangePassword()
    {
        showSecurityAlert = false;
        Nav.NavigateTo("/cashier/settings?tab=password");
        StateHasChanged();
    }

    private void HandleSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        _searchTimer?.Dispose();
        _searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                try
                {
                    if (AuthState.CurrentUser != null && !string.IsNullOrWhiteSpace(searchTerm))
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "search",
                            "Dashboard",
                            $"Searched dashboard: {searchTerm}"
                        );
                    }
                }
                catch { }
                await LoadDashboardData();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadDashboardData();
        }
    }

    private async void HandleDateRangeChange()
    {
        var today = DateTime.Today;
        var previousRange = selectedDateRange;
        switch (selectedDateRange)
        {
            case "today":
                startDate = today;
                endDate = today;
                break;
            case "yesterday":
                startDate = today.AddDays(-1);
                endDate = today.AddDays(-1);
                break;
            case "last7days":
                startDate = today.AddDays(-7);
                endDate = today;
                break;
            case "last30days":
                startDate = today.AddDays(-30);
                endDate = today;
                break;
            case "thismonth":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "thisyear":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
            default:
                // Custom - keep current dates
                break;
        }
        try
        {
            if (AuthState.CurrentUser != null && !string.IsNullOrEmpty(selectedDateRange))
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "filter",
                    "Dashboard",
                    $"Changed date range filter to: {selectedDateRange}"
                );
            }
        }
        catch { }
        LoadDashboardData();
    }

    private async void HandleFromDateChange(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            startDate = date;
            if (endDate.HasValue && startDate > endDate)
            {
                endDate = startDate;
            }
            selectedDateRange = ""; // Reset to Custom
            
            try
            {
                if (AuthState.CurrentUser != null)
                {
                    await HistoryService.LogAsync(
                        AuthState.CurrentUser.Id,
                        "filter",
                        "Dashboard",
                        $"Changed start date filter to: {date:MMM dd, yyyy}"
                    );
                }
            }
            catch { }
            
            LoadDashboardData();
        }
    }

    private async void HandleToDateChange(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            endDate = date;
            if (startDate.HasValue && endDate < startDate)
            {
                startDate = endDate;
            }
            selectedDateRange = ""; // Reset to Custom
            
            try
            {
                if (AuthState.CurrentUser != null)
                {
                    await HistoryService.LogAsync(
                        AuthState.CurrentUser.Id,
                        "filter",
                        "Dashboard",
                        $"Changed end date filter to: {date:MMM dd, yyyy}"
                    );
                }
            }
            catch { }
            
            LoadDashboardData();
        }
    }

    private async void ClearDateFilter()
    {
        selectedDateRange = "last30days";
        startDate = DateTime.Today.AddDays(-30);
        endDate = DateTime.Today;
        
        try
        {
            if (AuthState.CurrentUser != null)
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "filter",
                    "Dashboard",
                    "Cleared date filters - reset to Last 30 Days"
                );
            }
        }
        catch { }
        
        LoadDashboardData();
    }

    private string GetTransactionInitials(string saleNumber)
    {
        if (string.IsNullOrEmpty(saleNumber)) return "U";
        return saleNumber.Length >= 2 ? saleNumber.Substring(0, 2).ToUpperInvariant() : saleNumber[0].ToString().ToUpperInvariant();
    }

    private async Task PrintDashboard()
    {
        try
        {
            if (AuthState.CurrentUser != null)
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "print",
                    "Dashboard",
                    "Printed dashboard report"
                );
            }

            // Calculate days from date range
            var days = GetDaysFromDateRange();
            
            // Prepare dashboard data for PDF
            var dashboardData = new
            {
                stats = new
                {
                    totalSales = stats.TotalSales,
                    totalRevenue = (double)stats.TotalRevenue,
                    totalReturns = stats.TotalReturns,
                    todaySales = stats.TodaySales,
                    todayRevenue = (double)stats.TodayRevenue,
                    todayReturns = stats.TodayReturns
                },
                salesData = salesData.Select(s => new
                {
                    date = s.Date.ToString("yyyy-MM-dd"),
                    count = s.Count,
                    revenue = (double)s.Amount
                }).ToArray(),
                returnsData = returnsData.Select(r => new
                {
                    date = r.Date.ToString("yyyy-MM-dd"),
                    count = r.Count
                }).ToArray(),
                topProducts = topSellingProducts.Select(p => new
                {
                    productName = p.ProductName,
                    variantName = p.VariantName,
                    totalQuantity = p.TotalQuantity,
                    totalRevenue = (double)p.TotalRevenue,
                    saleCount = p.SaleCount
                }).ToArray(),
                paymentMethods = paymentMethodStats.Select(p => new
                {
                    paymentMethod = p.PaymentMethod,
                    count = p.Count,
                    totalAmount = (double)p.TotalAmount,
                    percentage = (double)p.Percentage
                }).ToArray(),
                recentTransactions = recentTransactions.Select(t => new
                {
                    saleNumber = t.SaleNumber,
                    amount = (double)t.Amount,
                    paymentMethod = t.PaymentMethod,
                    timestamps = t.Timestamps.ToString("yyyy-MM-ddTHH:mm:ss")
                }).ToArray(),
                hourlySalesData = hourlySalesData.Select(h => new
                {
                    hour = h.Hour,
                    count = h.Count
                }).ToArray(),
                averageTransactionValue = (double)averageTransactionValue,
                days = days
            };

            var fromDateStr = startDate?.ToString("MMM dd, yyyy") ?? "All Time";
            var toDateStr = endDate?.ToString("MMM dd, yyyy") ?? "Today";
            var userName = AuthState.CurrentUser?.FullName ?? "User";

            await JSRuntime.InvokeVoidAsync("generateAndPrintDashboard", dashboardData, userName, fromDateStr, toDateStr);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"Error printing dashboard: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Failed to generate dashboard PDF. Please try again.");
        }
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
