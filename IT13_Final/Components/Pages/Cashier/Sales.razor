@page "/cashier/Sales"
@layout IT13_Final.Components.Layout.Cashier.Cashier
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Data.IInventoryService InventoryService
@inject IT13_Final.Services.Data.IVariantService VariantService
@inject IT13_Final.Services.Data.ISalesService SalesService
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@using Microsoft.Data.SqlClient
@implements IDisposable

<h1 class="page-title">Point of Sale</h1>

<div class="pos-container">
    <!-- Left Side: Product Selection -->
    <div class="pos-products-section">
        <div class="search-filter-row">
            <div class="search-bar">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" placeholder="Search products..." value="@productSearchTerm" @oninput="HandleProductSearch" @onkeypress="HandleSearchKeyPress" />
            </div>
            <div class="filter-dropdown">
                <select class="filter-select" @bind="selectedFilter" @bind:after="HandleFilterChange">
                    <option value="all">All Products</option>
                    <option value="bestsellers">Best Sellers</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="stock-high">Stock: High to Low</option>
                    <option value="stock-low">Stock: Low to High</option>
                </select>
            </div>
        </div>

        <div class="products-grid">
            @if (isLoadingProducts)
            {
                <div class="loading-message">Loading products...</div>
            }
            else if (availableProducts.Count == 0)
            {
                <div class="empty-message">No products available</div>
            }
            else
            {
                @foreach (var product in availableProducts)
                {
                    <div class="product-card" @onclick="() => HandleProductClick(product)">
                        <div class="product-image-container" style="background-color: @(string.IsNullOrEmpty(product.ColorHexValue) ? "#F9F9F9" : product.ColorHexValue);">
                            @if (!string.IsNullOrEmpty(product.ProductImageBase64))
                            {
                                <img src="data:@(product.ImageContentType ?? "image/jpeg");base64,@product.ProductImageBase64" 
                                     alt="@product.ProductName" 
                                     class="product-image" />
                            }
                            else
                            {
                                <div class="product-image-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                </div>
                            }
                        </div>
                        <div class="product-info">
                            <div class="product-name">@product.ProductName</div>
                            <div class="product-variant">@product.VariantName</div>
                            @if (!string.IsNullOrEmpty(product.SizeName))
                            {
                                <div class="product-attr">Size: @product.SizeName</div>
                            }
                            @if (!string.IsNullOrEmpty(product.ColorName))
                            {
                                <div class="product-attr">
                                    Color: 
                                    @if (!string.IsNullOrEmpty(product.ColorHexValue))
                                    {
                                        <span class="color-dot" style="background-color: @product.ColorHexValue;"></span>
                                    }
                                    @product.ColorName
                                </div>
                            }
                            <div class="product-stock">Stock: @product.CurrentStock</div>
                            <div class="product-price">₱@((product.CostPrice ?? product.Price).ToString("N2"))</div>
                        </div>
                        <button class="add-to-cart-btn" @onclick:stopPropagation="true" @onclick="() => HandleAddToCart(product)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="9" cy="21" r="1"></circle>
                                <circle cx="20" cy="21" r="1"></circle>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                            </svg>
                        </button>
                    </div>
                }
            }
        </div>

        @if (totalPages > 1)
        {
            <div class="pagination">
                <button class="page-btn" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>

                @for (int i = 1; i <= totalPages; i++)
                {
                    var pageNum = i; // Capture loop variable for lambda
                    @if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                    {
                        <button class="page-btn @(i == currentPage ? "active" : "")" @onclick="() => GoToPage(pageNum)">
                            @i
                        </button>
                    }
                    else if (i == currentPage - 2 || i == currentPage + 2)
                    {
                        <span class="page-ellipsis">...</span>
                    }
                }

                <button class="page-btn" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        }
    </div>

    <!-- Right Side: Cart and Payment -->
    <div class="pos-cart-section">
        <div class="cart-header">
            <h2>Cart</h2>
            <button class="clear-cart-btn" @onclick="ClearCart" disabled="@(cartItems.Count == 0)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Clear
            </button>
        </div>

        <div class="cart-items">
            @if (cartItems.Count == 0)
            {
                <div class="empty-cart">Cart is empty</div>
            }
            else
            {
                @foreach (var item in cartItems)
                {
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">@item.ProductName - @item.VariantName</div>
                            @if (!string.IsNullOrEmpty(item.SizeName))
                            {
                                <div class="cart-item-attr">Size: @item.SizeName</div>
                            }
                            @if (!string.IsNullOrEmpty(item.ColorName))
                            {
                                <div class="cart-item-attr">
                                    Color: 
                                    @if (!string.IsNullOrEmpty(item.ColorHexValue))
                                    {
                                        <span class="color-dot-small" style="background-color: @item.ColorHexValue;"></span>
                                    }
                                    @item.ColorName
                                </div>
                            }
                            <div class="cart-item-price">₱@item.Price.ToString("N2") × @item.Quantity = ₱@item.Subtotal.ToString("N2")</div>
                        </div>
                        <div class="cart-item-actions">
                            <button class="qty-btn" @onclick="() => UpdateQuantity(item, -1)">-</button>
                            <span class="qty-display">@item.Quantity</span>
                            <button class="qty-btn" @onclick="() => UpdateQuantity(item, 1)" disabled="@(item.Quantity >= item.AvailableStock)">+</button>
                            <button class="remove-item-btn" @onclick="() => RemoveFromCart(item)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                }
            }
        </div>

        <div class="cart-summary">
            <div class="summary-row total">
                <span>Total:</span>
                <span>₱@cartSubtotal.ToString("N2")</span>
            </div>
        </div>

        <div class="payment-section">
            <div class="payment-method">
                <label>Payment Method</label>
                <select class="payment-select" @bind="selectedPaymentMethod">
                    <option value="Cash">Cash</option>
                    <option value="GCash">GCash</option>
                </select>
            </div>

            @if (selectedPaymentMethod == "Cash")
            {
                <div class="cash-payment">
                    <label>Amount Paid</label>
                    <input type="number" class="amount-input" @bind="amountPaid" @bind:event="oninput" step="0.01" min="0" />
                    @if (amountPaid > 0 && amountPaid >= cartSubtotal)
                    {
                        <div class="change-display">Change: ₱@((amountPaid - cartSubtotal).ToString("N2"))</div>
                    }
                </div>
            }

            @if (selectedPaymentMethod == "GCash")
            {
                <div class="gcash-payment">
                    <label>GCash Reference Number <span class="required">*</span></label>
                    <input type="text" class="reference-input" @bind="gcashReferenceNumber" @bind:event="oninput" placeholder="Enter GCash transaction reference" maxlength="100" />
                    <div class="gcash-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Enter the GCash transaction reference number from the customer's payment confirmation.</span>
                    </div>
                </div>
            }

            <button class="checkout-btn" @onclick="ProcessSale" disabled="@(cartItems.Count == 0 || (selectedPaymentMethod == "Cash" && amountPaid < cartSubtotal) || (selectedPaymentMethod == "GCash" && string.IsNullOrWhiteSpace(gcashReferenceNumber)))">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
                Complete Sale
            </button>
        </div>
    </div>
</div>

<!-- Add to Cart Modal -->
@if (showAddToCartModal)
{
    <div class="modal-overlay" @onclick="CloseAddToCartModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Add to Cart</h3>
                <button class="modal-close" @onclick="CloseAddToCartModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                @if (selectedProductForCart != null)
                {
                    <div class="modal-product-image-container" style="background-color: @(string.IsNullOrEmpty(selectedProductForCart.ColorHexValue) ? "#F9F9F9" : selectedProductForCart.ColorHexValue);">
                        @if (!string.IsNullOrEmpty(selectedProductForCart.ProductImageBase64))
                        {
                            <img src="data:@(selectedProductForCart.ImageContentType ?? "image/jpeg");base64,@selectedProductForCart.ProductImageBase64" 
                                 alt="@selectedProductForCart.ProductName" 
                                 class="modal-product-image" />
                        }
                        else
                        {
                            <div class="modal-product-image-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                            </div>
                        }
                    </div>
                    <div class="modal-product-info">
                        <div class="modal-product-name">@selectedProductForCart.ProductName</div>
                        <div class="modal-product-variant">@selectedProductForCart.VariantName</div>
                        <div class="modal-product-price">₱@((selectedProductForCart.CostPrice ?? selectedProductForCart.Price).ToString("N2"))</div>
                        <div class="modal-product-stock">Available: @selectedProductForCart.CurrentStock</div>
                    </div>

                    <div class="modal-form">
                        <div class="form-field">
                            <label>Quantity</label>
                            <div class="qty-input-group">
                                <button class="qty-btn" @onclick="() => AdjustModalQuantity(-1)">-</button>
                                <input type="number" class="qty-input" @bind="modalQuantity" @bind:event="oninput" min="1" max="@selectedProductForCart.CurrentStock" />
                                <button class="qty-btn" @onclick="() => AdjustModalQuantity(1)">+</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseAddToCartModal">Cancel</button>
                <button class="btn-primary" @onclick="ConfirmAddToCart" disabled="@(modalQuantity < 1 || modalQuantity > (selectedProductForCart?.CurrentStock ?? 0))">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>
}

@code {
    private int sellerUserId = 0;
    private string productSearchTerm = string.Empty;
    private string selectedFilter = "all";
    private List<IT13_Final.Services.Data.InventoryModel> availableProducts = new();
    private List<IT13_Final.Services.Data.InventoryModel> allProducts = new(); // Store all products for filtering
    private List<IT13_Final.Services.Data.TopSellingProductModel> topSellingProducts = new();
    private bool isLoadingProducts = true;
    private System.Threading.Timer? _searchTimer;
    private int currentPage = 1;
    private int pageSize = 6; // Show 6 products per page
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);

    private class CartItem
    {
        public int VariantId { get; set; }
        public int? SizeId { get; set; }
        public int? ColorId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public string VariantName { get; set; } = string.Empty;
        public string? SizeName { get; set; }
        public string? ColorName { get; set; }
        public string? ColorHexValue { get; set; }
        public decimal Price { get; set; }
        public int Quantity { get; set; }
        public decimal Subtotal => Price * Quantity;
        public int AvailableStock { get; set; }
    }

    private List<CartItem> cartItems = new();
    private decimal cartSubtotal => cartItems.Sum(item => item.Subtotal);
    // Customer pays the full cost price, deductions applied after transaction
    private decimal cartTotal => cartSubtotal; // Customer pays full amount
    private string selectedPaymentMethod = "Cash";
    private decimal amountPaid = 0;
    private string gcashReferenceNumber = string.Empty;

    private bool showAddToCartModal = false;
    private IT13_Final.Services.Data.InventoryModel? selectedProductForCart = null;
    private int modalQuantity = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadSellerUserId();
        if (sellerUserId > 0)
        {
            await LoadTopSellingProducts();
            await LoadProducts();
        }
    }

    private async Task LoadTopSellingProducts()
    {
        try
        {
            var cashierUserId = AuthState.CurrentUser?.Id ?? 0;
            if (cashierUserId > 0)
            {
                topSellingProducts = await SalesService.GetTopSellingProductsAsync(cashierUserId, 50); // Get top 50 for filtering
            }
        }
        catch
        {
            topSellingProducts = new List<IT13_Final.Services.Data.TopSellingProductModel>();
        }
    }

    private async Task LoadSellerUserId()
    {
        if (AuthState.CurrentUser != null)
        {
            try
            {
                const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
                using var conn = new SqlConnection(connectionString);
                await conn.OpenAsync();

                var sql = "SELECT user_id FROM dbo.tbl_users WHERE id = @UserId AND archived_at IS NULL";
                using var cmd = new SqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@UserId", AuthState.CurrentUser.Id);

                var result = await cmd.ExecuteScalarAsync();
                if (result != null && result != DBNull.Value)
                {
                    sellerUserId = Convert.ToInt32(result);
                }
            }
            catch
            {
                sellerUserId = 0;
            }
        }
    }

    private async Task LoadProducts()
    {
        isLoadingProducts = true;
        StateHasChanged();

        try
        {
            if (sellerUserId > 0)
            {
                // Load all products first (without pagination) for filtering
                allProducts = await InventoryService.GetInventoriesAsync(sellerUserId, productSearchTerm, 1, 10000);
                
                // Apply filter
                var filteredProducts = ApplyFilter(allProducts);
                
                // Apply pagination
                totalCount = filteredProducts.Count;
                availableProducts = filteredProducts
                    .Skip((currentPage - 1) * pageSize)
                    .Take(pageSize)
                    .ToList();
                
                // Adjust current page if it exceeds total pages
                if (currentPage > totalPages && totalPages > 0)
                {
                    currentPage = totalPages;
                    availableProducts = filteredProducts
                        .Skip((currentPage - 1) * pageSize)
                        .Take(pageSize)
                        .ToList();
                }
            }
        }
        catch
        {
            availableProducts = new List<IT13_Final.Services.Data.InventoryModel>();
            allProducts = new List<IT13_Final.Services.Data.InventoryModel>();
            totalCount = 0;
        }
        finally
        {
            isLoadingProducts = false;
            StateHasChanged();
        }
    }

    private List<IT13_Final.Services.Data.InventoryModel> ApplyFilter(List<IT13_Final.Services.Data.InventoryModel> products)
    {
        var filtered = products.ToList();

        switch (selectedFilter)
        {
            case "bestsellers":
                // Filter to show only best selling products
                var bestSellerVariantIds = topSellingProducts.Select(p => p.VariantId).ToHashSet();
                filtered = filtered.Where(p => bestSellerVariantIds.Contains(p.VariantId))
                    .OrderByDescending(p => 
                    {
                        var topProduct = topSellingProducts.FirstOrDefault(t => t.VariantId == p.VariantId);
                        return topProduct?.TotalQuantity ?? 0;
                    })
                    .ToList();
                break;

            case "price-low":
                filtered = filtered.OrderBy(p => p.Price).ToList();
                break;

            case "price-high":
                filtered = filtered.OrderByDescending(p => p.Price).ToList();
                break;

            case "stock-high":
                filtered = filtered.OrderByDescending(p => p.CurrentStock).ToList();
                break;

            case "stock-low":
                filtered = filtered.OrderBy(p => p.CurrentStock).ToList();
                break;

            case "all":
            default:
                // No additional filtering, just maintain current order
                break;
        }

        return filtered;
    }

    private async Task HandleFilterChange()
    {
        currentPage = 1;
        await LoadProducts();
        
        // Log filter change
        try
        {
            if (AuthState.CurrentUser != null)
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "filter",
                    "Sales",
                    $"Changed product filter to: {selectedFilter}"
                );
            }
        }
        catch { }
    }

    private void HandleProductSearch(ChangeEventArgs e)
    {
        productSearchTerm = e.Value?.ToString() ?? string.Empty;
        currentPage = 1; // Reset to first page on search
        _searchTimer?.Dispose();
        _searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadProducts();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            currentPage = 1; // Reset to first page on search
            await LoadProducts();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages && page != currentPage)
        {
            currentPage = page;
            await LoadProducts();
        }
    }

    private void HandleProductClick(IT13_Final.Services.Data.InventoryModel product)
    {
        selectedProductForCart = product;
        modalQuantity = 1;
        showAddToCartModal = true;
        StateHasChanged();
    }

    private void HandleAddToCart(IT13_Final.Services.Data.InventoryModel product)
    {
        HandleProductClick(product);
    }

    private void AdjustModalQuantity(int change)
    {
        if (selectedProductForCart != null)
        {
            var newQty = modalQuantity + change;
            if (newQty >= 1 && newQty <= selectedProductForCart.CurrentStock)
            {
                modalQuantity = newQty;
                StateHasChanged();
            }
        }
    }

    private void CloseAddToCartModal()
    {
        showAddToCartModal = false;
        selectedProductForCart = null;
        modalQuantity = 1;
        StateHasChanged();
    }

    private async Task ConfirmAddToCart()
    {
        if (selectedProductForCart != null && modalQuantity > 0 && modalQuantity <= selectedProductForCart.CurrentStock)
        {
            // Check if item already exists in cart
            var existingItem = cartItems.FirstOrDefault(item =>
                item.VariantId == selectedProductForCart.VariantId &&
                item.SizeId == selectedProductForCart.SizeId &&
                item.ColorId == selectedProductForCart.ColorId);

            if (existingItem != null)
            {
                // Update quantity if adding same item
                var newQty = existingItem.Quantity + modalQuantity;
                if (newQty <= existingItem.AvailableStock)
                {
                    existingItem.Quantity = newQty;
                }
            }
            else
            {
                // Store cost price (deductions will be applied in transaction calculations)
                var itemPrice = selectedProductForCart.CostPrice ?? selectedProductForCart.Price;
                
                cartItems.Add(new CartItem
                {
                    VariantId = selectedProductForCart.VariantId,
                    SizeId = selectedProductForCart.SizeId,
                    ColorId = selectedProductForCart.ColorId,
                    ProductName = selectedProductForCart.ProductName,
                    VariantName = selectedProductForCart.VariantName,
                    SizeName = selectedProductForCart.SizeName,
                    ColorName = selectedProductForCart.ColorName,
                    ColorHexValue = selectedProductForCart.ColorHexValue,
                    Price = itemPrice,
                    Quantity = modalQuantity,
                    AvailableStock = selectedProductForCart.CurrentStock
                });
            }

            CloseAddToCartModal();
            StateHasChanged();
        }
    }


    private void UpdateQuantity(CartItem item, int change)
    {
        var newQty = item.Quantity + change;
        if (newQty >= 1 && newQty <= item.AvailableStock)
        {
            item.Quantity = newQty;
            StateHasChanged();
        }
    }

    private void RemoveFromCart(CartItem item)
    {
        cartItems.Remove(item);
        StateHasChanged();
    }

    private void ClearCart()
    {
        cartItems.Clear();
        amountPaid = 0;
        gcashReferenceNumber = string.Empty;
        StateHasChanged();
    }

    private decimal CalculateTax(decimal amount)
    {
        // Calculate 12% tax
        return amount * 0.12m;
    }

    private decimal CalculateAdminFee(decimal amount)
    {
        // Calculate 2% admin fee
        return amount * 0.02m;
    }

    private decimal CalculateNetAmount(decimal grossAmount)
    {
        // Calculate net amount after deductions (for internal use only)
        // Net = grossAmount * (1 - 0.12 - 0.02) = grossAmount * 0.86
        // This is what the business receives after tax and admin fee deductions
        return grossAmount * 0.86m;
    }

    private async Task ProcessSale()
    {
        if (cartItems.Count == 0) return;
        if (selectedPaymentMethod == "Cash" && amountPaid < cartSubtotal) return;

        try
        {
            // Calculate change for cash payments
            var changeGiven = selectedPaymentMethod == "Cash" ? Math.Max(0, amountPaid - cartSubtotal) : 0;

            // Prepare sale items
            var saleItems = cartItems.Select(item => new IT13_Final.Services.Data.SaleItemModel
            {
                VariantId = item.VariantId,
                SizeId = item.SizeId,
                ColorId = item.ColorId,
                Quantity = item.Quantity,
                Price = item.Price,
                Subtotal = item.Subtotal
            }).ToList();

            // Create sale model
            var sale = new IT13_Final.Services.Data.CreateSaleModel
            {
                Items = saleItems,
                TotalAmount = cartSubtotal, // Customer pays full cost price
                PaymentMethod = selectedPaymentMethod,
                AmountPaid = selectedPaymentMethod == "Cash" ? amountPaid : cartSubtotal,
                ChangeGiven = changeGiven,
                ReferenceNumber = selectedPaymentMethod == "GCash" ? gcashReferenceNumber.Trim() : null,
                CashierUserId = AuthState.CurrentUser?.Id ?? 0
            };

            // Process the sale
            var saleResult = await SalesService.CreateSaleAsync(sale);

            if (saleResult != null && saleResult.SaleId.HasValue && saleResult.SaleId.Value > 0)
            {
                // Log sale creation to history
                try
                {
                    if (AuthState.CurrentUser != null)
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "create",
                            "Sales",
                            $"Created sale: {saleResult.SaleNumber} - Total: ₱{cartSubtotal:N2} - Payment: {selectedPaymentMethod}"
                        );
                    }
                }
                catch { }

                // Prepare receipt data before clearing cart
                var receiptData = new
                {
                    saleNumber = saleResult.SaleNumber,
                    dateTime = DateTime.Now.ToString("MMM dd, yyyy HH:mm:ss"),
                    cashierName = AuthState.CurrentUser?.FullName ?? "Cashier",
                    items = cartItems.Select(item => new
                    {
                        productName = item.ProductName,
                        variantName = item.VariantName,
                        sizeName = item.SizeName ?? "",
                        colorName = item.ColorName ?? "",
                        quantity = item.Quantity,
                        subtotal = item.Subtotal
                    }).ToArray(),
                    totalAmount = cartSubtotal,
                    paymentMethod = selectedPaymentMethod,
                    amountPaid = selectedPaymentMethod == "Cash" ? amountPaid : cartSubtotal,
                    changeGiven = changeGiven,
                    referenceNumber = selectedPaymentMethod == "GCash" ? gcashReferenceNumber.Trim() : null
                };

                // Success - clear cart and show success message
                cartItems.Clear();
                amountPaid = 0;
                gcashReferenceNumber = string.Empty;
                StateHasChanged();

                // Print receipt automatically
                try
                {
                    await JSRuntime.InvokeVoidAsync("printReceipt", receiptData);
                    // Log print action
                    if (AuthState.CurrentUser != null)
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "print",
                            "Sales",
                            $"Printed receipt for sale: {saleResult.SaleNumber}"
                        );
                    }
                }
                catch (Exception printEx)
                {
                    System.Diagnostics.Debug.WriteLine($"Error printing receipt: {printEx.Message}");
                    // Continue even if printing fails
                }

                await JSRuntime.InvokeVoidAsync("alert", $"Sale completed successfully! Sale Number: {saleResult.SaleNumber}");
                
                // Reload products to update stock
                await LoadProducts();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to process sale. Please try again.");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error processing sale: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error processing sale: {ex.Message}");
        }
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
