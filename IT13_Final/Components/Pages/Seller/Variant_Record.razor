@page "/seller/Variant"
@layout IT13_Final.Components.Layout.Seller.Seller
@inject IT13_Final.Services.Data.IVariantService VariantService
@inject IT13_Final.Services.Data.IColorService ColorService
@inject IT13_Final.Services.Data.ISizeService SizeService
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@implements IDisposable
@using System.ComponentModel.DataAnnotations

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">Variant Records</h1>
        <p class="welcome-date">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>
    <div class="header-actions">
        <button class="action-btn print-btn" @onclick="PrintVariantRecords" title="Print records">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M6 9V2h12v7"></path>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>
    </div>
</div>

@* Search and Date Filters *@
<div class="dashboard-filters">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
        </svg>
        <input type="text" class="search-input" placeholder="Search by name, product, or price..." @bind="searchTerm" @bind:event="oninput" @bind:after="OnSearchInput" />
        @if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            <button class="clear-search-btn" @onclick="ClearSearch" title="Clear search">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        }
    </div>
    <div class="date-filters">
        <select class="date-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
            <option value="thisyear">This Year</option>
        </select>
        <input type="date" 
               class="date-input" 
               value="@(filterStartDate?.ToString("yyyy-MM-dd"))" 
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleStartDateChange" />
        <span class="date-separator">to</span>
        <input type="date" 
               class="date-input" 
               value="@(filterEndDate?.ToString("yyyy-MM-dd"))" 
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleEndDateChange" />
        <button class="filter-btn" @onclick="ApplyDateFilter">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Apply
        </button>
        @if (HasActiveDateFilters)
        {
            <button class="clear-btn" @onclick="ClearDateFilter" title="Clear filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"></path>
                    <path d="m6 6 12 12"></path>
                </svg>
            </button>
        }
    </div>
</div>

@if (showSuccessMessage && !string.IsNullOrEmpty(successMessageText))
{
    <div class="success-banner">
        <svg class="success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <span>@successMessageText</span>
    </div>
}

@* Variant List Card *@
<div class="content-card">
    <div class="card-header">
        <div class="card-title-section">
            <h3 class="card-title">Variant List</h3>
            <span class="card-subtitle">@totalCount total variants</span>
        </div>
        <div class="card-actions">
            <button class="card-action-btn secondary" @onclick="NavigateToArchive">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="20" height="5" x="2" y="3" rx="1"></rect>
                    <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
                    <path d="M10 12h4"></path>
                </svg>
                <span>Archive</span>
            </button>
            <button class="card-action-btn primary" @onclick="HandleAddVariant">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                <span>Add Variant</span>
            </button>
        </div>
    </div>
    
    <div class="card-body">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Date Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="6" class="loading-cell">Loading...</td>
                    </tr>
                }
                else if (Variants.Count == 0)
                {
                    <tr>
                        <td colspan="6" class="empty-cell">No Variants found</td>
                    </tr>
                }
                else
                {
                    @foreach (var variant in Variants)
                    {
                        <tr class="clickable-row" @onclick="() => HandleRowClick(variant.Id)">
                            <td>@variant.Id</td>
                            <td class="variant-name">@variant.Name</td>
                            <td>@variant.ProductName</td>
                            <td>₱@variant.Price.ToString("N2")</td>
                            <td>@variant.DateCreated.ToString("MMM dd, yyyy")</td>
                            <td class="actions-cell" @onclick:stopPropagation>
                                <button class="action-btn edit-btn" @onclick="() => HandleEdit(variant.Id)" title="Edit variant">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                                        <path d="m15 5 4 4"></path>
                                    </svg>
                                </button>
                                <button class="action-btn delete-btn" @onclick="() => HandleDelete(variant.Id)" title="Archive">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect width="20" height="5" x="2" y="3" rx="1"></rect>
                                        <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path>
                                        <path d="M10 12h4"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (totalPages > 1)
    {
        <div class="pagination">
            <button class="page-btn" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)" title="Previous page">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6"></path>
                </svg>
            </button>

            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNum = i;
                @if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                {
                    <button class="page-btn @(i == currentPage ? "active" : "")" @onclick="() => GoToPage(pageNum)">
                        @i
                    </button>
                }
                else if (i == currentPage - 2 || i == currentPage + 2)
                {
                    <span class="page-ellipsis">...</span>
                }
            }

            <button class="page-btn" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)" title="Next page">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m9 18 6-6-6-6"></path>
                </svg>
            </button>
        </div>
    }
</div>

@* Variant Details Modal *@
@if (showVariantDetails && variantDetails != null)
{
    <div class="modal-overlay" @onclick="CloseVariantDetails">
        <div class="modal-container" @onclick:stopPropagation>
            <div class="modal-header">
                <div class="modal-title">
                    <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span>Variant Details</span>
                </div>
                <button class="modal-close" @onclick="CloseVariantDetails" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                    <span class="modal-close-text">Close</span>
                </button>
            </div>

            <div class="modal-content-variant">
                @if (!string.IsNullOrEmpty(variantDetails.ProductImageBase64))
                {
                    <div class="product-image-large" style="background-color: @(selectedColorHex ?? "#FFFFFF");">
                        <img src="data:image/jpeg;base64,@variantDetails.ProductImageBase64" alt="@variantDetails.ProductName" />
                    </div>
                }
                else
                {
                    <div class="product-image-large no-image" style="background-color: @(selectedColorHex ?? "#F5F7FA");">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                }
                <div class="details-list">
                    <div class="detail-item">
                        <span class="detail-label">VARIANT NAME:</span>
                        <span class="detail-value">@variantDetails.Name</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">PRODUCT:</span>
                        <span class="detail-value">@variantDetails.ProductName</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">PRICE:</span>
                        <span class="detail-value">₱@variantDetails.Price.ToString("N2")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">COST PRICE:</span>
                        <span class="detail-value">@(variantDetails.CostPrice.HasValue ? $"₱{variantDetails.CostPrice.Value:N2}" : "N/A")</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">SIZES:</span>
                        <span class="detail-value">
                            @if (variantDetails.SizeNames.Count > 0)
                            {
                                @string.Join(", ", variantDetails.SizeNames)
                            }
                            else
                            {
                                <span>None</span>
                            }
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">COLORS:</span>
                        <span class="detail-value">
                            @if (variantDetails.ColorNames.Count > 0 && variantDetails.ColorHexValues.Count > 0)
                            {
                                <div class="color-swatches-container">
                                    @for (int i = 0; i < variantDetails.ColorNames.Count && i < variantDetails.ColorHexValues.Count; i++)
                                    {
                                        var colorHex = variantDetails.ColorHexValues[i];
                                        var colorName = variantDetails.ColorNames[i];
                                        <div class="color-swatch-item @(selectedColorHex == colorHex ? "selected" : "")" 
                                             @onclick="() => SelectColor(colorHex)"
                                             style="cursor: pointer;">
                                            <span class="color-swatch-large" style="background-color: @colorHex;"></span>
                                            <span class="color-name">@colorName</span>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <span>None</span>
                            }
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">STATUS:</span>
                        <span class="detail-value status-badge @(variantDetails.Status.ToUpper() == "ACTIVE" ? "active" : "inactive")">@variantDetails.Status</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">DATE CREATED:</span>
                        <span class="detail-value">@variantDetails.DateCreated.ToString("M/d/yyyy")</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Add Variant Modal *@
@if (showAddVariantModal)
{
    <div class="modal-overlay" @onclick="CloseAddVariantModal">
        <div class="add-variant-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h2 class="modal-title-text">Add Variant</h2>
                <button class="modal-close-btn" @onclick="CloseAddVariantModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <EditForm EditContext="@_addVariantEditContext" OnValidSubmit="SaveVariantAsync">
                    <DataAnnotationsValidator />
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="field-label">Variant Name</label>
                            <InputText class="form-input" @bind-Value="_addVariantModel.Name" placeholder="e.g., Standard Variant" />
                            <ValidationMessage For="@(() => _addVariantModel.Name)" />
                        </div>
                        <div class="form-field product-select-field">
                            <label class="field-label">Product</label>
                            <InputSelect class="form-input" @bind-Value="_addVariantModel.ProductId" @bind-Value:after="OnProductSelected">
                                <option value="0">Select a product</option>
                                @foreach (var product in products)
                                {
                                    <option value="@product.Id">@product.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => _addVariantModel.ProductId)" />
                            @if (_addVariantModel.ProductId > 0)
                            {
                                var selectedProduct = products.FirstOrDefault(p => p.Id == _addVariantModel.ProductId);
                                @if (selectedProduct != null && !string.IsNullOrEmpty(selectedProduct.ImageBase64))
                                {
                                    <div class="product-image-preview">
                                        <img src="data:image/jpeg;base64,@selectedProduct.ImageBase64" alt="@selectedProduct.Name" />
                                    </div>
                                }
                                else if (selectedProduct != null)
                                {
                                    <div class="product-image-preview no-image">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                            <polyline points="21 15 16 10 5 21"></polyline>
                                        </svg>
                                    </div>
                                }
                            }
                        </div>
                        <div class="form-field">
                            <label class="field-label">Price</label>
                            <InputNumber class="form-input" @bind-Value="_addVariantModel.Price" @bind-Value:after="OnAddPriceChanged" placeholder="0.00" step="0.01" />
                            <ValidationMessage For="@(() => _addVariantModel.Price)" />
                        </div>
                        <div class="form-field">
                            <label class="field-label">Cost Price</label>
                            <InputNumber class="form-input" @bind-Value="_addVariantModel.CostPrice" placeholder="0.00" step="0.01" readonly />
                        </div>
                        <div class="form-field full-width">
                            <label class="field-label">Sizes</label>
                            <div class="checkbox-group">
                                @foreach (var size in activeSizes)
                                {
                                    <label class="checkbox-item">
                                        <input type="checkbox" 
                                               checked="@_addSelectedSizeIds.Contains(size.Id)"
                                               @onchange="@((ChangeEventArgs e) => ToggleSize(size.Id, (bool)(e.Value ?? false)))" />
                                        <span>@size.Name</span>
                                    </label>
                                }
                            </div>
                        </div>
                        <div class="form-field full-width">
                            <label class="field-label">Colors</label>
                            <div class="checkbox-group color-checkbox-group">
                                @foreach (var color in activeColors)
                                {
                                    <label class="checkbox-item color-checkbox-item">
                                        <input type="checkbox" 
                                               checked="@_addSelectedColorIds.Contains(color.Id)"
                                               @onchange="@((ChangeEventArgs e) => ToggleColor(color.Id, (bool)(e.Value ?? false)))" />
                                        <span class="color-swatch" style="background-color: @color.HexValue;"></span>
                                        <span>@color.Name</span>
                                    </label>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="cancel-btn" @onclick="CloseAddVariantModal">
                            <span>Cancel</span>
                        </button>
                        <button type="submit" class="save-variant-btn">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            <span>Save Variant</span>
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Update Variant Modal *@
@if (showUpdateVariantModal)
{
    <div class="modal-overlay" @onclick="CloseUpdateVariantModal">
        <div class="update-variant-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h2 class="modal-title-text">Update Variant</h2>
                <button class="modal-close-btn" @onclick="CloseUpdateVariantModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <EditForm EditContext="@_updateVariantEditContext" OnValidSubmit="SaveUpdateVariantAsync">
                    <DataAnnotationsValidator />
                    
                    <div class="form-grid">
                        <div class="form-field">
                            <label class="field-label">Variant Name</label>
                            <InputText class="form-input" @bind-Value="_updateVariantModel.Name" placeholder="e.g., Standard Variant" />
                            <ValidationMessage For="@(() => _updateVariantModel.Name)" />
                        </div>
                        <div class="form-field product-select-field">
                            <label class="field-label">Product</label>
                            <InputSelect class="form-input" @bind-Value="_updateVariantModel.ProductId" @bind-Value:after="OnUpdateProductSelected">
                                <option value="0">Select a product</option>
                                @foreach (var product in products)
                                {
                                    <option value="@product.Id">@product.Name</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="@(() => _updateVariantModel.ProductId)" />
                            @if (_updateVariantModel.ProductId > 0)
                            {
                                var selectedProduct = products.FirstOrDefault(p => p.Id == _updateVariantModel.ProductId);
                                @if (selectedProduct != null && !string.IsNullOrEmpty(selectedProduct.ImageBase64))
                                {
                                    <div class="product-image-preview">
                                        <img src="data:image/jpeg;base64,@selectedProduct.ImageBase64" alt="@selectedProduct.Name" />
                                    </div>
                                }
                                else if (selectedProduct != null)
                                {
                                    <div class="product-image-preview no-image">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                            <polyline points="21 15 16 10 5 21"></polyline>
                                        </svg>
                                    </div>
                                }
                            }
                        </div>
                        <div class="form-field">
                            <label class="field-label">Price</label>
                            <InputNumber class="form-input" @bind-Value="_updateVariantModel.Price" @bind-Value:after="OnUpdatePriceChanged" placeholder="0.00" step="0.01" />
                            <ValidationMessage For="@(() => _updateVariantModel.Price)" />
                        </div>
                        <div class="form-field">
                            <label class="field-label">Cost Price (Auto-calculated: Price + 50%)</label>
                            <InputNumber class="form-input" @bind-Value="_updateVariantModel.CostPrice" placeholder="0.00" step="0.01" readonly />
                        </div>
                        <div class="form-field full-width">
                            <label class="field-label">Sizes</label>
                            <div class="checkbox-group">
                                @foreach (var size in activeSizes)
                                {
                                    <label class="checkbox-item">
                                        <input type="checkbox" 
                                               checked="@_updateSelectedSizeIds.Contains(size.Id)"
                                               @onchange="@((ChangeEventArgs e) => ToggleUpdateSize(size.Id, (bool)(e.Value ?? false)))" />
                                        <span>@size.Name</span>
                                    </label>
                                }
                            </div>
                        </div>
                        <div class="form-field full-width">
                            <label class="field-label">Colors</label>
                            <div class="checkbox-group color-checkbox-group">
                                @foreach (var color in activeColors)
                                {
                                    <label class="checkbox-item color-checkbox-item">
                                        <input type="checkbox" 
                                               checked="@_updateSelectedColorIds.Contains(color.Id)"
                                               @onchange="@((ChangeEventArgs e) => ToggleUpdateColor(color.Id, (bool)(e.Value ?? false)))" />
                                        <span class="color-swatch" style="background-color: @color.HexValue;"></span>
                                        <span>@color.Name</span>
                                    </label>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="cancel-btn" @onclick="CloseUpdateVariantModal">
                            <span>Cancel</span>
                        </button>
                        <button type="submit" class="save-variant-btn">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            <span>Update Variant</span>
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<IT13_Final.Services.Data.VariantModel> Variants = new();
    private List<IT13_Final.Services.Data.VariantModel> allFilteredVariants = new();
    private List<IT13_Final.Services.Data.ProductOption> products = new();
    private List<IT13_Final.Services.Data.SizeOption> activeSizes = new();
    private List<IT13_Final.Services.Data.ColorOption> activeColors = new();
    private string searchTerm = string.Empty;
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);
    
    // Date filter variables
    private string selectedDateRange = "";
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    
    private bool HasActiveDateFilters => filterStartDate.HasValue || filterEndDate.HasValue || !string.IsNullOrEmpty(selectedDateRange);

    private bool showVariantDetails = false;
    private IT13_Final.Services.Data.VariantDetailsModel? variantDetails = null;
    private string? selectedColorHex = null;

    private bool showSuccessMessage = false;
    private string successMessageText = string.Empty;
    private System.Threading.Timer? _successBannerTimer;

    private bool showAddVariantModal = false;
    private AddVariantModel _addVariantModel = new();
    private EditContext? _addVariantEditContext;
    private List<int> _addSelectedSizeIds = new();
    private List<int> _addSelectedColorIds = new();

    private bool showUpdateVariantModal = false;
    private UpdateVariantModel _updateVariantModel = new();
    private EditContext? _updateVariantEditContext;
    private int _updateVariantId;
    private List<int> _updateSelectedSizeIds = new();
    private List<int> _updateSelectedColorIds = new();

    private System.Threading.Timer? _searchTimer;

    protected override async Task OnInitializedAsync()
    {
        _addVariantEditContext = new EditContext(_addVariantModel);
        _updateVariantEditContext = new EditContext(_updateVariantModel);
        await LoadProductsAsync();
        await LoadSizesAsync();
        await LoadColorsAsync();
        await LoadVariantsAsync();
    }

    private async Task LoadProductsAsync()
    {
        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            products = await VariantService.GetActiveProductsAsync(userId);
        }
        catch (Exception)
        {
            products = new List<IT13_Final.Services.Data.ProductOption>();
        }
    }

    private async Task LoadSizesAsync()
    {
        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            activeSizes = await SizeService.GetActiveSizesAsync(userId);
        }
        catch (Exception)
        {
            activeSizes = new List<IT13_Final.Services.Data.SizeOption>();
        }
    }

    private async Task LoadColorsAsync()
    {
        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            activeColors = await ColorService.GetActiveColorsAsync(userId);
        }
        catch (Exception)
        {
            activeColors = new List<IT13_Final.Services.Data.ColorOption>();
        }
    }

    private async Task LoadVariantsAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            
            // Get all variants matching search term first
            var allVariants = await VariantService.GetVariantsAsync(userId, searchTerm, 1, 10000);
            
            // Apply date filter client-side
            if (filterStartDate.HasValue || filterEndDate.HasValue)
            {
                allFilteredVariants = allVariants.Where(v =>
                {
                    var createdDate = v.DateCreated.Date;
                    
                    if (filterStartDate.HasValue && filterEndDate.HasValue)
                    {
                        return createdDate >= filterStartDate.Value.Date && createdDate <= filterEndDate.Value.Date;
                    }
                    else if (filterStartDate.HasValue)
                    {
                        return createdDate >= filterStartDate.Value.Date;
                    }
                    else if (filterEndDate.HasValue)
                    {
                        return createdDate <= filterEndDate.Value.Date;
                    }
                    return true;
                }).ToList();
            }
            else
            {
                allFilteredVariants = allVariants;
            }
            
            // Update total count based on filtered results
            totalCount = allFilteredVariants.Count;
            
            // Apply pagination to filtered results
            Variants = allFilteredVariants
                .Skip((currentPage - 1) * pageSize)
                .Take(pageSize)
                .ToList();
        }
        catch (Exception)
        {
            Variants = new List<IT13_Final.Services.Data.VariantModel>();
            allFilteredVariants = new List<IT13_Final.Services.Data.VariantModel>();
            totalCount = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Debounce search to avoid too many queries
    private void OnSearchInput()
    {
        // Filter out special characters
        var filtered = System.Text.RegularExpressions.Regex.Replace(searchTerm, @"[^a-zA-Z0-9\s\-_]", "");
        if (filtered != searchTerm)
        {
            searchTerm = filtered;
        }
        
        _searchTimer?.Dispose();
        _searchTimer = new System.Threading.Timer(async _ =>
        {
            currentPage = 1;
            await InvokeAsync(async () =>
            {
                await LoadVariantsAsync();
            });
        }, null, 400, Timeout.Infinite);
    }

    private async Task ClearSearch()
    {
        searchTerm = string.Empty;
        currentPage = 1;
        await LoadVariantsAsync();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages && page != currentPage)
        {
            currentPage = page;
            await LoadVariantsAsync();
        }
    }

    private void NavigateToArchive()
    {
        Nav.NavigateTo("/seller/Archive_Variant_Record");
    }

    private void HandleAddVariant()
    {
        _addVariantModel = new AddVariantModel();
        _addVariantEditContext = new EditContext(_addVariantModel);
        _addSelectedSizeIds = new List<int>();
        _addSelectedColorIds = new List<int>();
        showAddVariantModal = true;
    }

    private void OnProductSelected()
    {
        StateHasChanged();
    }

    private void OnUpdateProductSelected()
    {
        StateHasChanged();
    }

    private void OnAddPriceChanged()
    {
        if (_addVariantModel.Price > 0)
        {
            _addVariantModel.CostPrice = _addVariantModel.Price * 1.5m;
            StateHasChanged();
        }
    }

    private void OnUpdatePriceChanged()
    {
        if (_updateVariantModel.Price > 0)
        {
            _updateVariantModel.CostPrice = _updateVariantModel.Price * 1.5m;
            StateHasChanged();
        }
    }

    private void ToggleSize(int sizeId, bool isChecked)
    {
        if (isChecked)
        {
            if (!_addSelectedSizeIds.Contains(sizeId))
                _addSelectedSizeIds.Add(sizeId);
        }
        else
        {
            _addSelectedSizeIds.Remove(sizeId);
        }
        StateHasChanged();
    }

    private void ToggleColor(int colorId, bool isChecked)
    {
        if (isChecked)
        {
            if (!_addSelectedColorIds.Contains(colorId))
                _addSelectedColorIds.Add(colorId);
        }
        else
        {
            _addSelectedColorIds.Remove(colorId);
        }
        StateHasChanged();
    }

    private async Task SaveVariantAsync()
    {
        if (!_addVariantEditContext.Validate())
            return;

        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            var result = await VariantService.CreateVariantAsync(
                userId,
                _addVariantModel.Name,
                _addVariantModel.Price,
                _addVariantModel.CostPrice,
                _addVariantModel.ProductId,
                _addSelectedSizeIds,
                _addSelectedColorIds
            );

            if (result.HasValue)
            {
                ShowSuccessMessage("Variant added successfully!");
                showAddVariantModal = false;
                await LoadVariantsAsync();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to add variant.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error adding variant: {ex.Message}");
        }
    }

    private void CloseAddVariantModal()
    {
        showAddVariantModal = false;
        _addSelectedSizeIds = new List<int>();
        _addSelectedColorIds = new List<int>();
    }

    private async Task HandleEdit(int variantId)
    {
        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            var variantToUpdate = await VariantService.GetVariantDetailsAsync(variantId, userId);
            if (variantToUpdate != null)
            {
                _updateVariantModel = new UpdateVariantModel
                {
                    Name = variantToUpdate.Name,
                    Price = variantToUpdate.Price,
                    CostPrice = variantToUpdate.CostPrice ?? (variantToUpdate.Price * 1.5m),
                    ProductId = variantToUpdate.ProductId
                };
                _updateVariantEditContext = new EditContext(_updateVariantModel);
                _updateVariantId = variantId;
                _updateSelectedSizeIds = new List<int>(variantToUpdate.SizeIds);
                _updateSelectedColorIds = new List<int>(variantToUpdate.ColorIds);
                showUpdateVariantModal = true;
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error loading variant: {ex.Message}");
        }
    }

    private void ToggleUpdateSize(int sizeId, bool isChecked)
    {
        if (isChecked)
        {
            if (!_updateSelectedSizeIds.Contains(sizeId))
                _updateSelectedSizeIds.Add(sizeId);
        }
        else
        {
            _updateSelectedSizeIds.Remove(sizeId);
        }
        StateHasChanged();
    }

    private void ToggleUpdateColor(int colorId, bool isChecked)
    {
        if (isChecked)
        {
            if (!_updateSelectedColorIds.Contains(colorId))
                _updateSelectedColorIds.Add(colorId);
        }
        else
        {
            _updateSelectedColorIds.Remove(colorId);
        }
        StateHasChanged();
    }

    private async Task SaveUpdateVariantAsync()
    {
        if (!_updateVariantEditContext.Validate())
            return;

        try
        {
            var userId = AuthState.CurrentUser?.Id ?? 0;
            var success = await VariantService.UpdateVariantAsync(
                _updateVariantId,
                userId,
                _updateVariantModel.Name,
                _updateVariantModel.Price,
                _updateVariantModel.CostPrice,
                _updateVariantModel.ProductId,
                _updateSelectedSizeIds,
                _updateSelectedColorIds
            );

            if (success)
            {
                ShowSuccessMessage("Variant updated successfully!");
                showUpdateVariantModal = false;
                await LoadVariantsAsync();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to update variant.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error updating variant: {ex.Message}");
        }
    }

    private void CloseUpdateVariantModal()
    {
        showUpdateVariantModal = false;
        _updateSelectedSizeIds = new List<int>();
        _updateSelectedColorIds = new List<int>();
    }

    private async Task HandleDelete(int variantId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to archive this variant?");
        if (confirmed)
        {
            try
            {
                var userId = AuthState.CurrentUser?.Id ?? 0;
                var success = await VariantService.ArchiveVariantAsync(variantId, userId);
                if (success)
                {
                    ShowSuccessMessage("Variant archived successfully!");
                    await LoadVariantsAsync();
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Failed to archive variant.");
                }
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", $"Error archiving variant: {ex.Message}");
            }
        }
    }

    private async Task HandleRowClick(int variantId)
    {
        var userId = AuthState.CurrentUser?.Id ?? 0;
        variantDetails = await VariantService.GetVariantDetailsAsync(variantId, userId);
        if (variantDetails != null)
        {
            showVariantDetails = true;
            // Set first color as default if available
            if (variantDetails.ColorHexValues.Count > 0)
            {
                selectedColorHex = variantDetails.ColorHexValues[0];
            }
            else
            {
                selectedColorHex = null;
            }
        }
    }

    private void SelectColor(string colorHex)
    {
        selectedColorHex = colorHex;
        StateHasChanged();
    }

    private void CloseVariantDetails()
    {
        showVariantDetails = false;
        variantDetails = null;
        selectedColorHex = null;
    }

    private void ShowSuccessMessage(string message)
    {
        successMessageText = message;
        showSuccessMessage = true;
        StateHasChanged();

        _successBannerTimer?.Dispose();
        _successBannerTimer = new System.Threading.Timer(_ =>
        {
            showSuccessMessage = false;
            InvokeAsync(StateHasChanged);
        }, null, 3000, Timeout.Infinite);
    }

    // Date filter methods
    private void HandleStartDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            filterStartDate = date;
            selectedDateRange = "";
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            filterStartDate = null;
            selectedDateRange = "";
        }
    }

    private void HandleEndDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            filterEndDate = date;
            selectedDateRange = "";
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            filterEndDate = null;
            selectedDateRange = "";
        }
    }

    private void HandleDateRangeChange()
    {
        var now = DateTime.Now;
        switch (selectedDateRange)
        {
            case "":
                filterStartDate = null;
                filterEndDate = null;
                break;
            case "today":
                filterStartDate = now.Date;
                filterEndDate = now.Date;
                break;
            case "yesterday":
                filterStartDate = now.Date.AddDays(-1);
                filterEndDate = now.Date.AddDays(-1);
                break;
            case "last7days":
                filterStartDate = now.Date.AddDays(-6);
                filterEndDate = now.Date;
                break;
            case "last30days":
                filterStartDate = now.Date.AddDays(-29);
                filterEndDate = now.Date;
                break;
            case "thismonth":
                filterStartDate = new DateTime(now.Year, now.Month, 1);
                filterEndDate = now.Date;
                break;
            case "thisyear":
                filterStartDate = new DateTime(now.Year, 1, 1);
                filterEndDate = now.Date;
                break;
        }
        _ = LoadVariantsAsync();
    }

    private async Task ApplyDateFilter()
    {
        currentPage = 1;
        await LoadVariantsAsync();
    }

    private async Task ClearDateFilter()
    {
        selectedDateRange = "";
        filterStartDate = null;
        filterEndDate = null;
        currentPage = 1;
        await LoadVariantsAsync();
    }

    private string GetDateRangeText()
    {
        if (filterStartDate.HasValue && filterEndDate.HasValue)
            return $"{filterStartDate.Value:MMM dd, yyyy} - {filterEndDate.Value:MMM dd, yyyy}";
        if (filterStartDate.HasValue)
            return $"From {filterStartDate.Value:MMM dd, yyyy}";
        if (filterEndDate.HasValue)
            return $"Until {filterEndDate.Value:MMM dd, yyyy}";
        return "All Time";
    }

    private async Task PrintVariantRecords()
    {
        // Use all filtered variants for the PDF, not just the current page
        var recordsForPrint = allFilteredVariants.Any() ? allFilteredVariants : Variants;
        
        var reportData = new
        {
            title = "Variant Records Report",
            printedBy = AuthState.CurrentUser?.FullName ?? "Seller",
            printedAt = DateTime.Now.ToString("MMMM dd, yyyy hh:mm tt"),
            dateRange = GetDateRangeText(),
            totalCount = recordsForPrint.Count,
            records = recordsForPrint.Select(v => new
            {
                id = v.Id,
                name = v.Name,
                product = v.ProductName,
                price = $"₱{v.Price:N2}",
                dateCreated = v.DateCreated.ToString("MMM dd, yyyy")
            }).ToList()
        };

        await JSRuntime.InvokeVoidAsync("printVariantRecords", reportData);
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
        _successBannerTimer?.Dispose();
    }

    public class AddVariantModel
    {
        [Required(ErrorMessage = "Variant name is required")]
        [StringLength(200, ErrorMessage = "Variant name cannot exceed 200 characters")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Product is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a valid product")]
        public int ProductId { get; set; }

        [Required(ErrorMessage = "Price is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Price must be greater than 0")]
        public decimal Price { get; set; }

        [Range(0, double.MaxValue, ErrorMessage = "Cost price must be 0 or greater")]
        public decimal? CostPrice { get; set; }
    }

    public class UpdateVariantModel
    {
        [Required(ErrorMessage = "Variant name is required")]
        [StringLength(200, ErrorMessage = "Variant name cannot exceed 200 characters")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "Product is required")]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a valid product")]
        public int ProductId { get; set; }

        [Required(ErrorMessage = "Price is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Price must be greater than 0")]
        public decimal Price { get; set; }

        [Range(0, double.MaxValue, ErrorMessage = "Cost price must be 0 or greater")]
        public decimal? CostPrice { get; set; }
    }
}


