@page "/admin/seller-fees"
@layout IT13_Final.Components.Layout.Admin.Admin
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@using Microsoft.Data.SqlClient

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">Seller Fee Breakdown</h1>
        <p class="welcome-date">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>
    <div class="header-actions">
        <button class="action-btn print-btn" @onclick="PrintReport" title="Print Report">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>
    </div>
</div>

@* Search and Date Filters *@
<div class="dashboard-filters">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" class="search-input" placeholder="Search sellers..." @bind="searchTerm" @bind:event="oninput" @bind:after="HandleSearchInput" />
        @if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            <button class="clear-search-btn" @onclick="ClearSearch" title="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
    <div class="date-filters">
        <select class="date-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange" @bind:event="onchange">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
            <option value="thisyear">This Year</option>
        </select>
        <input type="date" 
               class="date-input" 
               value="@(startDate?.ToString("yyyy-MM-dd"))" 
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleStartDateChange" />
        <span class="date-separator">to</span>
        <input type="date" 
               class="date-input" 
               value="@(endDate?.ToString("yyyy-MM-dd"))" 
               min="@(startDate?.ToString("yyyy-MM-dd") ?? DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd"))"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleEndDateChange" />
        @if (HasActiveDateFilters)
        {
            <button class="clear-btn" @onclick="ClearDateFilter" title="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
</div>

@if (isLoading)
{
    <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading sellers...</p>
    </div>
}
else
{
    @* KPI Summary *@
    <div class="kpi-row">
        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Sellers</span>
                <span class="kpi-value">@totalSellers</span>
                <span class="kpi-trend">
                    <span>Registered sellers</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-success">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Active Sellers</span>
                <span class="kpi-value">@activeSellers</span>
                <span class="kpi-trend trend-up">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    <span>With sales</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Fees Owed</span>
                <span class="kpi-value">₱@totalFeesOwed.ToString("N2")</span>
                <span class="kpi-trend">
                    <span>2% of revenue</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-warning">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Avg Fee/Seller</span>
                <span class="kpi-value">₱@avgFeePerSeller.ToString("N2")</span>
                <span class="kpi-trend">
                    <span>Per active seller</span>
                </span>
            </div>
        </div>
    </div>

    @* Seller Cards Grid *@
    <div class="section-header">
        <h2 class="section-title">Seller Breakdown</h2>
        <span class="section-subtitle">@filteredData.Count sellers found</span>
    </div>

    <div class="seller-grid">
        @if (filteredData.Any())
        {
            @foreach (var seller in filteredData)
            {
                <div class="seller-card @(seller.Revenue > 0 ? "active" : "inactive")">
                    <div class="seller-card-header">
                        <div class="seller-avatar-large">@GetInitials(seller.Name)</div>
                        <div class="seller-card-info">
                            <span class="seller-card-name">@seller.Name</span>
                            <span class="seller-card-email">@seller.Email</span>
                        </div>
                        <div class="seller-status @(seller.Revenue > 0 ? "status-active" : "status-inactive")">
                            @(seller.Revenue > 0 ? "Active" : "Inactive")
                        </div>
                    </div>
                    <div class="seller-card-body">
                        <div class="seller-metric">
                            <span class="metric-label">Revenue</span>
                            <span class="metric-value">₱@seller.Revenue.ToString("N2")</span>
                        </div>
                        <div class="seller-metric">
                            <span class="metric-label">Admin Fee (2%)</span>
                            <span class="metric-value fee">₱@seller.AdminFee.ToString("N2")</span>
                        </div>
                        <div class="seller-metric">
                            <span class="metric-label">Transactions</span>
                            <span class="metric-value">@seller.Transactions</span>
                        </div>
                        <div class="seller-metric">
                            <span class="metric-label">Net to Seller</span>
                            <span class="metric-value">₱@seller.NetToSeller.ToString("N2")</span>
                        </div>
                    </div>
                    <div class="seller-card-footer">
                        <span class="fee-badge">Fee: ₱@seller.AdminFee.ToString("N2")</span>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state-full">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                </svg>
                <span>No sellers found</span>
            </div>
        }
    </div>

    @* Detailed Table *@
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Detailed Fee Table</h3>
            <span class="record-count">@filteredData.Count records</span>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="th-rank">#</th>
                        <th class="th-seller">Seller</th>
                        <th class="th-status">Status</th>
                        <th class="th-revenue">Revenue</th>
                        <th class="th-fee">Admin Fee</th>
                        <th class="th-transactions">Sales</th>
                        <th class="th-net">Net Amount</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var (seller, idx) in filteredData.Select((x, i) => (x, i)))
                    {
                        <tr>
                            <td class="td-rank">
                                <span class="rank-badge">@(idx + 1)</span>
                            </td>
                            <td class="td-seller">
                                <div class="seller-cell">
                                    <div class="seller-avatar-sm">@GetInitials(seller.Name)</div>
                                    <div class="seller-details">
                                        <span class="seller-name">@seller.Name</span>
                                        <span class="seller-email">@seller.Email</span>
                                    </div>
                                </div>
                            </td>
                            <td class="td-status">
                                <span class="status-pill @(seller.Revenue > 0 ? "pill-active" : "pill-inactive")">
                                    @(seller.Revenue > 0 ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td class="td-revenue">₱@seller.Revenue.ToString("N2")</td>
                            <td class="td-fee">₱@seller.AdminFee.ToString("N2")</td>
                            <td class="td-transactions">@seller.Transactions</td>
                            <td class="td-net">₱@seller.NetToSeller.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string searchTerm = "";
    private string selectedDateRange = "";
    private DateTime? startDate;
    private DateTime? endDate;

    private bool HasActiveDateFilters => !string.IsNullOrEmpty(selectedDateRange) || startDate.HasValue || endDate.HasValue;

    // KPIs
    private int totalSellers = 0;
    private int activeSellers = 0;
    private decimal totalFeesOwed = 0;
    private decimal avgFeePerSeller = 0;

    private List<SellerData> allData = new();
    private List<SellerData> filteredData => string.IsNullOrWhiteSpace(searchTerm) 
        ? allData 
        : allData.Where(x => x.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                             x.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();

    private class SellerData
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public decimal Revenue { get; set; }
        public decimal AdminFee => Revenue * 0.02m;
        public decimal NetToSeller => Revenue - AdminFee;
        public int Transactions { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadReportData();
    }

    private void HandleStartDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            var today = DateTime.Today;
            // Prevent future dates - cap at today
            if (date.Date > today)
            {
                startDate = today;
            }
            else
            {
                startDate = date.Date;
            }
            selectedDateRange = "";
            
            // If end date is before start date, adjust it
            if (endDate.HasValue && endDate.Value < startDate.Value)
            {
                endDate = startDate.Value;
            }
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            startDate = null;
            selectedDateRange = "";
        }
        
        _ = LoadReportData();
    }

    private void HandleEndDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            var today = DateTime.Today;
            var parsedDate = date.Date;
            
            // Prevent future dates - cap at today
            if (parsedDate > today)
            {
                parsedDate = today;
            }
            
            // Ensure end date is never before start date - if it is, set it to startDate or today (whichever is earlier)
            if (startDate.HasValue)
            {
                // If end date is before start date, set it to start date
                if (parsedDate < startDate.Value)
                {
                    endDate = startDate.Value;
                }
                else
                {
                    endDate = parsedDate;
                }
            }
            else
            {
                // If no start date is set, allow any date up to today
                endDate = parsedDate;
            }
            
            selectedDateRange = "";
        }
        else if (string.IsNullOrWhiteSpace(value))
        {
            endDate = null;
            selectedDateRange = "";
        }
        
        _ = LoadReportData();
    }

    private void HandleDateRangeChange()
    {
        var now = DateTime.Now;
        switch (selectedDateRange)
        {
            case "":
                startDate = null;
                endDate = null;
                break;
            case "today":
                startDate = now.Date;
                endDate = now.Date;
                break;
            case "yesterday":
                startDate = now.Date.AddDays(-1);
                endDate = now.Date.AddDays(-1);
                break;
            case "last7days":
                startDate = now.Date.AddDays(-6);
                endDate = now.Date;
                break;
            case "last30days":
                startDate = now.Date.AddDays(-29);
                endDate = now.Date;
                break;
            case "thismonth":
                startDate = new DateTime(now.Year, now.Month, 1);
                endDate = now.Date;
                break;
            case "thisyear":
                startDate = new DateTime(now.Year, 1, 1);
                endDate = now.Date;
                break;
        }
        _ = LoadReportData();
    }

    private void ClearDateFilter()
    {
        selectedDateRange = "";
        startDate = null;
        endDate = null;
        _ = LoadReportData();
    }

    private void HandleSearchInput()
    {
        // Filter out special characters
        var filtered = System.Text.RegularExpressions.Regex.Replace(searchTerm, @"[^a-zA-Z0-9\s\-_]", "");
        if (filtered != searchTerm)
        {
            searchTerm = filtered;
        }
    }

    private void ClearSearch() => searchTerm = "";

    private async Task LoadReportData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new SqlConnection(connectionString);
            await conn.OpenAsync();

            // Build date filter
            var dateFilter = "";
            if (startDate.HasValue)
                dateFilter += " AND CAST(s.timestamps AS DATE) >= @StartDate";
            if (endDate.HasValue)
                dateFilter += " AND CAST(s.timestamps AS DATE) <= @EndDate";

            allData.Clear();
            int idCounter = 1;

            // Get sales grouped by the seller (product owner), not the cashier who made the sale
            // Join through variants and products to get the actual seller
            // Only show sales that have been approved in Daily Sales Verification
            var salesSql = $@"
                SELECT 
                    p.user_id as seller_id,
                    COALESCE(u.name, CONCAT(u.fname, ' ', u.lname), u.email, 'Unknown') as seller_name,
                    u.email,
                    ISNULL(SUM(si.subtotal), 0) as revenue,
                    COUNT(DISTINCT s.id) as transactions
                FROM dbo.tbl_sales s
                INNER JOIN dbo.tbl_sales_items si ON si.sale_id = s.id
                INNER JOIN dbo.tbl_variants v ON si.variant_id = v.id
                INNER JOIN dbo.tbl_products p ON v.product_id = p.id
                LEFT JOIN dbo.tbl_users u ON p.user_id = u.id
                WHERE s.archives IS NULL
                AND si.archives IS NULL
                AND s.status = 'Completed'
                AND EXISTS (
                    SELECT 1 FROM dbo.tbl_daily_sales_verifications dsv
                    WHERE dsv.cashier_user_id = s.user_id
                    AND dsv.sale_date = CAST(s.timestamps AS DATE)
                    AND dsv.seller_user_id = p.user_id
                    AND dsv.status = 'Approved'
                    AND dsv.archived_at IS NULL
                )
                {dateFilter}
                GROUP BY p.user_id, u.name, u.fname, u.lname, u.email
                ORDER BY SUM(si.subtotal) DESC";

            using (var cmd = new SqlCommand(salesSql, conn))
            {
                if (startDate.HasValue)
                    cmd.Parameters.AddWithValue("@StartDate", startDate.Value.Date);
                if (endDate.HasValue)
                    cmd.Parameters.AddWithValue("@EndDate", endDate.Value.Date);

                using var reader = await cmd.ExecuteReaderAsync();
                while (await reader.ReadAsync())
                {
                    var sellerId = reader.IsDBNull(0) ? 0 : reader.GetInt32(0);
                    var sellerName = reader.IsDBNull(1) ? "Products (No Seller Assigned)" : reader.GetString(1);
                    var email = reader.IsDBNull(2) ? "" : reader.GetString(2);
                    var revenue = reader.IsDBNull(3) ? 0 : reader.GetDecimal(3);
                    var transactions = reader.IsDBNull(4) ? 0 : reader.GetInt32(4);

                    // Skip unassigned products or handle them separately if needed
                    if (sellerId == 0)
                    {
                        sellerName = "Products (No Seller Assigned)";
                        email = "";
                    }

                    allData.Add(new SellerData
                    {
                        Id = sellerId,
                        Name = sellerName,
                        Email = email,
                        Revenue = revenue,
                        Transactions = transactions
                    });
                }
            }

            // Calculate KPIs
            totalSellers = allData.Count;
            activeSellers = allData.Count(x => x.Revenue > 0);
            totalFeesOwed = allData.Sum(x => x.AdminFee);
            avgFeePerSeller = activeSellers > 0 ? totalFeesOwed / activeSellers : 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return (parts[0][0].ToString() + parts[1][0]).ToUpperInvariant();
        return name[0].ToString().ToUpperInvariant();
    }

    private void GoBack() => Nav.NavigateTo("/admin/dashboard");

    private async Task PrintReport()
    {
        // Confirm before exporting PDF
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirmExportPDF");
        if (!confirmed) return;

        var reportData = new
        {
            title = "Seller Fee Breakdown Report",
            printedBy = AuthState.CurrentUser?.FullName ?? "Admin",
            printedAt = DateTime.Now.ToString("MMMM dd, yyyy hh:mm tt"),
            dateRange = startDate.HasValue && endDate.HasValue 
                ? $"{startDate?.ToString("MM/dd/yyyy")} - {endDate?.ToString("MM/dd/yyyy")}" 
                : "All Time",
            
            kpi = new
            {
                totalAdminFees = totalFeesOwed.ToString("N2"),
                grossRevenue = filteredData.Sum(x => x.Revenue).ToString("N2"),
                activeSellers = activeSellers.ToString(),
                totalTransactions = filteredData.Sum(x => x.Transactions).ToString("N0")
            },

            sellers = filteredData.Select(s => new
            {
                name = s.Name,
                revenue = s.Revenue.ToString("N2"),
                adminFee = s.AdminFee.ToString("N2"),
                transactions = s.Transactions.ToString(),
                netToSeller = s.NetToSeller.ToString("N2")
            }).ToList()
        };

        await JSRuntime.InvokeVoidAsync("printAdminFeeSummary", reportData);
        
        // Log history
        if (AuthState.CurrentUser != null)
        {
            try
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "print",
                    "Reports",
                    "Printed seller fee breakdown report"
                );
            }
            catch { }
        }
    }
}
