@page "/admin/subscriptions"
@layout IT13_Final.Components.Layout.Admin.Admin
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Data.ISubscriptionService SubscriptionService
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@implements IDisposable

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">Subscription Management</h1>
        <p class="welcome-date">@DateTime.Now.ToString("dddd, MMMM d, yyyy")</p>
    </div>
    <div class="header-actions">
        <button class="action-btn print-btn" @onclick="PrintReport" title="Print Report">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>
    </div>
</div>

@* Search and Date Filters *@
<div class="dashboard-filters">
    <div class="search-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" class="search-input" placeholder="Search sellers..." @bind="searchTerm" @bind:event="oninput" />
    </div>
    <div class="date-filters">
        <select class="date-select" @bind="selectedDateRange" @bind:after="HandleDateRangeChange" @bind:event="onchange">
            <option value="">All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="thismonth">This Month</option>
            <option value="thisyear">This Year</option>
        </select>
        <input type="date" 
               class="date-input" 
               value="@(startDate?.ToString("yyyy-MM-dd"))" 
               min="@DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd")"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleStartDateChange" />
        <span class="date-separator">to</span>
        <input type="date" 
               class="date-input" 
               value="@(endDate?.ToString("yyyy-MM-dd"))" 
               min="@(startDate?.ToString("yyyy-MM-dd") ?? DateTime.Now.AddYears(-10).ToString("yyyy-MM-dd"))"
               max="@DateTime.Now.ToString("yyyy-MM-dd")"
               @onchange="HandleEndDateChange" />
        @if (HasActiveDateFilters)
        {
            <button class="clear-btn" @onclick="ClearFilters" title="Clear Filters">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        }
    </div>
</div>

@if (isLoading)
{
    <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading subscription data...</p>
    </div>
}
else
{
    @* KPI Summary *@
    <div class="kpi-row">
        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Admin Fees</span>
                <span class="kpi-value">₱@totalAdminFees.ToString("N2")</span>
                <span class="kpi-trend trend-up">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"></polyline></svg>
                    <span>Platform earnings</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-success">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Transactions</span>
                <span class="kpi-value">@totalTransactionCount.ToString("N0")</span>
                <span class="kpi-trend">
                    <span>Fee transactions</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Active Sellers</span>
                <span class="kpi-value">@sellerSummaries.Count</span>
                <span class="kpi-trend">
                    <span>With subscriptions</span>
                </span>
            </div>
        </div>

        <div class="kpi-card kpi-warning">
            <div class="kpi-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Subscription Plans</span>
                <span class="kpi-value">@subscriptionPlans.Count</span>
                <span class="kpi-trend">
                    <span>Available plans</span>
                </span>
            </div>
        </div>
    </div>

        @* Seller Summary Card *@
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Seller Fee Summary</h3>
            <span class="record-count">@filteredSellers.Count records</span>
        </div>
        <div class="table-container">
            @if (filteredSellers.Count == 0)
            {
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                    </svg>
                    <span>No seller subscription data found</span>
                </div>
            }
            else
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="th-rank">#</th>
                            <th class="th-seller">Seller</th>
                            <th class="th-plan">Plan</th>
                            <th class="th-fee">Admin Fee</th>
                            <th class="th-transactions">Transactions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (seller, idx) in filteredSellers.Select((x, i) => (x, i)))
                        {
                            <tr>
                                <td class="td-rank">
                                    <span class="rank-badge">@(idx + 1)</span>
                                </td>
                                <td class="td-seller">@seller.SellerName</td>
                                <td class="td-plan">
                                    <span class="plan-badge @seller.PlanName.ToLower().Replace(" ", "-")">@seller.PlanName</span>
                                </td>
                                <td class="td-fee">₱@seller.TotalAdminFees.ToString("N2")</td>
                                <td class="td-transactions">@seller.TotalTransactions</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    @* Fee Transactions Card *@
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Fee Transactions</h3>
            <span class="record-count">@totalCount total</span>
        </div>
        <div class="table-container">
            @if (transactions.Count == 0)
            {
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    <span>No transactions found</span>
                </div>
            }
            else
            {
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Sale #</th>
                            <th>Sale Amount</th>
                            <th>Fee %</th>
                            <th>Admin Fee</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var txn in transactions)
                        {
                            <tr>
                                <td>@txn.CreatedAt.ToString("MMM dd, yyyy HH:mm")</td>
                                <td>@(txn.SaleNumber ?? "-")</td>
                                <td class="amount">₱@(txn.SaleAmount?.ToString("N2") ?? "-")</td>
                                <td>@txn.AdminFeePercentage.ToString("0.0")%</td>
                                <td class="amount">₱@txn.AdminFeeAmount.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                </table>

                @* Pagination *@
                @if (totalPages > 1)
                {
                    <div class="pagination">
                        <button class="page-btn" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)" title="Previous page">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m15 18-6-6 6-6"></path>
                            </svg>
                        </button>

                        @for (int i = 1; i <= totalPages; i++)
                        {
                            var pageNum = i;
                            @if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                            {
                                <button class="page-btn @(i == currentPage ? "active" : "")" @onclick="() => GoToPage(pageNum)">
                                    @i
                                </button>
                            }
                            else if (i == currentPage - 2 || i == currentPage + 2)
                            {
                                <span class="page-ellipsis">...</span>
                            }
                        }

                        <button class="page-btn" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)" title="Next page">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m9 18 6-6-6-6"></path>
                            </svg>
                        </button>
                    </div>
                }
            }
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private string activeTab = "sellers";
    private string searchTerm = "";
    private string selectedDateRange = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private string? statusFilter;
    
    private bool HasActiveDateFilters => !string.IsNullOrEmpty(selectedDateRange) || startDate.HasValue || endDate.HasValue;
    
    private List<IT13_Final.Services.Data.AdminFeeSummaryModel> sellerSummaries = new();
    private List<IT13_Final.Services.Data.SubscriptionTransactionModel> transactions = new();
    private List<IT13_Final.Services.Data.SubscriptionPlanModel> subscriptionPlans = new();
    
    private List<IT13_Final.Services.Data.AdminFeeSummaryModel> filteredSellers => string.IsNullOrWhiteSpace(searchTerm)
        ? sellerSummaries
        : sellerSummaries.Where(s => s.SellerName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
    
    private decimal totalAdminFees;
    private int totalTransactionCount;
    
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private int totalCount;

    protected override async Task OnInitializedAsync()
    {
        if (AuthState.CurrentUser == null)
        {
            Nav.NavigateTo("/auth/login");
            return;
        }

        AuthState.Changed += StateHasChanged;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Load all data in parallel
            var summariesTask = SubscriptionService.GetAllSellerAdminFeeSummariesAsync(startDate, endDate);
            var plansTask = SubscriptionService.GetAllPlansAsync(activeOnly: false);
            
            await Task.WhenAll(summariesTask, plansTask);
            
            sellerSummaries = await summariesTask;
            subscriptionPlans = await plansTask;
            
            // Calculate totals
            totalAdminFees = sellerSummaries.Sum(s => s.TotalAdminFees);
            totalTransactionCount = sellerSummaries.Sum(s => s.TotalTransactions);
            
            // Load transactions
            await LoadTransactionsAsync();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading subscription data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadTransactionsAsync()
    {
        try
        {
            totalCount = await SubscriptionService.GetAdminFeeTransactionsCountAsync(
                sellerUserId: null, 
                startDate: startDate, 
                endDate: endDate, 
                status: null);
            
            totalPages = (int)Math.Ceiling((double)totalCount / pageSize);
            if (totalPages == 0) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            transactions = await SubscriptionService.GetAdminFeeTransactionsAsync(
                sellerUserId: null,
                startDate: startDate,
                endDate: endDate,
                status: null,
                page: currentPage,
                pageSize: pageSize);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading transactions: {ex.Message}");
        }
        
        StateHasChanged();
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private void SetTabSellers() => SetActiveTab("sellers");
    private void SetTabTransactions() => SetActiveTab("transactions");
    private void SetTabPlans() => SetActiveTab("plans");

    private async Task MarkAsCollected(int transactionId)
    {
        try
        {
            var success = await SubscriptionService.MarkAdminFeeAsCollectedAsync(transactionId);
            if (success)
            {
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error marking as collected: {ex.Message}");
        }
    }

    private async Task ClearFilters()
    {
        startDate = null;
        endDate = null;
        selectedDateRange = "";
        statusFilter = null;
        currentPage = 1;
        await LoadDataAsync();
    }

    private void HandleStartDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            startDate = date.Date > DateTime.Today ? DateTime.Today : date.Date;
            selectedDateRange = "";
            if (endDate.HasValue && endDate.Value < startDate.Value)
                endDate = startDate.Value;
        }
        else
        {
            startDate = null;
            selectedDateRange = "";
        }
        _ = LoadDataAsync();
    }

    private void HandleEndDateChange(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();
        if (DateTime.TryParse(value, out var date))
        {
            var parsedDate = date.Date > DateTime.Today ? DateTime.Today : date.Date;
            if (startDate.HasValue && parsedDate < startDate.Value)
                endDate = startDate.Value;
            else
                endDate = parsedDate;
            selectedDateRange = "";
        }
        else
        {
            endDate = null;
            selectedDateRange = "";
        }
        _ = LoadDataAsync();
    }

    private void HandleDateRangeChange()
    {
        var today = DateTime.Today;
        switch (selectedDateRange)
        {
            case "today":
                startDate = today;
                endDate = today;
                break;
            case "yesterday":
                startDate = today.AddDays(-1);
                endDate = today.AddDays(-1);
                break;
            case "last7days":
                startDate = today.AddDays(-6);
                endDate = today;
                break;
            case "last30days":
                startDate = today.AddDays(-29);
                endDate = today;
                break;
            case "thismonth":
                startDate = new DateTime(today.Year, today.Month, 1);
                endDate = today;
                break;
            case "thisyear":
                startDate = new DateTime(today.Year, 1, 1);
                endDate = today;
                break;
            default:
                startDate = null;
                endDate = null;
                break;
        }
        _ = LoadDataAsync();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= totalPages && page != currentPage)
        {
            currentPage = page;
            await LoadTransactionsAsync();
        }
    }

    private async Task PrintReport()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirmExportPDF");
        if (!confirmed) return;

        var reportData = new
        {
            title = "Subscription Management Report",
            printedBy = AuthState.CurrentUser?.FullName ?? "Admin",
            printedAt = DateTime.Now.ToString("MMMM dd, yyyy hh:mm tt"),
            dateRange = HasActiveDateFilters 
                ? $"{startDate?.ToString("MMM dd, yyyy") ?? "Start"} - {endDate?.ToString("MMM dd, yyyy") ?? "End"}"
                : "All Time",
            
            // KPIs
            totalTransactions = totalTransactionCount.ToString("N0"),
            totalAdminFees = totalAdminFees.ToString("N2"),
            activeSellers = sellerSummaries.Count.ToString(),
            subscriptionPlans = subscriptionPlans.Count.ToString(),
            
            // Seller Summary
            sellers = filteredSellers.Select((s, idx) => new
            {
                rank = idx + 1,
                name = s.SellerName,
                plan = s.PlanName,
                adminFee = s.TotalAdminFees.ToString("N2"),
                transactions = s.TotalTransactions.ToString()
            }).ToList(),
            
            // Fee Transactions
            transactions = transactions.Select(t => new
            {
                date = t.CreatedAt.ToString("MMM dd, yyyy"),
                saleNumber = t.SaleNumber ?? "-",
                saleAmount = t.SaleAmount?.ToString("N2") ?? "-",
                feePercentage = t.AdminFeePercentage.ToString("0.0") + "%",
                adminFee = t.AdminFeeAmount.ToString("N2")
            }).ToList()
        };

        await JSRuntime.InvokeVoidAsync("printSubscriptionReport", reportData);
        
        if (AuthState.CurrentUser != null)
        {
            try
            {
                await HistoryService.LogAsync(
                    AuthState.CurrentUser.Id,
                    "print",
                    "Reports",
                    "Printed subscription management report"
                );
            }
            catch { }
        }
    }

    public void Dispose()
    {
        AuthState.Changed -= StateHasChanged;
    }
}
