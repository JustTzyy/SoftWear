@page "/admin/database-sync"
@layout IT13_Final.Components.Layout.Admin.Admin
@inject IT13_Final.Services.Data.IDatabaseSyncService SyncService
@inject IT13_Final.Services.Data.AutoSyncBackgroundService AutoSyncService
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject IJSRuntime JSRuntime
@using IT13_Final.Services.Data
@implements IDisposable

@* Welcome Header *@
<div class="welcome-header">
    <div class="welcome-content">
        <h1 class="welcome-greeting">Database Sync</h1>
        <p class="welcome-date">Sync data between Local SQL Server and Azure Cloud</p>
    </div>
    <div class="header-actions">
        <button class="action-btn print-btn" @onclick="PrintPage" title="Print">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
        </button>
    </div>
</div>

@* Toast Notification *@
@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="toast-notification @(isSuccess ? "success" : "error")">
        <div class="toast-icon">
            @if (isSuccess)
            {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            }
            else
            {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            }
        </div>
        <span class="toast-message">@statusMessage</span>
        <button class="toast-close" @onclick="() => statusMessage = string.Empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        </button>
    </div>
}

@* KPI Cards Row *@
<div class="kpi-row">
    <div class="kpi-card kpi-autosync">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="kpi-content">
            <span class="kpi-label">Auto Sync</span>
            <span class="kpi-value @(autoSyncEnabled ? "active" : "inactive")">@(autoSyncEnabled ? "Active" : "Disabled")</span>
            <span class="kpi-trend">Every @(AutoSyncService?.SyncIntervalMinutes ?? 60) min</span>
        </div>
        <label class="toggle-switch">
            <input type="checkbox" checked="@autoSyncEnabled" @onchange="ToggleAutoSync" />
            <span class="toggle-slider"></span>
        </label>
    </div>

    <div class="kpi-card kpi-local @(localConnected ? "connected" : "disconnected")" @onclick="TestLocalConnection">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
            </svg>
        </div>
        <div class="kpi-content">
            <span class="kpi-label">Local Database</span>
            <span class="kpi-value">@(localTables?.Sum(t => t.RowCount).ToString("N0") ?? "0")</span>
            <span class="kpi-trend">rows • localhost</span>
        </div>
        <div class="status-badge @(localConnected ? "online" : "offline")">
            <span class="status-dot"></span>
            @(localConnected ? "Online" : "Offline")
                </div>
            </div>

    <div class="kpi-card kpi-azure @(azureConnected ? "connected" : "disconnected")" @onclick="TestAzureConnection">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
            </svg>
                </div>
        <div class="kpi-content">
            <span class="kpi-label">Azure Cloud</span>
            <span class="kpi-value">@(azureTables?.Sum(t => t.RowCount).ToString("N0") ?? "0")</span>
            <span class="kpi-trend">rows • Azure SQL</span>
            </div>
        <div class="status-badge @(azureConnected ? "online" : "offline")">
            <span class="status-dot"></span>
            @(azureConnected ? "Online" : "Offline")
        </div>
    </div>

    <div class="kpi-card kpi-sync">
        <div class="kpi-icon @(AutoSyncService?.IsRunning == true ? "spinning" : "")">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
        </div>
        <div class="kpi-content">
            <span class="kpi-label">Last Sync</span>
            <span class="kpi-value">@GetLastSyncDisplay()</span>
            <span class="kpi-trend @GetAutoSyncStatusClass()">@(AutoSyncService?.LastSyncStatus ?? "Waiting")</span>
        </div>
        <button class="sync-now-btn" @onclick="TriggerManualAutoSync" disabled="@(AutoSyncService?.IsRunning == true)">
            @(AutoSyncService?.IsRunning == true ? "Syncing..." : "Sync Now")
        </button>
    </div>
</div>

@* Quick Actions *@
<div class="quick-actions">
    <button class="quick-action-btn push" @onclick="SyncAllTables" disabled="@(isLoading || !localConnected || !azureConnected)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
        <span>Push to Cloud</span>
    </button>
    <button class="quick-action-btn pull" @onclick="PullAllTables" disabled="@(isLoading || !localConnected || !azureConnected)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <polyline points="19 12 12 19 5 12"></polyline>
        </svg>
        <span>Pull from Cloud</span>
    </button>
    <button class="quick-action-btn test" @onclick="TestConnections" disabled="@isLoading">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
        <span>Test Connections</span>
            </button>
</div>

@* Progress Bar *@
@if (syncProgress != null)
{
    <div class="progress-card">
        <div class="progress-header">
            <span class="progress-title">@syncProgress.CurrentTableName</span>
            <span class="progress-stats">@syncProgress.CurrentTable / @syncProgress.TotalTables tables</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: @(syncProgress.Percentage)%"></div>
            </div>
            <span class="progress-percent">@syncProgress.Percentage%</span>
        </div>
        <div class="progress-footer">
            <span><strong>@syncProgress.RowsSynced.ToString("N0")</strong> synced</span>
            <span><strong>@syncProgress.RowsSkipped.ToString("N0")</strong> skipped</span>
        </div>
    </div>
}

@* Tables Card *@
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Table Comparison</h3>
        <div class="legend">
            <span class="legend-item synced"><span class="legend-dot"></span>Synced</span>
            <span class="legend-item needs-sync"><span class="legend-dot"></span>Needs Sync</span>
        </div>
    </div>
    
    @if (isLoading && (localTables == null || azureTables == null))
    {
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <span>Loading tables...</span>
        </div>
    }
    else if (localTables != null && azureTables != null)
            {
        <div class="tables-grid">
                @foreach (var table in localTables)
                {
                    var azureTable = azureTables.FirstOrDefault(t => t.TableName == table.TableName);
                    var azureCount = azureTable?.RowCount ?? 0;
                    var needsSync = table.RowCount > 0 && (azureCount == 0 || table.RowCount > azureCount);
                var isSynced = table.RowCount == azureCount;
                    
                <div class="table-item @(needsSync ? "needs-sync" : "") @(isSynced && table.RowCount > 0 ? "synced" : "")">
                    <div class="table-info">
                        <span class="table-name">@table.TableName.Replace("tbl_", "")</span>
                        <div class="table-counts">
                            <span class="count local" title="Local rows">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                    <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                                </svg>
                                @table.RowCount.ToString("N0")
                            </span>
                            <span class="sync-indicator">
                                @if (isSynced)
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                }
                                else
                                {
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                    </svg>
                                }
                            </span>
                            <span class="count azure" title="Azure rows">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>
                                </svg>
                                @azureCount.ToString("N0")
                            </span>
                        </div>
                    </div>
                    <div class="table-actions">
                        <button class="mini-btn push" @onclick="() => SyncTable(table.TableName)" 
                                disabled="@(isLoading || table.RowCount == 0)" title="Push to Azure">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="19" x2="12" y2="5"></line>
                                <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
            </button>
                        <button class="mini-btn pull" @onclick="() => PullTable(table.TableName)" 
                                disabled="@(isLoading || azureCount == 0)" title="Pull from Azure">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <polyline points="19 12 12 19 5 12"></polyline>
                </svg>
            </button>
        </div>
                </div>
            }
            </div>
        }
</div>

@code {
    private bool localConnected = false;
    private bool azureConnected = false;
    private bool isLoading = false;
    private string statusMessage = string.Empty;
    private bool isSuccess = false;
    private List<TableInfo>? localTables;
    private List<TableInfo>? azureTables;
    private SyncProgress? syncProgress;
    private bool autoSyncEnabled = true;
    private System.Timers.Timer? refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        autoSyncEnabled = AutoSyncService?.IsEnabled ?? false;
        
        if (AutoSyncService != null)
        {
            AutoSyncService.SyncCompleted += OnAutoSyncCompleted;
        }
        
        refreshTimer = new System.Timers.Timer(5000);
        refreshTimer.Elapsed += (s, e) => InvokeAsync(StateHasChanged);
        refreshTimer.Start();
        
        await LoadTableInfo();
        await TestConnections();
    }

    private async Task PrintPage()
    {
        var reportData = new
        {
            title = "Database Sync Report",
            printedBy = AuthState.CurrentUser?.FullName ?? "Admin",
            printedAt = DateTime.Now.ToString("MMMM dd, yyyy hh:mm tt"),
            autoSyncEnabled = autoSyncEnabled,
            localConnected = localConnected,
            azureConnected = azureConnected,
            localRowCount = (localTables?.Sum(t => t.RowCount) ?? 0).ToString("N0"),
            azureRowCount = (azureTables?.Sum(t => t.RowCount) ?? 0).ToString("N0"),
            
            tables = localTables?.Select(t => {
                var azureTable = azureTables?.FirstOrDefault(a => a.TableName == t.TableName);
                var azureCount = azureTable?.RowCount ?? 0;
                var isSynced = t.RowCount == azureCount;
                return new
                {
                    name = t.TableName.Replace("tbl_", ""),
                    localRows = t.RowCount.ToString("N0"),
                    azureRows = azureCount.ToString("N0"),
                    status = isSynced ? "Synced" : (t.RowCount > azureCount ? "Needs Push" : "Needs Pull")
                };
            }).ToList()
        };

        await JSRuntime.InvokeVoidAsync("printDatabaseSyncReport", reportData);
    }

    private string GetLastSyncDisplay()
    {
        if (AutoSyncService?.LastSyncTime == DateTime.MinValue)
            return "Never";
        
        var diff = DateTime.Now - AutoSyncService!.LastSyncTime;
        if (diff.TotalMinutes < 1) return "Just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        return AutoSyncService.LastSyncTime.ToString("MMM dd");
    }

    private string GetAutoSyncBadgeClass()
    {
        if (AutoSyncService?.IsRunning == true) return "syncing";
        if (AutoSyncService?.LastSyncTime == DateTime.MinValue) return "pending";
        var status = AutoSyncService?.LastSyncStatus ?? "";
        if (status.StartsWith("Success")) return "success";
        if (status.StartsWith("Failed") || status.StartsWith("Error")) return "error";
        return "success";
    }

    private void OnAutoSyncCompleted(object? sender, SyncCompletedEventArgs e)
    {
        InvokeAsync(async () =>
        {
            await LoadTableInfo();
            StateHasChanged();
        });
    }

    private void ToggleAutoSync(ChangeEventArgs e)
    {
        autoSyncEnabled = (bool)(e.Value ?? false);
        
        if (AutoSyncService != null)
        {
            if (autoSyncEnabled)
            {
                AutoSyncService.Start();
                ShowMessage("Auto-sync enabled • Syncing every hour", true);
            }
            else
            {
                AutoSyncService.Stop();
                ShowMessage("Auto-sync disabled", true);
            }
        }
    }

    private async Task TriggerManualAutoSync()
    {
        if (AutoSyncService == null) return;
        
        ShowMessage("Starting sync...", true);
        var result = await AutoSyncService.TriggerSyncAsync();
        
        if (result.Success)
        {
            ShowMessage($"Sync completed • {result.RowsSynced:N0} rows synced", true);
            await LoadTableInfo();
        }
        else
        {
            ShowMessage(result.Message, false);
        }
    }

    private string GetAutoSyncStatusClass()
    {
        var status = AutoSyncService?.LastSyncStatus ?? "";
        if (status.StartsWith("Success")) return "status-success";
        if (status.StartsWith("Failed") || status.StartsWith("Error")) return "status-error";
        if (status == "Syncing...") return "status-syncing";
        return "";
    }

    public void Dispose()
    {
        if (AutoSyncService != null)
        {
            AutoSyncService.SyncCompleted -= OnAutoSyncCompleted;
        }
        refreshTimer?.Stop();
        refreshTimer?.Dispose();
    }

    private async Task TestConnections()
    {
        isLoading = true;
        try
        {
            localConnected = await SyncService.TestLocalConnectionAsync();
            azureConnected = await SyncService.TestAzureConnectionAsync();
            
            if (localConnected && azureConnected)
                ShowMessage("Both databases connected successfully", true);
            else if (!localConnected && !azureConnected)
                ShowMessage("Both connections failed", false);
            else if (!localConnected)
                ShowMessage("Local database connection failed", false);
            else
                ShowMessage("Azure database connection failed", false);
        }
        catch (Exception ex)
        {
            ShowMessage($"Connection error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task TestLocalConnection()
    {
        isLoading = true;
        try
        {
            localConnected = await SyncService.TestLocalConnectionAsync();
            ShowMessage(localConnected ? "Local database connected" : "Local connection failed", localConnected);
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task TestAzureConnection()
    {
        isLoading = true;
        try
        {
            azureConnected = await SyncService.TestAzureConnectionAsync();
            ShowMessage(azureConnected ? "Azure database connected" : "Azure connection failed", azureConnected);
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTableInfo()
    {
        isLoading = true;
        try
        {
            localTables = await SyncService.GetLocalTableInfoAsync();
            azureTables = await SyncService.GetAzureTableInfoAsync();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error loading tables: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SyncTable(string tableName)
    {
        isLoading = true;
        try
        {
            var result = await SyncService.SyncTableAsync(tableName);
            
            if (result.Success)
            {
                ShowMessage($"{tableName.Replace("tbl_", "")} pushed • {result.RowsSynced} rows", true);
                if (AuthState.CurrentUser != null)
                {
                    try
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "success",
                            "Database Sync",
                            $"Pushed {tableName}: {result.RowsSynced} rows"
                        );
                    }
                    catch { }
                }
            }
            else
            {
                ShowMessage(result.Message, false);
            }
            
            await LoadTableInfo();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PullTable(string tableName)
    {
        isLoading = true;
        try
        {
            var result = await SyncService.PullTableAsync(tableName);
            
            if (result.Success)
            {
                ShowMessage($"{tableName.Replace("tbl_", "")} pulled • {result.RowsSynced} rows", true);
                if (AuthState.CurrentUser != null)
                {
                    try
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "success",
                            "Database Sync",
                            $"Pulled {tableName}: {result.RowsSynced} rows"
                        );
                    }
                    catch { }
                }
            }
            else
            {
                ShowMessage(result.Message, false);
            }
            
            await LoadTableInfo();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SyncAllTables()
    {
        if (!localConnected || !azureConnected)
        {
            ShowMessage("Please ensure both databases are connected", false);
            return;
        }

        isLoading = true;
        syncProgress = new SyncProgress { TotalTables = 27 };
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });

            var result = await SyncService.SyncAllTablesAsync(progress);
            
            if (result.Success)
            {
                ShowMessage($"Push complete • {result.RowsSynced:N0} rows synced", true);
                if (AuthState.CurrentUser != null)
                {
                    try
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "success",
                            "Database Sync",
                            $"Pushed all: {result.RowsSynced} rows"
                        );
                    }
                    catch { }
                }
            }
            else
            {
                ShowMessage(result.Message, false);
            }
            
            await LoadTableInfo();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
            await Task.Delay(2000);
            syncProgress = null;
            StateHasChanged();
        }
    }

    private async Task PullAllTables()
    {
        if (!localConnected || !azureConnected)
        {
            ShowMessage("Please ensure both databases are connected", false);
            return;
        }

        isLoading = true;
        syncProgress = new SyncProgress { TotalTables = 27 };
        
        try
        {
            var progress = new Progress<SyncProgress>(p =>
            {
                syncProgress = p;
                InvokeAsync(StateHasChanged);
            });

            var result = await SyncService.PullAllTablesAsync(progress);
            
            if (result.Success)
            {
                ShowMessage($"Pull complete • {result.RowsSynced:N0} rows synced", true);
                if (AuthState.CurrentUser != null)
                {
                    try
                    {
                        await HistoryService.LogAsync(
                            AuthState.CurrentUser.Id,
                            "success",
                            "Database Sync",
                            $"Pulled all: {result.RowsSynced} rows"
                        );
                    }
                    catch { }
                }
            }
            else
            {
                ShowMessage(result.Message, false);
            }
            
            await LoadTableInfo();
        }
        catch (Exception ex)
        {
            ShowMessage($"Error: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
            await Task.Delay(2000);
            syncProgress = null;
            StateHasChanged();
        }
    }

    private void ShowMessage(string message, bool success)
    {
        statusMessage = message;
        isSuccess = success;
        StateHasChanged();
        
        _ = Task.Delay(5000).ContinueWith(_ =>
        {
            statusMessage = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }
}
