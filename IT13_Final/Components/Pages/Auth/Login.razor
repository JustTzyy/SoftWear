@page "/auth/login"
@page "/"
@layout IT13_Final.Components.Layout.Auth.Auth

@inject IT13_Final.Services.Auth.IAuthService AuthService
@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject IT13_Final.Services.Data.ISubscriptionService SubscriptionService
@inject NavigationManager Nav

<div class="flex items-center justify-center p-4 sm:p-6" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-image: url('/images/bg-image-login.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; overflow-y: auto; z-index: 0;">
    <div class="w-full sm:w-[420px] max-w-[420px] rounded-2xl shadow-[0_10px_30px_rgba(0,0,0,0.3)] p-6 sm:p-10 px-6 sm:px-8 text-center min-h-[500px] my-auto overflow-hidden relative z-10 backdrop-blur-lg" style="background-color: rgba(40, 40, 40, 0.5); border: 1px solid rgba(255, 255, 255, 0.1);">
        <div class="w-28 h-28 mx-auto rounded-full flex items-center justify-center border-2 border-[#5C7CFA] p-4" style="background-color: #1a2332;">
            <img src="/images/logo.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;" />
        </div>

        <h1 class="mt-2 mb-0 text-[26px] tracking-[2px] font-extrabold text-white drop-shadow-md">SOFTWEAR</h1>
        <p class="mt-2 mb-0 text-white text-sm font-medium">Welcome back!</p>
        <p class="mt-0.5 mb-0 text-gray-100 text-sm">Please sign in to your account</p>

        <EditForm Model="_loginModel" OnValidSubmit="HandleLoginAsync">
            <DataAnnotationsValidator />

            <div class="relative mt-[18px] mb-[30px]">
                <input @bind-value="_loginModel.Email" @bind-value:event="oninput" placeholder="Email" class="w-full h-[46px] px-[14px] pr-[52px] rounded-[10px] border-2 border-air-blue bg-white outline-none transition-[border-color,box-shadow] duration-200 text-[15px] focus:border-yinmn-blue focus:shadow-[0_0_0_4px_rgba(48,77,109,0.25)]" />
                <div class="absolute top-[calc(100%+6px)] left-[14px] h-[18px] leading-[18px] text-left">
                    <ValidationMessage For="@(() => _loginModel.Email)" />
                </div>
            </div>

            <div class="relative mt-[18px] mb-[30px]">
                <input type="@(isPasswordVisible ? "text" : "password")" @bind-value="_loginModel.Password" @bind-value:event="oninput" placeholder="Password" class="w-full h-[46px] px-[14px] pr-[52px] rounded-[10px] border-2 border-air-blue bg-white outline-none transition-[border-color,box-shadow] duration-200 text-[15px] focus:border-yinmn-blue focus:shadow-[0_0_0_4px_rgba(48,77,109,0.25)]" />
                <button type="button" class="absolute right-0 top-0 h-[46px] w-[46px] border-none bg-transparent cursor-pointer grid place-items-center" @onclick="TogglePasswordVisibility" aria-label="@(isPasswordVisible ? "Hide password" : "Show password")">
                    @if (isPasswordVisible)
                    {
                        <!-- eye-off icon -->
                        <svg class="w-5 h-5 stroke-white stroke-2 fill-none" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M3 3l18 18" stroke-linecap="round" stroke-linejoin="round"></path>
                            <path d="M10.6 10.6A3 3 0 0012 15a3 3 0 002.4-4.4M9.9 5.1A10.7 10.7 0 0112 5c6 0 9.5 5.5 9.5 7-.
                                     2.8-.9 1.7-1.6 2.4M4.1 6.5C2.9 7.8 2.5 9 2.5 12c0 1.5 3.5 7 9.5 7 1.3 0 2.6-.3 3.7-.8" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    }
                    else
                    {
                        <!-- eye icon -->
                        <svg class="w-5 h-5 stroke-white stroke-2 fill-none" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M1.5 12S5 5 12 5s10.5 7 10.5 7-3.5 7-10.5 7S1.5 12 1.5 12z" fill="none" stroke-linecap="round" stroke-linejoin="round"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    }
                </button>
                <div class="absolute top-[calc(100%+6px)] left-[14px] h-[18px] leading-[18px] text-left">
                    <ValidationMessage For="@(() => _loginModel.Password)" />
                </div>
            </div>

            <button type="submit" class="mx-auto block w-3/4 mt-6 h-10 rounded-xl border-none text-white font-bold tracking-wide bg-[#3C506A] shadow-[0_6px_16px_rgba(0,0,0,0.3)] cursor-pointer transition-[filter,transform] duration-150 hover:brightness-[1.1] active:translate-y-[1px]">LOGIN</button>
            @if (!string.IsNullOrEmpty(_loginError))
            {
                <div class="text-red-700 text-xs mt-2.5 text-center whitespace-nowrap overflow-hidden text-ellipsis font-medium">@_loginError</div>
            }
        </EditForm>
    </div>
</div>

@code {
    private readonly LoginModel _loginModel = new();
    private bool isPasswordVisible;
    private string? _loginError;

    private void TogglePasswordVisibility()
    {
        isPasswordVisible = !isPasswordVisible;
    }

    private async Task HandleLoginAsync()
    {
        _loginError = null;
        StateHasChanged();
        
        try
        {
            var user = await AuthService.AuthenticateAsync(_loginModel.Email, _loginModel.Password);
            if (user is null)
            {
                _loginError = "Invalid email or password.";
                StateHasChanged();
                return;
            }
            
            // Load subscription info for sellers and their staff (Cashier, Accounting, StockClerk)
            IT13_Final.Services.Auth.SubscriptionInfo? subscriptionInfo = null;
            int? sellerUserId = null;
            
            if (user.Role.Equals("seller", StringComparison.OrdinalIgnoreCase))
            {
                // Seller - load their own subscription
                sellerUserId = user.Id;
            }
            else if (user.Role.Equals("cashier", StringComparison.OrdinalIgnoreCase) ||
                     user.Role.Equals("accounting", StringComparison.OrdinalIgnoreCase) ||
                     user.Role.Equals("stockclerk", StringComparison.OrdinalIgnoreCase) ||
                     user.Role.Equals("stock clerk", StringComparison.OrdinalIgnoreCase))
            {
                // Staff - get their seller's user_id from tbl_users
                sellerUserId = await GetSellerUserIdAsync(user.Id);
            }
            
            // Load subscription for the seller (either direct or via staff relationship)
            if (sellerUserId.HasValue)
            {
                var subscription = await SubscriptionService.GetSellerSubscriptionAsync(sellerUserId.Value);
                if (subscription != null)
                {
                    subscriptionInfo = new IT13_Final.Services.Auth.SubscriptionInfo
                    {
                        SubscriptionId = subscription.Id,
                        PlanId = subscription.PlanId,
                        PlanName = subscription.PlanName,
                        PlanCode = subscription.PlanCode,
                        AdminFeePercentage = subscription.AdminFeePercentage,
                        HasStockClerkAccess = subscription.HasStockClerkAccess,
                        HasCashierAccess = subscription.HasCashierAccess,
                        HasAccountingAccess = subscription.HasAccountingAccess,
                        HasFullReportsAccess = subscription.HasFullReportsAccess,
                        StartDate = subscription.StartDate,
                        Status = subscription.Status
                    };
                }
            }
            
            AuthState.SetUserWithSubscription(user, subscriptionInfo);
            try { await HistoryService.LogAsync(user.Id, "login", "Authentication", "User signed in"); } catch {}
            
            // For sellers without subscription, redirect to subscription selection page
            if (user.Role.Equals("seller", StringComparison.OrdinalIgnoreCase) && subscriptionInfo == null)
            {
                Nav.NavigateTo("/seller/subscription");
                return;
            }
            
            // Block staff login if their seller doesn't have access to their module
            if (subscriptionInfo != null)
            {
                bool accessDenied = false;
                string deniedModule = "";
                
                if (user.Role.Equals("cashier", StringComparison.OrdinalIgnoreCase) && !subscriptionInfo.HasCashierAccess)
                {
                    accessDenied = true;
                    deniedModule = "Cashier";
                }
                else if (user.Role.Equals("accounting", StringComparison.OrdinalIgnoreCase) && !subscriptionInfo.HasAccountingAccess)
                {
                    accessDenied = true;
                    deniedModule = "Accounting";
                }
                else if ((user.Role.Equals("stockclerk", StringComparison.OrdinalIgnoreCase) || 
                          user.Role.Equals("stock clerk", StringComparison.OrdinalIgnoreCase)) && 
                         !subscriptionInfo.HasStockClerkAccess)
                {
                    accessDenied = true;
                    deniedModule = "Stock Clerk";
                }
                
                if (accessDenied)
                {
                    _loginError = $"Access denied. Your seller's subscription plan does not include {deniedModule} module access.";
                    AuthState.Logout();
                    StateHasChanged();
                    return;
                }
            }
            else if (user.Role.Equals("cashier", StringComparison.OrdinalIgnoreCase) ||
                     user.Role.Equals("accounting", StringComparison.OrdinalIgnoreCase) ||
                     user.Role.Equals("stockclerk", StringComparison.OrdinalIgnoreCase) ||
                     user.Role.Equals("stock clerk", StringComparison.OrdinalIgnoreCase))
            {
                // Staff without seller subscription - block access
                _loginError = "Access denied. Your seller does not have an active subscription.";
                AuthState.Logout();
                StateHasChanged();
                return;
            }
            
            // Navigate to /{role}/dashboard (e.g., /admin/dashboard, /seller/dashboard)
            Nav.NavigateTo($"/{user.Role}/dashboard");
        }
        catch (InvalidOperationException ex)
        {
            // Database connection errors
            _loginError = ex.Message;
            StateHasChanged();
        }
        catch (Microsoft.Data.SqlClient.SqlException sqlEx)
        {
            // SQL-specific errors
            if (sqlEx.Message.Contains("timeout", StringComparison.OrdinalIgnoreCase))
            {
                _loginError = "Database connection timeout. Please check if SQL Server is running and try again.";
            }
            else
            {
                _loginError = $"Database error: {sqlEx.Message}";
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Other unexpected errors
            _loginError = $"An error occurred during login: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task<int?> GetSellerUserIdAsync(int staffUserId)
    {
        try
        {
            const string connectionString = "Server=localhost\\SQLEXPRESS;Database=db_SoftWear;Trusted_Connection=True;TrustServerCertificate=True;";
            using var conn = new Microsoft.Data.SqlClient.SqlConnection(connectionString);
            await conn.OpenAsync();
            
            var sql = "SELECT user_id FROM dbo.tbl_users WHERE id = @UserId AND archived_at IS NULL";
            using var cmd = new Microsoft.Data.SqlClient.SqlCommand(sql, conn);
            cmd.Parameters.AddWithValue("@UserId", staffUserId);
            
            var result = await cmd.ExecuteScalarAsync();
            if (result != null && result != DBNull.Value)
            {
                return Convert.ToInt32(result);
            }
        }
        catch { }
        
        return null;
    }

    private sealed class LoginModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Password { get; set; } = string.Empty;
    }
}


