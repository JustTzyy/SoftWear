@inject IT13_Final.Services.Auth.AuthState AuthState
@inject IT13_Final.Services.Audit.IHistoryService HistoryService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inherits LayoutComponentBase
@implements IDisposable

<div class="grid min-h-screen transition-all duration-300 ease-in-out" style="grid-template-columns: @(sidebarCollapsed ? "80px" : "260px") 1fr; background: #e5e7eb;">
    <aside class="bg-white transition-all duration-300 ease-in-out overflow-hidden" style="border-right: 1px solid #E0E0E0; position: sticky; top: 0; height: 100vh;">
        <div class="flex items-start gap-3 py-4 px-4 cursor-pointer hover:bg-gray-50 transition-colors duration-200" style="min-height: 64px;" @onclick="ToggleSidebar">
            <a href="/seller/dashboard" class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5" style="border: 2px solid #5C7CFA; padding: 6px; background-color: #1a2332;" @onclick:stopPropagation>
                <img src="/images/logo.png" alt="Logo" class="w-full h-full object-contain" style="display: block; margin: auto;" />
            </a>
            <div class="transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">
                <div class="font-extrabold tracking-wide text-sm leading-tight">SOFTWEAR</div>
                <div class="text-gray-500 text-xs -mt-0.5">Seller</div>
            </div>
        </div>

        <nav class="grid gap-1 px-2 mt-1">
            <a class="@GetNavItemClass("/seller/dashboard")" href="/seller/dashboard" title="Dashboard">
                <svg class="w-5 h-5 flex-shrink-0 @GetIconClass("/seller/dashboard")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">Dashboard</span>
                @if (IsActive("/seller/dashboard"))
                {
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-yinmn-blue rounded-r"></div>
                }
            </a>

            <button class="@GetStaffMgmtButtonClass()" @onclick="ToggleStaffMgmt" aria-expanded="@staffMgmtOpen" title="Staff Management">
                <svg class="w-5 h-5 flex-shrink-0 @GetIconClass("/seller/Accounting_Record", "/seller/Cashier_Record", "/seller/Stock_Clerk_Record", "/seller/Permission_Requests")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <span class="flex-1 transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">Staff Management</span>
                <span class="@GetIconClass("/seller/Accounting_Record", "/seller/Cashier_Record", "/seller/Stock_Clerk_Record", "/seller/Permission_Requests") transition-all duration-300 ease-in-out" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">@(staffMgmtOpen ? "▾" : "▸")</span>
                @if (IsStaffMgmtActive())
                {
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-yinmn-blue rounded-r"></div>
                }
            </button>
            @if (staffMgmtOpen && !sidebarCollapsed)
            {
                <div class="grid gap-1 py-1 pl-4">
                    <a class="@GetSubNavItemClass("/seller/Accounting_Record")" href="/seller/Accounting_Record">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Accounting_Record")"></span>
                        <span>Accounting</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Cashier_Record")" href="/seller/Cashier_Record">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Cashier_Record")"></span>
                        <span>Cashier</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Stock_Clerk_Record")" href="/seller/Stock_Clerk_Record">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Stock_Clerk_Record")"></span>
                        <span>Stock Clerk</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Permission_Requests")" href="/seller/Permission_Requests">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Permission_Requests")"></span>
                        <span>Permission Requests</span>
                    </a>
                </div>
            }

            <button class="@GetProductMgmtButtonClass()" @onclick="ToggleProductMgmt" aria-expanded="@productMgmtOpen" title="Product Management">
                <svg class="w-5 h-5 flex-shrink-0 @GetIconClass("/seller/Color", "/seller/Size", "/seller/Product", "/seller/Variant")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                <span class="flex-1 transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">Product Management</span>
                <span class="@GetIconClass("/seller/Color", "/seller/Size", "/seller/Product", "/seller/Variant") transition-all duration-300 ease-in-out" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">@(productMgmtOpen ? "▾" : "▸")</span>
                @if (IsProductMgmtActive())
                {
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-yinmn-blue rounded-r"></div>
                }
            </button>
            @if (productMgmtOpen && !sidebarCollapsed)
            {
                <div class="grid gap-1 py-1 pl-4">
                    <a class="@GetSubNavItemClass("/seller/Category")" href="/seller/Category">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Category")"></span>
                        <span>Category</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Color")" href="/seller/Color">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Color")"></span>
                        <span>Color</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Product")" href="/seller/Product">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Product")"></span>
                        <span>Product</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Size")" href="/seller/Size">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Size")"></span>
                        <span>Size</span>
                    </a>
                    <a class="@GetSubNavItemClass("/seller/Variant")" href="/seller/Variant">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Variant")"></span>
                        <span>Variant</span>
                    </a>
                </div>
            }

            <button class="@GetSupplierMgmtButtonClass()" @onclick="ToggleSupplierMgmt" aria-expanded="@supplierMgmtOpen" title="Supplier Management">
                <svg class="w-5 h-5 flex-shrink-0 @GetIconClass("/seller/Supplier")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span class="flex-1 transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">Supplier Management</span>
                <span class="@GetIconClass("/seller/Supplier") transition-all duration-300 ease-in-out" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">@(supplierMgmtOpen ? "▾" : "▸")</span>
                @if (IsSupplierMgmtActive())
                {
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-yinmn-blue rounded-r"></div>
                }
            </button>
            @if (supplierMgmtOpen && !sidebarCollapsed)
            {
                <div class="grid gap-1 py-1 pl-4">
                    <a class="@GetSubNavItemClass("/seller/Supplier")" href="/seller/Supplier">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/Supplier")"></span>
                        <span>Supplier</span>
                    </a>
                </div>
            }

            <button class="@GetReportsButtonClass()" @onclick="ToggleReports" aria-expanded="@reportsOpen" title="Reports">
                <svg class="w-5 h-5 flex-shrink-0 @GetIconClass("/seller/AuditLogs", "/seller/CashierSalesReports", "/seller/CashierReturnsReports", "/seller/StockClerkStockInReports", "/seller/StockClerkStockOutReports", "/seller/StockClerkStockAdjustmentReports", "/seller/StockClerkSupplierReports", "/seller/StockClerkPurchaseOrderReports", "/seller/AccountingFinancialReports", "/seller/AccountingExpenseReports", "/seller/AccountingTaxReports", "/seller/AccountingDailySalesVerificationReports", "/seller/AccountingProfitLossReports", "/seller/AccountingCashInOutAudit", "/seller/AccountingIncomeBreakdown")" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="flex-1 transition-all duration-300 ease-in-out overflow-hidden whitespace-nowrap" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">Reports</span>
                <span class="@GetIconClass("/seller/AuditLogs", "/seller/CashierSalesReports", "/seller/CashierReturnsReports", "/seller/StockClerkStockInReports", "/seller/StockClerkStockOutReports", "/seller/StockClerkStockAdjustmentReports", "/seller/StockClerkSupplierReports", "/seller/StockClerkPurchaseOrderReports", "/seller/AccountingFinancialReports", "/seller/AccountingExpenseReports", "/seller/AccountingTaxReports", "/seller/AccountingDailySalesVerificationReports", "/seller/AccountingProfitLossReports", "/seller/AccountingCashInOutAudit", "/seller/AccountingIncomeBreakdown") transition-all duration-300 ease-in-out" style="opacity: @(sidebarCollapsed ? "0" : "1"); width: @(sidebarCollapsed ? "0" : "auto");">@(reportsOpen ? "▾" : "▸")</span>
                @if (IsReportsActive())
                {
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-yinmn-blue rounded-r"></div>
                }
            </button>
            @if (reportsOpen && !sidebarCollapsed)
            {
                <div class="grid gap-1 py-1 pl-4">
                    <a class="@GetSubNavItemClass("/seller/AuditLogs")" href="/seller/AuditLogs">
                        <span class="w-2 h-2 rounded-full @GetSubNavDotClass("/seller/AuditLogs")"></span>
                        <span>Audit Logs</span>
                    </a>
                    <button class="@GetSubSubNavButtonClass("/seller/CashierSalesReports", "/seller/CashierReturnsReports")" @onclick="ToggleCashierReports" aria-expanded="@cashierReportsOpen">
                        <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/CashierSalesReports", "/seller/CashierReturnsReports") flex-shrink-0"></span>
                        <span class="flex-1 break-words">Cashier Reports</span>
                        <span class="flex-shrink-0">@(cashierReportsOpen ? "▾" : "▸")</span>
                    </button>
                    @if (cashierReportsOpen && !sidebarCollapsed)
                    {
                        <div class="grid gap-1 py-1 pl-6">
                            <a class="@GetSubSubNavItemClass("/seller/CashierSalesReports")" href="/seller/CashierSalesReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/CashierSalesReports") flex-shrink-0"></span>
                                <span class="break-words">Sales Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/CashierReturnsReports")" href="/seller/CashierReturnsReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/CashierReturnsReports") flex-shrink-0"></span>
                                <span class="break-words">Returns Reports</span>
                            </a>
                        </div>
                    }
                    <button class="@GetSubSubNavButtonClass("/seller/StockClerkStockInReports", "/seller/StockClerkStockOutReports", "/seller/StockClerkStockAdjustmentReports", "/seller/StockClerkPurchaseOrderReports")" @onclick="ToggleStockClerkReports" aria-expanded="@stockClerkReportsOpen">
                        <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/StockClerkStockInReports", "/seller/StockClerkStockOutReports", "/seller/StockClerkStockAdjustmentReports", "/seller/StockClerkPurchaseOrderReports") flex-shrink-0"></span>
                        <span class="flex-1 break-words">Stock Clerk Reports</span>
                        <span class="flex-shrink-0">@(stockClerkReportsOpen ? "▾" : "▸")</span>
                    </button>
                    @if (stockClerkReportsOpen && !sidebarCollapsed)
                    {
                        <div class="grid gap-1 py-1 pl-6">
                            <a class="@GetSubSubNavItemClass("/seller/StockClerkStockInReports")" href="/seller/StockClerkStockInReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/StockClerkStockInReports") flex-shrink-0"></span>
                                <span class="break-words">Stock In Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/StockClerkStockOutReports")" href="/seller/StockClerkStockOutReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/StockClerkStockOutReports") flex-shrink-0"></span>
                                <span class="break-words">Stock Out Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/StockClerkStockAdjustmentReports")" href="/seller/StockClerkStockAdjustmentReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/StockClerkStockAdjustmentReports") flex-shrink-0"></span>
                                <span class="break-words">Stock Adjustment Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/StockClerkPurchaseOrderReports")" href="/seller/StockClerkPurchaseOrderReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/StockClerkPurchaseOrderReports") flex-shrink-0"></span>
                                <span class="break-words">Purchase Order Reports</span>
                            </a>
                        </div>
                    }
                    <button class="@GetSubSubNavButtonClass("/seller/AccountingExpenseReports", "/seller/AccountingTaxReports", "/seller/AccountingDailySalesVerificationReports", "/seller/AccountingProfitLossReports", "/seller/AccountingCashInOutAudit", "/seller/AccountingIncomeBreakdown")" @onclick="ToggleAccountingReports" aria-expanded="@accountingReportsOpen">
                        <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingExpenseReports", "/seller/AccountingTaxReports", "/seller/AccountingDailySalesVerificationReports", "/seller/AccountingProfitLossReports", "/seller/AccountingCashInOutAudit", "/seller/AccountingIncomeBreakdown") flex-shrink-0"></span>
                        <span class="flex-1 break-words">Accounting Reports</span>
                        <span class="flex-shrink-0">@(accountingReportsOpen ? "▾" : "▸")</span>
                    </button>
                    @if (accountingReportsOpen && !sidebarCollapsed)
                    {
                        <div class="grid gap-1 py-1 pl-6">
                            <a class="@GetSubSubNavItemClass("/seller/AccountingExpenseReports")" href="/seller/AccountingExpenseReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingExpenseReports") flex-shrink-0"></span>
                                <span class="break-words">Expense Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/AccountingTaxReports")" href="/seller/AccountingTaxReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingTaxReports") flex-shrink-0"></span>
                                <span class="break-words">Tax Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/AccountingDailySalesVerificationReports")" href="/seller/AccountingDailySalesVerificationReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingDailySalesVerificationReports") flex-shrink-0"></span>
                                <span class="break-words">Daily Sales Verification Reports</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/AccountingProfitLossReports")" href="/seller/AccountingProfitLossReports">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingProfitLossReports") flex-shrink-0"></span>
                                <span class="break-words">Profit & Loss Statements</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/AccountingCashInOutAudit")" href="/seller/AccountingCashInOutAudit">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingCashInOutAudit") flex-shrink-0"></span>
                                <span class="break-words">Cash In/Cash Out Audit</span>
                            </a>
                            <a class="@GetSubSubNavItemClass("/seller/AccountingIncomeBreakdown")" href="/seller/AccountingIncomeBreakdown">
                                <span class="w-2 h-2 rounded-full @GetSubSubNavDotClass("/seller/AccountingIncomeBreakdown") flex-shrink-0"></span>
                                <span class="break-words">Income Breakdown</span>
                            </a>
                        </div>
                    }
                </div>
            }
        </nav>
    </aside>

    <div class="grid grid-rows-[64px_1fr]">
        <header class="flex items-center gap-3 px-5 bg-white" style="border-bottom: 1px solid #E0E0E0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 100;">
            <div class="flex-1"></div>
            <div class="relative flex items-center gap-2.5" @onclick="ToggleProfileMenu">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-uranian-blue to-white text-yinmn-blue flex items-center justify-center font-extrabold">@GetInitials()</div>
                <button class="flex items-center gap-2 py-1.5 px-2.5 rounded-[10px] bg-white cursor-pointer text-gray-700 transition-all duration-200 ease-in-out hover:shadow-[0_2px_8px_rgba(0,0,0,0.06)]" style="border: 1px solid #E0E0E0;">
                    <span class="text-sm">@DisplayName()</span>
                    <span class="text-yinmn-blue text-xs">▾</span>
                </button>
                @if (profileOpen)
                {
                    <div class="absolute top-14 right-0 bg-white rounded-xl shadow-[0_12px_28px_rgba(0,0,0,0.12)] p-2 w-60 z-10" style="border: 1px solid #E0E0E0;" @onclick:stopPropagation>
                        <a class="grid grid-cols-[22px_1fr] items-center gap-2.5 py-2.5 px-3 no-underline text-gray-800 rounded-[10px] border-none bg-transparent w-full text-left transition-all duration-200 ease-in-out hover:bg-platinum" href="/seller/settings" @onclick="CloseProfileMenu">
                            <svg class="w-[18px] h-[18px] stroke-yinmn-blue stroke-2 fill-none" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9" fill="none"/><path d="M12 8v8M8 12h8"/></svg>
                            <span>Settings</span>
                        </a>
                        <a class="grid grid-cols-[22px_1fr] items-center gap-2.5 py-2.5 px-3 no-underline text-gray-800 rounded-[10px] border-none bg-transparent w-full text-left transition-all duration-200 ease-in-out hover:bg-platinum" href="/seller/activitylog" @onclick="CloseProfileMenu">
                            <svg class="w-[18px] h-[18px] stroke-yinmn-blue stroke-2 fill-none" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3v18M5 12h14"/></svg>
                            <span>My Activity Log</span>
                        </a>
                        <button class="grid grid-cols-[22px_1fr] items-center gap-2.5 py-2.5 px-3 no-underline text-gray-800 rounded-[10px] border-none bg-transparent w-full text-left transition-all duration-200 ease-in-out hover:bg-platinum" @onclick="OnSignOut">
                            <svg class="w-[18px] h-[18px] stroke-yinmn-blue stroke-2 fill-none" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 7l5 5-5 5"/><path d="M4 12h11"/></svg>
                            <span>Signout</span>
                        </button>
                    </div>
                }
            </div>
        </header>

        <main class="p-6">
            @Body
        </main>
    </div>
</div>


@code {
    private bool staffMgmtOpen = false;
    private bool productMgmtOpen = false;
    private bool supplierMgmtOpen = false;
    private bool reportsOpen = false;
    private bool cashierReportsOpen = false;
    private bool stockClerkReportsOpen = false;
    private bool accountingReportsOpen = false;
    private bool profileOpen;
    private bool sidebarCollapsed = false;
    private string currentUri = string.Empty;

    // Accordion behavior: close other dropdowns when one is opened
    private void CloseAllDropdowns()
    {
        staffMgmtOpen = false;
        productMgmtOpen = false;
        supplierMgmtOpen = false;
        reportsOpen = false;
        cashierReportsOpen = false;
        stockClerkReportsOpen = false;
        accountingReportsOpen = false;
    }

    private void ToggleStaffMgmt()
    {
        bool wasOpen = staffMgmtOpen;
        CloseAllDropdowns();
        staffMgmtOpen = !wasOpen;
    }

    private void ToggleProductMgmt()
    {
        bool wasOpen = productMgmtOpen;
        CloseAllDropdowns();
        productMgmtOpen = !wasOpen;
    }

    private void ToggleSupplierMgmt()
    {
        bool wasOpen = supplierMgmtOpen;
        CloseAllDropdowns();
        supplierMgmtOpen = !wasOpen;
    }

    private void ToggleReports()
    {
        bool wasOpen = reportsOpen;
        CloseAllDropdowns();
        reportsOpen = !wasOpen;
    }

    private void ToggleCashierReports()
    {
        cashierReportsOpen = !cashierReportsOpen;
        // Close other sub-dropdowns within Reports, but keep Reports open
        if (cashierReportsOpen)
        {
            stockClerkReportsOpen = false;
            accountingReportsOpen = false;
        }
    }

    private void ToggleStockClerkReports()
    {
        stockClerkReportsOpen = !stockClerkReportsOpen;
        // Close other sub-dropdowns within Reports, but keep Reports open
        if (stockClerkReportsOpen)
        {
            cashierReportsOpen = false;
            accountingReportsOpen = false;
        }
    }

    private void ToggleAccountingReports()
    {
        accountingReportsOpen = !accountingReportsOpen;
        // Close other sub-dropdowns within Reports, but keep Reports open
        if (accountingReportsOpen)
        {
            cashierReportsOpen = false;
            stockClerkReportsOpen = false;
        }
    }

    protected override void OnInitialized()
    {
        currentUri = Nav.Uri;
        CheckStaffMgmtExpansion();
        CheckProductMgmtExpansion();
        CheckSupplierMgmtExpansion();
        CheckReportsExpansion();
        Nav.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        currentUri = e.Location;
        CheckStaffMgmtExpansion();
        CheckProductMgmtExpansion();
        CheckSupplierMgmtExpansion();
        CheckReportsExpansion();
        InvokeAsync(StateHasChanged);
    }

    private void CheckStaffMgmtExpansion()
    {
        if (IsActive("/seller/Accounting_Record") || IsActive("/seller/Cashier_Record") || IsActive("/seller/Stock_Clerk_Record") || IsActive("/seller/Permission_Requests"))
        {
            staffMgmtOpen = true;
        }
    }

    private void CheckProductMgmtExpansion()
    {
        if (IsActive("/seller/Category") || IsActive("/seller/Color") || IsActive("/seller/Size") || IsActive("/seller/Product") || IsActive("/seller/Variant"))
        {
            productMgmtOpen = true;
        }
    }

    private void CheckSupplierMgmtExpansion()
    {
        if (IsActive("/seller/Supplier"))
        {
            supplierMgmtOpen = true;
        }
    }

    private void CheckReportsExpansion()
    {
        if (IsActive("/seller/AuditLogs") || 
            IsActive("/seller/CashierSalesReports") || IsActive("/seller/CashierReturnsReports") ||
            IsActive("/seller/StockClerkStockInReports") || IsActive("/seller/StockClerkStockOutReports") || 
            IsActive("/seller/StockClerkStockAdjustmentReports") || IsActive("/seller/StockClerkPurchaseOrderReports") ||
            IsActive("/seller/AccountingExpenseReports") || 
            IsActive("/seller/AccountingTaxReports") || IsActive("/seller/AccountingDailySalesVerificationReports") || 
            IsActive("/seller/AccountingProfitLossReports") || IsActive("/seller/AccountingCashInOutAudit") || 
            IsActive("/seller/AccountingIncomeBreakdown"))
        {
            reportsOpen = true;
        }
        
        if (IsActive("/seller/CashierSalesReports") || IsActive("/seller/CashierReturnsReports"))
        {
            cashierReportsOpen = true;
        }
        
        if (IsActive("/seller/StockClerkStockInReports") || IsActive("/seller/StockClerkStockOutReports") || 
            IsActive("/seller/StockClerkStockAdjustmentReports") || IsActive("/seller/StockClerkPurchaseOrderReports"))
        {
            stockClerkReportsOpen = true;
        }
        
        if (IsActive("/seller/AccountingExpenseReports") || 
            IsActive("/seller/AccountingTaxReports") || IsActive("/seller/AccountingDailySalesVerificationReports") || 
            IsActive("/seller/AccountingProfitLossReports") || IsActive("/seller/AccountingCashInOutAudit") || 
            IsActive("/seller/AccountingIncomeBreakdown"))
        {
            accountingReportsOpen = true;
        }
    }

    private bool IsActive(string path)
    {
        if (string.IsNullOrEmpty(currentUri)) return false;
        
        try
        {
            var uri = Nav.ToAbsoluteUri(currentUri);
            var currentPath = uri.AbsolutePath.ToLowerInvariant().TrimEnd('/');
            var checkPath = path.ToLowerInvariant().TrimEnd('/');
            
            // Exact match
            if (currentPath == checkPath) return true;
            
            // Check if current path starts with the check path (for sub-routes)
            if (currentPath.StartsWith(checkPath + "/", StringComparison.OrdinalIgnoreCase)) return true;
            
            return false;
        }
        catch
        {
            return false;
        }
    }

    private string GetNavItemClass(string path)
    {
        var baseClass = "relative py-2.5 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out whitespace-nowrap";
        if (IsActive(path))
        {
            return $"{baseClass} bg-uranian-blue text-yinmn-blue";
        }
        return $"{baseClass} text-gray-800 hover:bg-uranian-blue hover:bg-opacity-30";
    }

    private bool IsStaffMgmtActive()
    {
        return IsActive("/seller/Accounting_Record") || IsActive("/seller/Cashier_Record") || IsActive("/seller/Stock_Clerk_Record") || IsActive("/seller/Permission_Requests");
    }

    private string GetStaffMgmtButtonClass()
    {
        var baseClass = "relative w-full text-left cursor-pointer py-2.5 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out";
        
        if (IsStaffMgmtActive())
        {
            return $"{baseClass} bg-uranian-blue text-yinmn-blue";
        }
        return $"{baseClass} bg-transparent text-gray-800 hover:bg-uranian-blue hover:bg-opacity-30";
    }

    private bool IsProductMgmtActive()
    {
        return IsActive("/seller/Category") || IsActive("/seller/Color") || IsActive("/seller/Size") || IsActive("/seller/Product") || IsActive("/seller/Variant");
    }

    private bool IsSupplierMgmtActive()
    {
        return IsActive("/seller/Supplier");
    }

    private bool IsReportsActive()
    {
        return IsActive("/seller/AuditLogs") || 
               IsActive("/seller/CashierSalesReports") || IsActive("/seller/CashierReturnsReports") ||
               IsActive("/seller/StockClerkStockInReports") || IsActive("/seller/StockClerkStockOutReports") || 
               IsActive("/seller/StockClerkStockAdjustmentReports") || IsActive("/seller/StockClerkPurchaseOrderReports") ||
               IsActive("/seller/AccountingExpenseReports") || 
               IsActive("/seller/AccountingTaxReports") || IsActive("/seller/AccountingDailySalesVerificationReports") || 
               IsActive("/seller/AccountingProfitLossReports") || IsActive("/seller/AccountingCashInOutAudit") || 
               IsActive("/seller/AccountingIncomeBreakdown");
    }

    private string GetSupplierMgmtButtonClass()
    {
        var baseClass = "relative w-full text-left cursor-pointer py-2.5 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out";
        
        if (IsSupplierMgmtActive())
        {
            return $"{baseClass} bg-uranian-blue text-yinmn-blue";
        }
        return $"{baseClass} bg-transparent text-gray-800 hover:bg-uranian-blue hover:bg-opacity-30";
    }

    private string GetProductMgmtButtonClass()
    {
        var baseClass = "relative w-full text-left cursor-pointer py-2.5 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out";
        
        if (IsProductMgmtActive())
        {
            return $"{baseClass} bg-uranian-blue text-yinmn-blue";
        }
        return $"{baseClass} bg-transparent text-gray-800 hover:bg-uranian-blue hover:bg-opacity-30";
    }

    private string GetReportsButtonClass()
    {
        var baseClass = "relative w-full text-left cursor-pointer py-2.5 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out";
        
        if (IsReportsActive())
        {
            return $"{baseClass} bg-uranian-blue text-yinmn-blue";
        }
        return $"{baseClass} bg-transparent text-gray-800 hover:bg-uranian-blue hover:bg-opacity-30";
    }

    private string GetSubNavItemClass(string path)
    {
        var baseClass = "py-2 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out whitespace-nowrap";
        if (IsActive(path))
        {
            return $"{baseClass} bg-uranian-blue bg-opacity-30 text-yinmn-blue font-medium";
        }
        return $"{baseClass} text-gray-700 hover:bg-platinum";
    }

    private string GetSubNavDotClass(string path)
    {
        if (IsActive(path))
        {
            return "bg-yinmn-blue";
        }
        return "bg-gray-400";
    }

    private string GetSubSubNavButtonClass(params string[] paths)
    {
        var baseClass = "w-full text-left cursor-pointer py-2 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out";
        foreach (var path in paths)
        {
            if (IsActive(path))
            {
                return $"{baseClass} bg-uranian-blue bg-opacity-30 text-yinmn-blue font-medium";
            }
        }
        return $"{baseClass} text-gray-700 hover:bg-platinum";
    }

    private string GetSubSubNavItemClass(string path)
    {
        var baseClass = "py-2 px-3 rounded-lg no-underline flex items-center gap-3 transition-all duration-200 ease-in-out min-w-0";
        if (IsActive(path))
        {
            return $"{baseClass} bg-uranian-blue bg-opacity-30 text-yinmn-blue font-medium";
        }
        return $"{baseClass} text-gray-700 hover:bg-platinum";
    }

    private string GetSubSubNavDotClass(params string[] paths)
    {
        foreach (var path in paths)
        {
            if (IsActive(path))
            {
                return "bg-yinmn-blue";
            }
        }
        return "bg-gray-400";
    }

    private string GetIconClass(params string[] paths)
    {
        foreach (var path in paths)
        {
            if (IsActive(path))
            {
                return "text-yinmn-blue";
            }
        }
        return "text-gray-600";
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
        if (sidebarCollapsed)
        {
            staffMgmtOpen = false;
            productMgmtOpen = false;
            supplierMgmtOpen = false;
            reportsOpen = false;
            cashierReportsOpen = false;
            stockClerkReportsOpen = false;
            accountingReportsOpen = false;
        }
        else
        {
            CheckStaffMgmtExpansion();
            CheckProductMgmtExpansion();
            CheckSupplierMgmtExpansion();
            CheckReportsExpansion();
        }
    }

    private void ToggleProfileMenu()
    {
        profileOpen = !profileOpen;
    }

    private void CloseProfileMenu()
    {
        profileOpen = false;
    }

    private string DisplayName()
    {
        return AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Email ?? "User";
    }

    private string GetInitials()
    {
        var name = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Email ?? "U";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return (parts[0][0].ToString() + parts[1][0]).ToUpperInvariant();
        return name[0].ToString().ToUpperInvariant();
    }

    private string GetPageTitle()
    {
        if (string.IsNullOrEmpty(currentUri)) return $"Welcome, {AuthState.CurrentUser?.FullName ?? "Seller"}!";
        
        try
        {
            var uri = Nav.ToAbsoluteUri(currentUri);
            var path = uri.AbsolutePath.ToLowerInvariant().TrimEnd('/');
            
            // Map routes to page titles
            if (path == "/seller/dashboard") return $"Welcome, {AuthState.CurrentUser?.FullName ?? "Seller"}!";
            if (path == "/seller/accounting_record") return "Accounting Records";
            if (path == "/seller/cashier_record") return "Cashier Records";
            if (path == "/seller/stock_clerk_record") return "Stock Clerk Records";
            if (path == "/seller/permission_requests") return "Permission Requests";
            if (path == "/seller/category") return "Category Records";
            if (path == "/seller/color") return "Color Records";
            if (path == "/seller/product") return "Product Records";
            if (path == "/seller/size") return "Size Records";
            if (path == "/seller/variant") return "Variant Records";
            if (path == "/seller/supplier") return "Supplier Records";
            if (path == "/seller/auditlogs") return "Audit Logs";
            if (path == "/seller/cashiersalesreports") return "Cashier Sales Reports";
            if (path == "/seller/cashierreturnsreports") return "Cashier Returns Reports";
            if (path == "/seller/stockclerkstockinreports") return "Stock Clerk Stock In Reports";
            if (path == "/seller/stockclerkstockoutreports") return "Stock Clerk Stock Out Reports";
            if (path == "/seller/stockclerkstockadjustmentreports") return "Stock Clerk Stock Adjustment Reports";
            if (path == "/seller/stockclerkpurchaseorderreports") return "Stock Clerk Purchase Order Reports";
            if (path == "/seller/accountingfinancialreports") return "Accounting Financial Reports";
            if (path == "/seller/accountingexpensereports") return "Accounting Expense Reports";
            if (path == "/seller/accountingtaxreports") return "Accounting Tax Reports";
            if (path == "/seller/accountingdailysalesverificationreports") return "Accounting Daily Sales Verification Reports";
            if (path == "/seller/accountingprofitlossreports") return "Accounting Profit & Loss Reports";
            if (path == "/seller/accountingcashinoutaudit") return "Accounting Cash In/Cash Out Audit";
            if (path == "/seller/accountingincomebreakdown") return "Accounting Income Breakdown";
            if (path == "/seller/archive_accounting_record") return "Archived Accounting Records";
            if (path == "/seller/archive_cashier_record") return "Archived Cashier Records";
            if (path == "/seller/archive_stock_clerk_record") return "Archived Stock Clerk Records";
            if (path == "/seller/archive_supplier_record") return "Archived Supplier Records";
            if (path == "/seller/archive_category_record") return "Archived Categories";
            if (path == "/seller/archive_color_record") return "Archived Colors";
            if (path == "/seller/archive_product_record") return "Archived Products";
            if (path == "/seller/archive_size_record") return "Archived Sizes";
            if (path == "/seller/archive_variant_record") return "Archived Variants";
            if (path == "/seller/settings") return "Settings";
            if (path == "/seller/activitylog") return "My Activity Logs";
            
            return "Dashboard";
        }
        catch
        {
            return "Dashboard";
        }
    }

    private async void OnSignOut()
    {
        // Confirm before logging out
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirmLogout");
        if (!confirmed) return;

        if (AuthState.CurrentUser is not null)
        {
            try { await HistoryService.LogAsync(AuthState.CurrentUser.Id, "logout", "Authentication", "User signed out"); } catch {}
        }
        AuthState.Logout();
        profileOpen = false;
        Nav.NavigateTo("/");
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }
}
